<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- saved from url=(0058)http://ruby.railstutorial.org/chapters/user-microposts#top -->
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Learn Web Development with the Ruby on Rails Tutorial | User Microposts</title>
    
<meta name="robots" content="all">
<meta name="MSSmartTagsPreventParsing" content="true">
<meta name="description" content="Ruby on Rails Tutorial: Learn Rails by Example by Michael Hartl">
<meta name="keywords" content="Learn Ruby Rails Tutorial web development Rails 3">
<meta name="author" content="Michael Hartl">
<meta property="og:title" content="Ruby on Rails Tutorial: Learn Rails by Example">
<meta property="og:site_name" content="Ruby on Rails Tutorial">
<meta property="og:image" content="http://railstutorial.org/images/layout/logo.png">
<meta property="og:url" content="http://railstutorial.org/">
<meta property="og:type" content="article">
<meta property="og:description" content="Ruby on Rails Tutorial: Learn Web Development with Rails by Michael Hartl teaches web development with Ruby on Rails. Rails Tutorial is fully up-to-date with Rails 3.0 and Rails 3.2.">
    <link href="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/polytexnic.css" media="screen" rel="stylesheet" type="text/css">
    <link href="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/pygments.css" media="screen" rel="stylesheet" type="text/css">

      <link href="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
      
    <link href="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/print.css" media="print" rel="stylesheet" type="text/css">
    <!--[if lte IE 7]><link href="/stylesheets/ie.css?1364087846" media="screen" rel="stylesheet" type="text/css" /><![endif]-->
    <!--[if lt IE 7]>  <div style='border: 1px solid #F7941D; background: #FEEFDA; text-align: center; clear: both; height: 75px; position: relative;'>    <div style='position: absolute; right: 3px; top: 3px; font-family: courier new; font-weight: bold;'><a href='#' onclick='javascript:this.parentNode.parentNode.style.display="none"; return false;'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-cornerx.jpg' style='border: none;' alt='Close this notice'/></a></div>    <div style='width: 640px; margin: 0 auto; text-align: left; padding: 0; overflow: hidden; color: black;'>      <div style='width: 75px; float: left;'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-warning.jpg' alt='Warning!'/></div>      <div style='width: 275px; float: left; font-family: Arial, sans-serif;'>        <div style='font-size: 14px; font-weight: bold; margin-top: 12px;'>You are using an outdated browser</div>        <div style='font-size: 12px; margin-top: 6px; line-height: 12px;'>For a better experience using this site, please upgrade to a modern web browser.</div>      </div>      <div style='width: 75px; float: left;'><a href='http://www.firefox.com' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-firefox.jpg' style='border: none;' alt='Get Firefox 3.5'/></a></div>      <div style='width: 75px; float: left;'><a href='http://www.browserforthebetter.com/download.html' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-ie8.jpg' style='border: none;' alt='Get Internet Explorer 8'/></a></div>      <div style='width: 73px; float: left;'><a href='http://www.apple.com/safari/download/' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-safari.jpg' style='border: none;' alt='Get Safari 4'/></a></div>      <div style='float: left;'><a href='http://www.google.com/chrome' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-chrome.jpg' style='border: none;' alt='Get Google Chrome'/></a></div>    </div>  </div>  <![endif]-->
    <link href="http://feeds.feedburner.com/railstutorial" rel="alternate" title="Rails Tutorial News" type="application/rss+xml">

    
    <script src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/widgets.js" charset="utf-8"></script>    
    
  <!--<base href="http://ruby.railstutorial.org/chapters/user-microposts">--><base href=".">
  <script type="text/javascript" src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/MathJax.js">
  MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$','$'],["\\(","\\)"]]},
    processEscapes: true,
    "HTML-CSS": {
      availableFonts: ["TeX"]
    }
  });
</script>    


  <style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Hover_Arrow {position: absolute; width: 15px; height: 11px; cursor: pointer}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuTitle {background-color: #CCCCCC; margin: -5px 0 0 0; text-align: center; font-style: italic; font-size: 80%; color: #444444; padding: 2px 0; overflow: hidden}
.MathJax_MenuArrow {position: absolute; right: .5em; color: #666666}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_Menu_Close {position: absolute; width: 31px; height: 31px; top: -15px; left: -15px}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.fb_hidden{position:absolute;top:-10000px;z-index:10001}
.fb_invisible{display:none}
.fb_reset{background:none;border-spacing:0;border:0;color:#000;cursor:auto;direction:ltr;font-family:"lucida grande", tahoma, verdana, arial, sans-serif;font-size:11px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:1;margin:0;overflow:visible;padding:0;text-align:left;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;visibility:visible;white-space:normal;word-spacing:normal}
.fb_link img{border:none}
.fb_dialog{background:rgba(82, 82, 82, .7);position:absolute;top:-10000px;z-index:10001}
.fb_dialog_advanced{padding:10px;-moz-border-radius:8px;-webkit-border-radius:8px;border-radius:8px}
.fb_dialog_content{background:#fff;color:#333}
.fb_dialog_close_icon{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 0 transparent;_background-image:url(http://static.ak.fbcdn.net/rsrc.php/v2/yL/r/s816eWC-2sl.gif);cursor:pointer;display:block;height:15px;position:absolute;right:18px;top:17px;width:15px;top:8px\9;right:7px\9}
.fb_dialog_mobile .fb_dialog_close_icon{top:5px;left:5px;right:auto}
.fb_dialog_padding{background-color:transparent;position:absolute;width:1px;z-index:-1}
.fb_dialog_close_icon:hover{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -15px transparent;_background-image:url(http://static.ak.fbcdn.net/rsrc.php/v2/yL/r/s816eWC-2sl.gif)}
.fb_dialog_close_icon:active{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -30px transparent;_background-image:url(http://static.ak.fbcdn.net/rsrc.php/v2/yL/r/s816eWC-2sl.gif)}
.fb_dialog_loader{background-color:#f2f2f2;border:1px solid #606060;font-size:24px;padding:20px}
.fb_dialog_top_left,
.fb_dialog_top_right,
.fb_dialog_bottom_left,
.fb_dialog_bottom_right{height:10px;width:10px;overflow:hidden;position:absolute}
/* @noflip */
.fb_dialog_top_left{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 0;left:-10px;top:-10px}
/* @noflip */
.fb_dialog_top_right{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 -10px;right:-10px;top:-10px}
/* @noflip */
.fb_dialog_bottom_left{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 -20px;bottom:-10px;left:-10px}
/* @noflip */
.fb_dialog_bottom_right{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 -30px;right:-10px;bottom:-10px}
.fb_dialog_vert_left,
.fb_dialog_vert_right,
.fb_dialog_horiz_top,
.fb_dialog_horiz_bottom{position:absolute;background:#525252;filter:alpha(opacity=70);opacity:.7}
.fb_dialog_vert_left,
.fb_dialog_vert_right{width:10px;height:100%}
.fb_dialog_vert_left{margin-left:-10px}
.fb_dialog_vert_right{right:0;margin-right:-10px}
.fb_dialog_horiz_top,
.fb_dialog_horiz_bottom{width:100%;height:10px}
.fb_dialog_horiz_top{margin-top:-10px}
.fb_dialog_horiz_bottom{bottom:0;margin-bottom:-10px}
.fb_dialog_iframe{line-height:0}
.fb_dialog_content .dialog_title{background:#6d84b4;border:1px solid #3b5998;color:#fff;font-size:14px;font-weight:bold;margin:0}
.fb_dialog_content .dialog_title > span{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/yd/r/Cou7n-nqK52.gif)
no-repeat 5px 50%;float:left;padding:5px 0 7px 26px}
body.fb_hidden{-webkit-transform:none;height:100%;margin:0;left:-10000px;overflow:visible;position:absolute;top:-10000px;width:100%
}
.fb_dialog.fb_dialog_mobile.loading{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/ya/r/3rhSv5V8j3o.gif)
white no-repeat 50% 50%;min-height:100%;min-width:100%;overflow:hidden;position:absolute;top:0;z-index:10001}
.fb_dialog.fb_dialog_mobile.loading.centered{max-height:590px;min-height:590px;max-width:500px;min-width:500px}
#fb-root #fb_dialog_ipad_overlay{background:rgba(0, 0, 0, .45);position:absolute;left:0;top:0;width:100%;min-height:100%;z-index:10000}
#fb-root #fb_dialog_ipad_overlay.hidden{display:none}
.fb_dialog.fb_dialog_mobile.loading iframe{visibility:hidden}
.fb_dialog_content .dialog_header{-webkit-box-shadow:white 0 1px 1px -1px inset;background:-webkit-gradient(linear, 0 0, 0 100%, from(#738ABA), to(#2C4987));border-bottom:1px solid;border-color:#1d4088;color:#fff;font:14px Helvetica, sans-serif;font-weight:bold;text-overflow:ellipsis;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0;vertical-align:middle;white-space:nowrap}
.fb_dialog_content .dialog_header table{-webkit-font-smoothing:subpixel-antialiased;height:43px;width:100%
}
.fb_dialog_content .dialog_header td.header_left{font-size:12px;padding-left:5px;vertical-align:middle;width:60px
}
.fb_dialog_content .dialog_header td.header_right{font-size:12px;padding-right:5px;vertical-align:middle;width:60px
}
.fb_dialog_content .touchable_button{background:-webkit-gradient(linear, 0 0, 0 100%, from(#4966A6),
color-stop(0.5, #355492), to(#2A4887));border:1px solid #29447e;-webkit-background-clip:padding-box;-webkit-border-radius:3px;-webkit-box-shadow:rgba(0, 0, 0, .117188) 0 1px 1px inset,
rgba(255, 255, 255, .167969) 0 1px 0;display:inline-block;margin-top:3px;max-width:85px;line-height:18px;padding:4px 12px;position:relative}
.fb_dialog_content .dialog_header .touchable_button input{border:none;background:none;color:#fff;font:12px Helvetica, sans-serif;font-weight:bold;margin:2px -12px;padding:2px 6px 3px 6px;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0}
.fb_dialog_content .dialog_header .header_center{color:#fff;font-size:16px;font-weight:bold;line-height:18px;text-align:center;vertical-align:middle}
.fb_dialog_content .dialog_content{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/y9/r/jKEcVPZFk-2.gif) no-repeat 50% 50%;border:1px solid #555;border-bottom:0;border-top:0;height:150px}
.fb_dialog_content .dialog_footer{background:#f2f2f2;border:1px solid #555;border-top-color:#ccc;height:40px}
#fb_dialog_loader_close{float:left}
.fb_dialog.fb_dialog_mobile .fb_dialog_close_button{text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0}
.fb_dialog.fb_dialog_mobile .fb_dialog_close_icon{visibility:hidden}
.fb_iframe_widget{position:relative;display:-moz-inline-block;display:inline-block}
.fb_iframe_widget iframe{position:absolute}
.fb_iframe_widget_lift{z-index:1}
.fb_iframe_widget span{display:inline-block;position:relative;text-align:justify;vertical-align:text-bottom}
.fb_hide_iframes iframe{position:relative;left:-10000px}
.fb_iframe_widget_loader{position:relative;display:inline-block}
.fb_iframe_widget_fluid{display:inline}
.fb_iframe_widget_fluid span{width:100%}
.fb_iframe_widget_loader iframe{min-height:32px;z-index:2;zoom:1}
.fb_iframe_widget_loader .FB_Loader{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/y9/r/jKEcVPZFk-2.gif) no-repeat;height:32px;width:32px;margin-left:-16px;position:absolute;left:50%;z-index:4}
.fb_button_simple,
.fb_button_simple_rtl{background-image:url(http://static.ak.fbcdn.net/rsrc.php/v2/yH/r/eIpbnVKI9lR.png);background-repeat:no-repeat;cursor:pointer;outline:none;text-decoration:none}
.fb_button_simple_rtl{background-position:right 0}
.fb_button_simple .fb_button_text{margin:0 0 0 20px;padding-bottom:1px}
.fb_button_simple_rtl .fb_button_text{margin:0 10px 0 0}
a.fb_button_simple:hover .fb_button_text,
a.fb_button_simple_rtl:hover .fb_button_text,
.fb_button_simple:hover .fb_button_text,
.fb_button_simple_rtl:hover .fb_button_text{text-decoration:underline}
.fb_button,
.fb_button_rtl{background:#29447e url(http://static.ak.fbcdn.net/rsrc.php/v2/yL/r/FGFbc80dUKj.png);background-repeat:no-repeat;cursor:pointer;display:inline-block;padding:0 0 0 1px;text-decoration:none;outline:none}
.fb_button .fb_button_text,
.fb_button_rtl .fb_button_text{background:#5f78ab url(http://static.ak.fbcdn.net/rsrc.php/v2/yL/r/FGFbc80dUKj.png);border-top:solid 1px #879ac0;border-bottom:solid 1px #1a356e;color:#fff;display:block;font-family:"lucida grande",tahoma,verdana,arial,sans-serif;font-weight:bold;padding:2px 6px 3px 6px;margin:1px 1px 0 21px;text-shadow:none}
a.fb_button,
a.fb_button_rtl,
.fb_button,
.fb_button_rtl{text-decoration:none}
a.fb_button:active .fb_button_text,
a.fb_button_rtl:active .fb_button_text,
.fb_button:active .fb_button_text,
.fb_button_rtl:active .fb_button_text{border-bottom:solid 1px #29447e;border-top:solid 1px #45619d;background:#4f6aa3;text-shadow:none}
.fb_button_xlarge,
.fb_button_xlarge_rtl{background-position:left -60px;font-size:24px;line-height:30px}
.fb_button_xlarge .fb_button_text{padding:3px 8px 3px 12px;margin-left:38px}
a.fb_button_xlarge:active{background-position:left -99px}
.fb_button_xlarge_rtl{background-position:right -268px}
.fb_button_xlarge_rtl .fb_button_text{padding:3px 8px 3px 12px;margin-right:39px}
a.fb_button_xlarge_rtl:active{background-position:right -307px}
.fb_button_large,
.fb_button_large_rtl{background-position:left -138px;font-size:13px;line-height:16px}
.fb_button_large .fb_button_text{margin-left:24px;padding:2px 6px 4px 6px}
a.fb_button_large:active{background-position:left -163px}
.fb_button_large_rtl{background-position:right -346px}
.fb_button_large_rtl .fb_button_text{margin-right:25px}
a.fb_button_large_rtl:active{background-position:right -371px}
.fb_button_medium,
.fb_button_medium_rtl{background-position:left -188px;font-size:11px;line-height:14px}
a.fb_button_medium:active{background-position:left -210px}
.fb_button_medium_rtl{background-position:right -396px}
.fb_button_text_rtl,
.fb_button_medium_rtl .fb_button_text{padding:2px 6px 3px 6px;margin-right:22px}
a.fb_button_medium_rtl:active{background-position:right -418px}
.fb_button_small,
.fb_button_small_rtl{background-position:left -232px;font-size:10px;line-height:10px}
.fb_button_small .fb_button_text{padding:2px 6px 3px;margin-left:17px}
a.fb_button_small:active,
.fb_button_small:active{background-position:left -250px}
.fb_button_small_rtl{background-position:right -440px}
.fb_button_small_rtl .fb_button_text{padding:2px 6px;margin-right:18px}
a.fb_button_small_rtl:active{background-position:right -458px}
.fb_share_count_wrapper{position:relative;float:left}
.fb_share_count{background:#b0b9ec none repeat scroll 0 0;color:#333;font-family:"lucida grande", tahoma, verdana, arial, sans-serif;text-align:center}
.fb_share_count_inner{background:#e8ebf2;display:block}
.fb_share_count_right{margin-left:-1px;display:inline-block}
.fb_share_count_right .fb_share_count_inner{border-top:solid 1px #e8ebf2;border-bottom:solid 1px #b0b9ec;margin:1px 1px 0 1px;font-size:10px;line-height:10px;padding:2px 6px 3px;font-weight:bold}
.fb_share_count_top{display:block;letter-spacing:-1px;line-height:34px;margin-bottom:7px;font-size:22px;border:solid 1px #b0b9ec}
.fb_share_count_nub_top{border:none;display:block;position:absolute;left:7px;top:35px;margin:0;padding:0;width:6px;height:7px;background-repeat:no-repeat;background-image:url(http://static.ak.fbcdn.net/rsrc.php/v2/yU/r/bSOHtKbCGYI.png)}
.fb_share_count_nub_right{border:none;display:inline-block;padding:0;width:5px;height:10px;background-repeat:no-repeat;background-image:url(http://static.ak.fbcdn.net/rsrc.php/v2/yX/r/i_oIVTKMYsL.png);vertical-align:top;background-position:right 5px;z-index:10;left:2px;margin:0 2px 0 0;position:relative}
.fb_share_no_count{display:none}
.fb_share_size_Small .fb_share_count_right .fb_share_count_inner{font-size:10px}
.fb_share_size_Medium .fb_share_count_right .fb_share_count_inner{font-size:11px;padding:2px 6px 3px;letter-spacing:-1px;line-height:14px}
.fb_share_size_Large .fb_share_count_right .fb_share_count_inner{font-size:13px;line-height:16px;padding:2px 6px 4px;font-weight:normal;letter-spacing:-1px}
.fb_share_count_hidden .fb_share_count_nub_top,
.fb_share_count_hidden .fb_share_count_top,
.fb_share_count_hidden .fb_share_count_nub_right,
.fb_share_count_hidden .fb_share_count_right{visibility:hidden}
.fb_connect_bar_container div,
.fb_connect_bar_container span,
.fb_connect_bar_container a,
.fb_connect_bar_container img,
.fb_connect_bar_container strong{background:none;border-spacing:0;border:0;direction:ltr;font-style:normal;font-variant:normal;letter-spacing:normal;line-height:1;margin:0;overflow:visible;padding:0;text-align:left;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;visibility:visible;white-space:normal;word-spacing:normal;vertical-align:baseline}
.fb_connect_bar_container{position:fixed;left:0 !important;right:0 !important;height:42px !important;padding:0 25px !important;margin:0 !important;vertical-align:middle !important;border-bottom:1px solid #333 !important;background:#3b5998 !important;z-index:99999999 !important;overflow:hidden !important}
.fb_connect_bar_container_ie6{position:absolute;top:expression(document.compatMode=="CSS1Compat"? document.documentElement.scrollTop+"px":body.scrollTop+"px")}
.fb_connect_bar{position:relative;margin:auto;height:100%;width:100%;padding:6px 0 0 0 !important;background:none;color:#fff !important;font-family:"lucida grande", tahoma, verdana, arial, sans-serif !important;font-size:13px !important;font-style:normal !important;font-variant:normal !important;font-weight:normal !important;letter-spacing:normal !important;line-height:1 !important;text-decoration:none !important;text-indent:0 !important;text-shadow:none !important;text-transform:none !important;white-space:normal !important;word-spacing:normal !important}
.fb_connect_bar a:hover{color:#fff}
.fb_connect_bar .fb_profile img{height:30px;width:30px;vertical-align:middle;margin:0 6px 5px 0}
.fb_connect_bar div a,
.fb_connect_bar span,
.fb_connect_bar span a{color:#bac6da;font-size:11px;text-decoration:none}
.fb_connect_bar .fb_buttons{float:right;margin-top:7px}
.fb_edge_widget_with_comment{position:relative;*z-index:1000}
.fb_edge_widget_with_comment span.fb_edge_comment_widget{position:absolute}
.fb_edge_widget_with_comment span.fb_send_button_form_widget{z-index:1}
.fb_edge_widget_with_comment span.fb_send_button_form_widget .FB_Loader{left:0;top:1px;margin-top:6px;margin-left:0;background-position:50% 50%;background-color:#fff;height:150px;width:394px;border:1px #666 solid;border-bottom:2px solid #283e6c;z-index:1}
.fb_edge_widget_with_comment span.fb_send_button_form_widget.dark .FB_Loader{background-color:#000;border-bottom:2px solid #ccc}
.fb_edge_widget_with_comment span.fb_send_button_form_widget.siderender
.FB_Loader{margin-top:0}
.fbpluginrecommendationsbarleft,
.fbpluginrecommendationsbarright{position:fixed !important;bottom:0;z-index:999}
/* @noflip */
.fbpluginrecommendationsbarleft{left:10px}
/* @noflip */
.fbpluginrecommendationsbarright{right:10px}</style></head>
<body class="book" data-twttr-rendered="true"><div id="MathJax_Message" style="display: none;"></div> 

  <div id="container">
    <div id="header" class="clearfix"><div id="title">
  <div id="logo"><a href="http://ruby.railstutorial.org/"><img alt="Logo" src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/logo.png"></a></div>
  <h1 id="name">
    <a href="http://ruby.railstutorial.org/">Ruby on Rails Tutorial</a>
  </h1>
  <br>
  <h2 id="authors">
    <a href="http://ruby.railstutorial.org/#author">by Michael Hartl</a>
  </h2>
</div>
</div>
    <div id="menu"><div class="links">
  <div class="box">
    <span>
      <a href="http://ruby.railstutorial.org/">Home</a>
    </span>
    <span class="division">
      |
    </span>
    <span>
      <a href="http://ruby.railstutorial.org/ruby-on-rails-tutorial-book">Book</a>
    </span>
    <span class="division">
      |
    </span>
    <span>
      <a href="http://ruby.railstutorial.org/help">Help</a>
    </span>
    <span class="division">
      |
    </span>
    <span>
      <a href="http://ruby.railstutorial.org/contact">Contact</a>
    </span>
    <span class="division">
      |
    </span>
    <span>
      <a href="http://news.railstutorial.org/">News</a>
    </span>
    <span class="img">
      <a href="http://feeds.feedburner.com/railstutorial"><img alt="Feed-icon16x16" class="feed" src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/feed-icon16x16.png"></a>
    </span>
    <!-- %span.division -->
    <!-- 
    -->
    <!-- %span -->
    <!-- = link_to "By Email", email_url -->
    <!-- %span.img -->
    <!-- = link_to email_icon, email_url -->
    <span class="division">
      |
    </span>
    <span>
      <a href="http://twitter.com/railstutorial">Follow</a>
    </span>
    <span>
      <a href="http://twitter.com/railstutorial"><img alt="Twitter-small" src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/twitter-small.png"></a>
    </span>
  </div>
</div>
</div>     
      <div id="content">         
        <div id="sidebar">
  <div class="content">
      <!-- = link_to image_tag("icons/feed-icon32x32.png"), feed_url -->
    <!-- = link_to image_tag("icons/twitter.png"), twitter_url -->
    <!-- = link_to image_tag("icons/mail-icons/mail-icon-32x32.png"), email_url -->
    <div id="navtool">
      <table class="layout">
        <tbody><tr>
          <td colspan="2"><a href="http://ruby.railstutorial.org/chapters/user-microposts#book_menu"><img alt="Up A Level" src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/sb_button_up.png"></a></td>
        </tr>
        <tr>
          <td><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#top"><img alt="Previous Chapter" src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/sb_button_prev.png"></a></td>
          <td><a href="http://ruby.railstutorial.org/chapters/following-users#top"><img alt="Next Chapter" src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/sb_button_next.png"></a></td>
        </tr>
      </tbody></table>
      <a href="http://www.amazon.com/gp/product/0321832051/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=0321832051&linkCode=as2&tag=therubonraitu-20"><img alt="Ruby on Rails Tutorial: Learn Web Development with Rails" src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/sb_button_buy_print_edition_red.png"></a><img src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/ir" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;">
      <br>
      <a href="http://ruby.railstutorial.org/#buy"><img alt="Buy Screencasts" src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/sb_button_pdf_screencasts_red.png"></a>
      <center><a href="http://youtu.be/bOdn9EdUquo" target="_blank"><img alt="Screencasts_thumbnail_play" src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/screencasts_thumbnail_play.png"></a></center>
      <div class="connect">
        <table class="center">
          <tbody><tr>
            <td><a href="http://feeds.feedburner.com/railstutorial"><img alt="Feed-icon24x24" src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/feed-icon24x24.png" title="Get news updates via RSS"></a></td>
            <td><a href="http://feedburner.google.com/fb/a/mailverify?uri=railstutorial&loc=en_US"><img alt="Mail-icon-24x24" src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/mail-icon-24x24.png" title="Get news updates by email"></a></td>
            <td><a href="http://www.facebook.com/pages/Ruby-on-Rails-Tutorial/197151265072"><img alt="Facebook-icon24x24" src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/facebook-icon24x24.png" title="Become a fan on Facebook"></a></td>
            <td><a href="http://twitter.com/railstutorial"><img alt="Twitter-icon24x24" src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/twitter-icon24x24.png" title="Follow on Twitter"></a></td>
          </tr>
        </tbody></table>
      </div>
      <div class="section">
        <div class="switcher">
          <span class="title round">Rails 3.2</span>
          •
          <span class="switcher_link"><a href="http://ruby.railstutorial.org/book?version=4.0">Rails 4.0</a></span>
        </div>
        <div class="share"><fb:like href="http://railstutorial.org/" show_faces="false" layout="button_count" colorscheme="light" fb-xfbml-state="rendered" class="fb_edge_widget_with_comment fb_iframe_widget"><span style="height: 21px; width: 79px;"><iframe id="f393f49b8" name="f1d3808ea8" scrolling="no" style="border: none; overflow: hidden; height: 21px; width: 79px;" title="Like this content on Facebook." class="fb_ltr" src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/like.html"></iframe></span></fb:like></div>
      </div>
      <div class="section">
        <a href="http://ruby.railstutorial.org/book?version=4.0#top">
          Read the Rails 4.0 edition
        </a>
      </div>
    </div>
    <!-- .section -->
    <!-- Sidebar areas labeled with class "section", like this one, will be styled suitably for text. -->
    <!-- .section -->
    <!-- %a{ :href => '/affiliates' } -->
    <!-- Rails Tutorial Affiliate Program&mdash;50% commissions -->
  </div>
</div>
<!-- %h3 Get Involved -->
<!-- 
-->
<!-- .links -->
<!-- %p.subscribe -->
<!-- %span= link_to(image_tag('feed-icon32x32.png'), feed_url) -->
<!-- = link_to("Subscribe", feed_url) -->
<!-- %p.follow -->
<!-- = link_to(image_tag('twitter.png'), twitter_url) -->
<!-- = link_to("Follow", twitter_url) -->
<!-- 
-->

                      
        <div id="main" class="withsidebar">
          


<div id="book_menu">
  <a href="http://ruby.railstutorial.org/chapters/user-microposts#main_content">skip to content</a>
  |
  <a href="http://ruby.railstutorial.org/book/ruby-on-rails-tutorial">view as single page</a>
</div>


<div id="book_wrap">
  <div id="book_top">
  </div>
    <div id="book">


<h1 class="title">Ruby on Rails Tutorial </h1>


<h1 class="subtitle">  Learn Web Development with Rails</h1>


<h2 class="author">Michael Hartl</h2>




<h2 class="contents">Contents</h2>


<div id="table_of_contents"><ol><li class="chapter"><a href="http://ruby.railstutorial.org/chapters/beginning#top"><span class="number">Chapter 1</span> From zero to deploy</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-introduction"><span class="number">1.1</span> Introduction</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-comments_for_various_readers"><span class="number">1.1.1</span> Comments for various readers</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-1_1_2"><span class="number">1.1.2</span> “Scaling” Rails</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-conventions"><span class="number">1.1.3</span> Conventions in this book</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-up_and_running"><span class="number">1.2</span> Up and running</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-development_tools"><span class="number">1.2.1</span> Development environments</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-1_2_1_1">IDEs</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-1_2_1_2">Text editors and command lines</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-1_2_1_3">Browsers</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-1_2_1_4">A note about tools</a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-rubygems"><span class="number">1.2.2</span> Ruby, RubyGems, Rails, and Git</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-rails_installer_windows">Rails Installer (Windows)</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-install_git">Install Git</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-install_ruby">Install Ruby</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-install_rubygems">Install RubyGems</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-install_rails">Install Rails</a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-the_first_application"><span class="number">1.2.3</span> The first application</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-bundler"><span class="number">1.2.4</span> Bundler</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-rails_server"><span class="number">1.2.5</span> <tt>rails server</tt></a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-mvc"><span class="number">1.2.6</span> Model-view-controller (MVC)</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-version_control"><span class="number">1.3</span> Version control with Git</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-git_setup"><span class="number">1.3.1</span> Installation and setup</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-1_3_1_1">First-time system setup</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-1_3_1_2">First-time repository setup</a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-adding_and_committing"><span class="number">1.3.2</span> Adding and committing</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-1_3_3"><span class="number">1.3.3</span> What good does Git do you?</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-github"><span class="number">1.3.4</span> GitHub</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-git_commands"><span class="number">1.3.5</span> Branch, edit, commit, merge</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-git_branch">Branch</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-git_edit">Edit</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-git_commit">Commit</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-git_merge">Merge</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-git_push">Push</a></li></ol></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-deploying"><span class="number">1.4</span> Deploying</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-heroku_setup"><span class="number">1.4.1</span> Heroku setup</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-heroku_step_one"><span class="number">1.4.2</span> Heroku deployment, step one</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-1_4_3"><span class="number">1.4.3</span> Heroku deployment, step two</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-heroku_commands"><span class="number">1.4.4</span> Heroku commands</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-beginning_conclusion"><span class="number">1.5</span> Conclusion</a></li></ol></li><li class="chapter"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#top"><span class="number">Chapter 2</span> A demo app</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-planning_the_application"><span class="number">2.1</span> Planning the application</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-modeling_demo_users"><span class="number">2.1.1</span> Modeling demo users</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-modeling_demo_microposts"><span class="number">2.1.2</span> Modeling demo microposts</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-demo_users_resource"><span class="number">2.2</span> The Users resource</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-a_user_tour"><span class="number">2.2.1</span> A user tour</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-mvc_in_action"><span class="number">2.2.2</span> MVC in action</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-weaknesses_of_this_users_resource"><span class="number">2.2.3</span> Weaknesses of this Users resource</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-microposts_resource"><span class="number">2.3</span> The Microposts resource</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-a_micropost_microtour"><span class="number">2.3.1</span> A micropost microtour</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-putting_the_micro_in_microposts"><span class="number">2.3.2</span> Putting the <em>micro</em> in microposts</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-demo_user_has_many_microposts"><span class="number">2.3.3</span> A user <tt>has_many</tt> microposts</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-inheritance_hierarchies"><span class="number">2.3.4</span> Inheritance hierarchies</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-deploying_the_demo_app"><span class="number">2.3.5</span> Deploying the demo app</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-2_4"><span class="number">2.4</span> Conclusion</a></li></ol></li><li class="chapter"><a href="http://ruby.railstutorial.org/chapters/static-pages#top"><span class="number">Chapter 3</span> Mostly static pages</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-static_pages"><span class="number">3.1</span> Static pages</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-truly_static_pages"><span class="number">3.1.1</span> Truly static pages</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-static_pages_with_rails"><span class="number">3.1.2</span> Static pages with Rails</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-first_tests"><span class="number">3.2</span> Our first tests</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-TDD"><span class="number">3.2.1</span> Test-driven development</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-adding_a_page"><span class="number">3.2.2</span> Adding a page</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-red">Red</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-green">Green</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-refactor">Refactor</a></li></ol></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-slightly_dynamic_pages"><span class="number">3.3</span> Slightly dynamic pages</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-testing_a_title_change"><span class="number">3.3.1</span> Testing a title change</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-passing_title_tests"><span class="number">3.3.2</span> Passing title tests</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-embedded_ruby"><span class="number">3.3.3</span> Embedded Ruby</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-layouts"><span class="number">3.3.4</span> Eliminating duplication with layouts</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-static_pages_conclusion"><span class="number">3.4</span> Conclusion</a></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-static_pages_exercises"><span class="number">3.5</span> Exercises</a></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-advanced_setup"><span class="number">3.6</span> Advanced setup</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-eliminating_bundle_exec"><span class="number">3.6.1</span> Eliminating <tt>bundle exec</tt></a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-rvm_bundler_integration">RVM Bundler integration</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-binstubs">binstubs</a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-guard"><span class="number">3.6.2</span> Automated tests with Guard</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-spork"><span class="number">3.6.3</span> Speeding up tests with Spork</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-spork_and_guard">Guard with Spork</a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-tests_inside_sublime_text"><span class="number">3.6.4</span> Tests inside Sublime Text</a></li></ol></li></ol></li><li class="chapter"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#top"><span class="number">Chapter 4</span> Rails-flavored Ruby</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-motivation"><span class="number">4.1</span> Motivation</a></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-strings_and_methods"><span class="number">4.2</span> Strings and methods</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-comments"><span class="number">4.2.1</span> Comments</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-strings"><span class="number">4.2.2</span> Strings</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-printing">Printing</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-single_quoted_strings">Single-quoted strings</a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-objects_and_message_passing"><span class="number">4.2.3</span> Objects and message passing</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-method_definitions"><span class="number">4.2.4</span> Method definitions</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-back_to_the_title_helper"><span class="number">4.2.5</span> Back to the title helper</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-other_data_structures"><span class="number">4.3</span> Other data structures</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-arrays_and_ranges"><span class="number">4.3.1</span> Arrays and ranges</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-blocks"><span class="number">4.3.2</span> Blocks</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-hashes_and_symbols"><span class="number">4.3.3</span> Hashes and symbols</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-css_revisited"><span class="number">4.3.4</span> CSS revisited</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-ruby_classes"><span class="number">4.4</span> Ruby classes</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-constructors"><span class="number">4.4.1</span> Constructors</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-a_class_of_our_own"><span class="number">4.4.2</span> Class inheritance</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-modifying_built_in_classes"><span class="number">4.4.3</span> Modifying built-in classes</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-a_controller_class"><span class="number">4.4.4</span> A controller class</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-a_user_class"><span class="number">4.4.5</span> A user class</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-conclusion"><span class="number">4.5</span> Conclusion</a></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-exercises"><span class="number">4.6</span> Exercises</a></li></ol></li><li class="chapter"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#top"><span class="number">Chapter 5</span> Filling in the layout</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-structure"><span class="number">5.1</span> Adding some structure</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-adding_to_the_layout"><span class="number">5.1.1</span> Site navigation</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-custom_css"><span class="number">5.1.2</span> Bootstrap and custom CSS</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-partials"><span class="number">5.1.3</span> Partials</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-sass_and_the_asset_pipeline"><span class="number">5.2</span> Sass and the asset pipeline</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-the_asset_pipeline"><span class="number">5.2.1</span> The asset pipeline</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-5_2_1_1">Asset directories</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-5_2_1_2">Manifest files</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-5_2_1_3">Preprocessor engines</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-5_2_1_4">Efficiency in production</a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-sass"><span class="number">5.2.2</span> Syntactically awesome stylesheets</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-5_2_2_1">Nesting</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-5_2_2_2">Variables</a></li></ol></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-layout_links"><span class="number">5.3</span> Layout links</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-route_tests"><span class="number">5.3.1</span> Route tests</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-rails_routes"><span class="number">5.3.2</span> Rails routes</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-named_routes"><span class="number">5.3.3</span> Named routes</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-pretty_rspec"><span class="number">5.3.4</span> Pretty RSpec</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-user_signup"><span class="number">5.4</span> User signup: A first step</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-users_controller"><span class="number">5.4.1</span> Users controller</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-signup_url"><span class="number">5.4.2</span> Signup URI</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-layout_conclusion"><span class="number">5.5</span> Conclusion</a></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-layout_exercises"><span class="number">5.6</span> Exercises</a></li></ol></li><li class="chapter"><a href="http://ruby.railstutorial.org/chapters/modeling-users#top"><span class="number">Chapter 6</span> Modeling users</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-user_model"><span class="number">6.1</span> User model</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-database_migrations"><span class="number">6.1.1</span> Database migrations</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-the_model_file"><span class="number">6.1.2</span> The model file</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-model_annotation">Model annotation</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-accessible_attributes">Accessible attributes</a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-creating_user_objects"><span class="number">6.1.3</span> Creating user objects</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-finding_user_objects"><span class="number">6.1.4</span> Finding user objects</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-updating_user_objects"><span class="number">6.1.5</span> Updating user objects</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-user_validations"><span class="number">6.2</span> User validations</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-initial_user_tests"><span class="number">6.2.1</span> Initial user tests</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-presence_validation"><span class="number">6.2.2</span> Validating presence</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-length_validation"><span class="number">6.2.3</span> Length validation</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-format_validation"><span class="number">6.2.4</span> Format validation</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-uniqueness_validation"><span class="number">6.2.5</span> Uniqueness validation</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-the_caveat">The uniqueness caveat</a></li></ol></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-adding_a_secure_password"><span class="number">6.3</span> Adding a secure password</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-an_encrypted_password"><span class="number">6.3.1</span> An encrypted password</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-password_and_confirmation"><span class="number">6.3.2</span> Password and confirmation</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-user_authentication"><span class="number">6.3.3</span> User authentication</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-has_secure_password"><span class="number">6.3.4</span> User has secure password</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-creating_a_user"><span class="number">6.3.5</span> Creating a user</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-6_4"><span class="number">6.4</span> Conclusion</a></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-6_5"><span class="number">6.5</span> Exercises</a></li></ol></li><li class="chapter"><a href="http://ruby.railstutorial.org/chapters/sign-up#top"><span class="number">Chapter 7</span> Sign up</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-showing_users"><span class="number">7.1</span> Showing users</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-rails_environments"><span class="number">7.1.1</span> Debug and Rails environments</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-a_users_resource"><span class="number">7.1.2</span> A Users resource</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-tests_with_factories"><span class="number">7.1.3</span> Testing the user show page (with factories)</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-a_gravatar_image"><span class="number">7.1.4</span> A Gravatar image and a sidebar</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-signup_form"><span class="number">7.2</span> Signup form</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-tests_for_user_signup"><span class="number">7.2.1</span> Tests for user signup</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-using_form_for"><span class="number">7.2.2</span> Using <tt>form_for</tt></a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-the_form_html"><span class="number">7.2.3</span> The form HTML</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-signup_failure"><span class="number">7.3</span> Signup failure</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-a_working_form"><span class="number">7.3.1</span> A working form</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-signup_error_messages"><span class="number">7.3.2</span> Signup error messages</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-signup_success"><span class="number">7.4</span> Signup success</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-the_finished_signup_form"><span class="number">7.4.1</span> The finished signup form</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-the_flash"><span class="number">7.4.2</span> The flash</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-the_first_signup"><span class="number">7.4.3</span> The first signup</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-deploying_to_production_with_ssl"><span class="number">7.4.4</span> Deploying to production with SSL</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-7_5"><span class="number">7.5</span> Conclusion</a></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-signup_exercises"><span class="number">7.6</span> Exercises</a></li></ol></li><li class="chapter"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#top"><span class="number">Chapter 8</span> Sign in, sign out</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_failure"><span class="number">8.1</span> Sessions and signin failure</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-sessions_controller"><span class="number">8.1.1</span> Sessions controller</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_tests"><span class="number">8.1.2</span> Signin tests</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_form"><span class="number">8.1.3</span> Signin form</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-reviewing_form_submission"><span class="number">8.1.4</span> Reviewing form submission</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-rendering_with_a_flash_message"><span class="number">8.1.5</span> Rendering with a flash message</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_success"><span class="number">8.2</span> Signin success</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-remember_me"><span class="number">8.2.1</span> Remember me</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-a_working_sign_in_method"><span class="number">8.2.2</span> A working <tt>sign_in</tt> method</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-current_user"><span class="number">8.2.3</span> Current user</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-changing_the_layout_links"><span class="number">8.2.4</span> Changing the layout links</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_upon_signup"><span class="number">8.2.5</span> Signin upon signup</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signing_out"><span class="number">8.2.6</span> Signing out</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-cucumber"><span class="number">8.3</span> Introduction to Cucumber (optional)</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-installation_and_setup"><span class="number">8.3.1</span> Installation and setup</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-features_and_steps"><span class="number">8.3.2</span> Features and steps</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-rspec_custom_matchers"><span class="number">8.3.3</span> Counterpoint: RSpec custom matchers</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-8_4"><span class="number">8.4</span> Conclusion</a></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-sign_in_out_exercises"><span class="number">8.5</span> Exercises</a></li></ol></li><li class="chapter"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#top"><span class="number">Chapter 9</span> Updating, showing, and deleting users</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-updating_users"><span class="number">9.1</span> Updating users</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-edit_form"><span class="number">9.1.1</span> Edit form</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-unsuccessful_edits"><span class="number">9.1.2</span> Unsuccessful edits</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-successful_edits"><span class="number">9.1.3</span> Successful edits</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-authorization"><span class="number">9.2</span> Authorization</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-requiring_signed_in_users"><span class="number">9.2.1</span> Requiring signed-in users</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-requiring_the_right_user"><span class="number">9.2.2</span> Requiring the right user</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-friendly_forwarding"><span class="number">9.2.3</span> Friendly forwarding</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-showing_all_users"><span class="number">9.3</span> Showing all users</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-user_index"><span class="number">9.3.1</span> User index</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-sample_users"><span class="number">9.3.2</span> Sample users</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-pagination"><span class="number">9.3.3</span> Pagination</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-partial_refactoring"><span class="number">9.3.4</span> Partial refactoring</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-destroying_users"><span class="number">9.4</span> Deleting users</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-administrative_users"><span class="number">9.4.1</span> Administrative users</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-revisiting_attr_accessible">Revisiting <tt>attr_accessible</tt></a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-the_destroy_action"><span class="number">9.4.2</span> The <tt>destroy</tt> action</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-updating_and_deleting_users_conclusion"><span class="number">9.5</span> Conclusion</a></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-updating_deleting_exercises"><span class="number">9.6</span> Exercises</a></li></ol></li><li class="chapter"><a href="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/Learn Web Development with the Ruby on Rails Tutorial   User Microposts.html"><span class="number">Chapter 10</span> User microposts</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-a_micropost_model"><span class="number">10.1</span> A Micropost model</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-the_basic_model"><span class="number">10.1.1</span> The basic model</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-accessible_attribute"><span class="number">10.1.2</span> Accessible attributes and the first validation</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-user_micropost_associations"><span class="number">10.1.3</span> User/Micropost associations</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-ordering_and_dependency"><span class="number">10.1.4</span> Micropost refinements</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-default_scope">Default scope</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-dependent_destroy">Dependent: destroy</a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-micropost_validations"><span class="number">10.1.5</span> Content validations</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-showing_microposts"><span class="number">10.2</span> Showing microposts</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-augmenting_the_user_show_page"><span class="number">10.2.1</span> Augmenting the user show page</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-sample_microposts"><span class="number">10.2.2</span> Sample microposts</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-manipulating_microposts"><span class="number">10.3</span> Manipulating microposts</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-access_control"><span class="number">10.3.1</span> Access control</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-creating_microposts"><span class="number">10.3.2</span> Creating microposts</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-a_proto_feed"><span class="number">10.3.3</span> A proto-feed</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-destroying_microposts"><span class="number">10.3.4</span> Destroying microposts</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-10_4"><span class="number">10.4</span> Conclusion</a></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-micropost_exercises"><span class="number">10.5</span> Exercises</a></li></ol></li><li class="chapter"><a href="http://ruby.railstutorial.org/chapters/following-users#top"><span class="number">Chapter 11</span> Following users</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-the_relationship_model"><span class="number">11.1</span> The Relationship model</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-a_problem_with_the_data_model"><span class="number">11.1.1</span> A problem with the data model (and a solution)</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-relationship_user_associations"><span class="number">11.1.2</span> User/relationship associations</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-relationship_validations"><span class="number">11.1.3</span> Validations</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-following"><span class="number">11.1.4</span> Followed users</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-followers"><span class="number">11.1.5</span> Followers</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-a_web_interface_for_following_and_followers"><span class="number">11.2</span> A web interface for following users</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-sample_following_data"><span class="number">11.2.1</span> Sample following data</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-stats_and_a_follow_form"><span class="number">11.2.2</span> Stats and a follow form</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-following_and_followers_pages"><span class="number">11.2.3</span> Following and followers pages</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-a_working_follow_button_the_standard_way"><span class="number">11.2.4</span> A working follow button the standard way</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-a_working_follow_button_with_ajax"><span class="number">11.2.5</span> A working follow button with Ajax</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-the_status_feed"><span class="number">11.3</span> The status feed</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-motivation_and_strategy"><span class="number">11.3.1</span> Motivation and strategy</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-a_first_feed_implementation"><span class="number">11.3.2</span> A first feed implementation</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-scopes_subselects_and_a_lambda"><span class="number">11.3.3</span> Subselects</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-the_new_status_feed"><span class="number">11.3.4</span> The new status feed</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-following_conclusion"><span class="number">11.4</span> Conclusion</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-extensions_to_the_sample_application"><span class="number">11.4.1</span> Extensions to the sample application</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-replies">Replies</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-messaging">Messaging</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-follower_notifications">Follower notifications</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-password_reminders">Password reminders</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-signup_confirmation">Signup confirmation</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-rss_feed">RSS feed</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-rest_api">REST API</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-search">Search</a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-guide_to_further_resources"><span class="number">11.4.2</span> Guide to further resources</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-following_exercises"><span class="number">11.5</span> Exercises</a></li></ol></li></ol></div>


<div id="main_content"></div>


<p> <span class="preamble">
 <span id="foreword">
<strong> Foreword</strong> <br>
 </span>
 </span></p>

<p>My former company (CD Baby) was one of the first to loudly switch to Ruby on Rails, and then even more loudly switch back to PHP (Google me to read about the drama). This book by Michael Hartl came so highly recommended that I had to try it, and the <em>Ruby on Rails Tutorial</em> is what I used to switch back to Rails again.</p>

<p>Though I’ve worked my way through many Rails books, this is the one that finally made me “get” it. Everything is done very much “the Rails way”—a way that felt very unnatural to me before, but now after doing this book finally feels natural. This is also the only Rails book that does test-driven development the entire time, an approach highly recommended by the experts but which has never been so clearly demonstrated before. Finally, by including Git, GitHub, and Heroku in the demo examples, the author really gives you a feel for what it’s like to do a real-world project. The tutorial’s code examples are not in isolation.</p>

<p>The linear narrative is such a great format. Personally, I powered through the <em>Rails Tutorial</em> in three long days, doing all the examples and challenges at the end of each chapter. Do it from start to finish, without jumping around, and you’ll get the ultimate benefit.</p>

<p>Enjoy!</p>

<p><a href="http://sivers.org/">Derek Sivers</a> (<a href="http://sivers.org/">sivers.org</a>) <br>
<em>Formerly: Founder,</em> <a href="http://www.cdbaby.com/"><em>CD Baby</em></a> <br>
<em>Currently: Founder,</em> <a href="http://thoughts.pro/"><em>Thoughts Ltd.</em></a> <br></p>

<p> <span class="preamble">
<strong> Acknowledgments</strong> <br>
 </span></p>

<p>The <em>Ruby on Rails Tutorial</em> owes a lot to my previous Rails book, <em>RailsSpace</em>, and hence to my coauthor <a href="http://aure.com/">Aurelius Prochazka</a>. I’d like to thank Aure both for the work he did on that book and for his support of this one. I’d also like to thank Debra Williams Cauley, my editor on both <em>RailsSpace</em> and the <em>Ruby on Rails Tutorial</em>; as long as she keeps taking me to baseball games, I’ll keep writing books for her.</p>

<p>I’d like to acknowledge a long list of Rubyists who have taught and inspired me over the years: David Heinemeier Hansson, Yehuda Katz, Carl Lerche, Jeremy Kemper, Xavier Noria, Ryan Bates, Geoffrey Grosenbach, Peter Cooper, Matt Aimonetti, Gregg Pollack, Wayne&nbsp;E. Seguin, Amy Hoy, Dave Chelimsky, Pat Maddox, Tom Preston-Werner, Chris Wanstrath, Chad Fowler, Josh Susser, Obie Fernandez, Ian McFarland, Steven Bristol, Pratik Naik, Sarah Mei, Sarah Allen, Wolfram Arnold, Alex Chaffee, Giles Bowkett, Evan Dorn, Long Nguyen, James Lindenbaum, Adam Wiggins, Tikhon Bernstam, Ron Evans, Wyatt Greene, Miles Forrest, the good people at Pivotal Labs, the Heroku gang, the thoughtbot guys, and the GitHub crew. Finally, many, many readers—far too many to list—have contributed a huge number of bug reports and suggestions during the writing of this book, and I gratefully acknowledge their help in making it as good as it can&nbsp;be. <br></p>

<p> <span class="preamble">
 <span id="author">
<strong> About the author</strong> <br>
 </span>
 </span></p>

<p><a href="http://michaelhartl.com/">Michael Hartl</a> is the author of the <a href="http://ruby.railstutorial.org/"><em>Ruby on Rails Tutorial</em></a>, the leading introduction to web development with <a href="http://rubyonrails.org/">Ruby on Rails</a>. His prior experience includes writing and developing <em>RailsSpace</em>, an extremely obsolete Rails tutorial book, and developing Insoshi, a once-popular and now-obsolete social networking platform in Ruby on Rails. In 2011, Michael received a <a href="http://rubyheroes.com/heroes">Ruby Hero Award</a> for his contributions to the Ruby community. He is a graduate of <a href="http://college.harvard.edu/">Harvard College</a>, has a <a href="http://resolver.caltech.edu/CaltechETD:etd-05222003-161626">Ph.D. in Physics</a> from <a href="http://www.caltech.edu/">Caltech</a>, and is an alumnus of the <a href="http://ycombinator.com/">Y&nbsp;Combinator</a> entrepreneur program. <br></p>

<p> <span id="license" class="preamble">
<strong> Copyright and license</strong> <br>
 </span></p>

<p><em>Ruby on Rails Tutorial: Learn Web Development with Rails</em>. Copyright © 2012 by Michael Hartl. All source code in the <em>Ruby on Rails Tutorial</em> is available jointly under the <a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a> and the <a href="http://people.freebsd.org/~phk/">Beerware License</a>.</p>

<div class="code"><div class="highlight"><pre>The MIT License

Copyright (c) 2012 Michael Hartl

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
</pre></div>
</div>


<div class="code"><div class="highlight"><pre>/*
 * ----------------------------------------------------------------------------
 * "THE BEER-WARE LICENSE" (Revision 42):
 * Michael Hartl wrote this code. As long as you retain this notice you
 * can do whatever you want with this stuff. If we meet some day, and you think
 * this stuff is worth it, you can buy me a beer in return.
 * ----------------------------------------------------------------------------
 */
</pre></div>
</div>


<div id="top"></div>


<h1 class="chapter"><a id="sec-10" href="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/Learn Web Development with the Ruby on Rails Tutorial   User Microposts.html" class="heading"><span class="number">Chapter 10</span> User microposts</a></h1>


<p><a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#top">Chapter&nbsp;9</a> saw the completion of the REST actions for the Users resource, so the time has finally come to add a second full resource: user <em>microposts</em>.<sup class="footnote" id="fnref-10_1"><a href="http://ruby.railstutorial.org/chapters/user-microposts#fn-10_1">1</a></sup> These are short messages associated with a particular user, first seen in larval form in <a class="ref" href="http://ruby.railstutorial.org/chapters/a-demo-app#top">Chapter&nbsp;2</a>. In this chapter, we will make a full-strength version of the sketch from <a class="ref" href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-microposts_resource">Section&nbsp;2.3</a> by constructing the Micropost data model, associating it with the User model using the <code>has_many</code> and <code>belongs_to</code> methods, and then making the forms and partials needed to manipulate and display the results. In <a class="ref" href="http://ruby.railstutorial.org/chapters/following-users#top">Chapter&nbsp;11</a>, we’ll complete our tiny Twitter clone by adding the notion of <em>following</em> users in order to receive a <em>feed</em> of their microposts.</p>

<p>If you’re using Git for version control, I suggest making a topic branch as usual:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b user-microposts
</pre></div>
</div>




<div class="label" id="sec-a_micropost_model"></div>


<h2><a id="sec-10_1" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-a_micropost_model" class="heading"><span class="number">10.1</span> A Micropost model</a></h2>


<p>We begin the Microposts resource by creating a Micropost model, which captures the essential characteristics of microposts. What follows builds on the work from <a class="ref" href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-microposts_resource">Section&nbsp;2.3</a>; as with the model in that section, our new Micropost model will include data validations and an association with the User model. Unlike that model, the present Micropost model will be fully tested, and will also have a default <em>ordering</em> and automatic <em>destruction</em> if its parent user is destroyed.</p>

<div class="label" id="sec-the_basic_model"></div>


<h3><a id="sec-10_1_1" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-the_basic_model" class="heading"><span class="number">10.1.1</span> The basic model</a></h3>


<p>The Micropost model needs only two attributes: a <code>content</code> attribute to hold the micropost’s content,<sup class="footnote" id="fnref-10_2"><a href="http://ruby.railstutorial.org/chapters/user-microposts#fn-10_2">2</a></sup> and a <code>user_id</code> to associate a micropost with a particular user. As with the case of the User model (<a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-users#code-generate_user_model">Listing&nbsp;6.1</a>), we generate it using <code>generate model</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate model Micropost content:string user_id:integer
</pre></div>
</div>


<p>This produces a migration to create a <code>microposts</code> table in the database (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_migration">Listing&nbsp;10.1</a>); compare it to the analogous migration for the <code>users</code> table from <a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-users#code-users_migration">Listing&nbsp;6.2</a>.</p>

<div class="label" id="code-micropost_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.1.</span> <span class="description">The Micropost migration. (Note the index on <code>user_id</code> and <code>created_at</code>.) <br> <code>db/migrate/[timestamp]_create_microposts.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateMicroposts</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:microposts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:content</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:user_id</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
    <span class="n">add_index</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="o">[</span><span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:created_at</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that, since we expect to retrieve all the microposts associated with a given user&nbsp;id in reverse order of creation, <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_migration">Listing&nbsp;10.1</a> adds an index (<a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-users#sidebar-database_indices">Box&nbsp;6.2</a>) on the <code>user_id</code> and <code>created_at</code> columns:</p>

<div class="code"><div class="highlight"><pre><span class="n">add_index</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="o">[</span><span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:created_at</span><span class="o">]</span>
</pre></div>
</div>


<p>By including both the <code>user_id</code> and <code>created_at</code> columns as an array, we arrange for Rails to create a <em>multiple key index</em>, which means that Active Record uses <em>both</em> keys at the same time. Note also the <code>t.timestamps</code> line, which (as mentioned in <a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-users#sec-database_migrations">Section&nbsp;6.1.1</a>) adds the magic <code>created_at</code> and <code>updated_at</code> columns. We’ll put the <code>created_at</code> column to work in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-ordering_and_dependency">Section&nbsp;10.1.4</a> and <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-augmenting_the_user_show_page">Section&nbsp;10.2.1</a>.</p>

<p>We’ll start with some minimal tests for the Micropost model based on the analogous tests for the User model (<a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-users#code-user_spec">Listing&nbsp;6.8</a>). In particular, we verify that a micropost object responds to the <code>content</code> and <code>user_id</code> attributes, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-initial_micropost_spec">Listing&nbsp;10.2</a>.</p>

<div class="label" id="code-initial_micropost_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.2.</span> <span class="description">The initial Micropost spec. <br> <code>spec/models/micropost_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="c1"># This code is wrong!</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">"Lorem ipsum"</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>We can get these tests to pass by running the microposts migration and preparing the test database:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>The result is a Micropost model with the structure shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig-micropost_model">Figure&nbsp;10.1</a>.</p>

<div class="label" id="fig-micropost_model"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/micropost_model.png" alt="micropost_model"></span></div><div class="caption"><span class="header">Figure 10.1: </span><span class="description">The Micropost data model.</span></div></div>


<p>You should verify that the tests pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/micropost_spec.rb
</pre></div>
</div>


<p>Even though the tests are passing, you might have noticed this code:</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">before</span> <span class="k">do</span>
  <span class="c1"># This code is wrong!</span>
  <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">"Lorem ipsum"</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>The comment indicates that the code in the <code>before</code> block is wrong. See if you can guess why. We’ll see the answer in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-user_micropost_associations">Section&nbsp;10.1.3</a>.</p>

<div class="label" id="sec-accessible_attribute"></div>


<h3><a id="sec-10_1_2" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-accessible_attribute" class="heading"><span class="number">10.1.2</span> Accessible attributes and the first validation</a></h3>


<p>To see why the code in the <code>before</code> block is wrong, we first start with validation tests for the Micropost model (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_validity_test">Listing&nbsp;10.3</a>). (Compare with the User model tests in <a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-users#code-failing_validates_name_spec">Listing&nbsp;6.11</a>.)</p>

<div class="label" id="code-micropost_validity_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.3.</span> <span class="description">Tests for the validity of a new micropost. <br> <code>spec/models/micropost_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="c1"># This code is wrong!</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">"Lorem ipsum"</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"when user_id is not present"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This code requires that the micropost be valid and tests for the presence of the <code>user_id</code> attribute. We can get these tests to pass with the simple presence validation shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_user_id_validation">Listing&nbsp;10.4</a>.</p>

<div class="label" id="code-micropost_user_id_validation"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.4.</span> <span class="description">A validation for the micropost’s <code>user_id</code>. <br> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:user_id</span>  
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Now we’re prepared to see why</p>

<div class="code"><div class="highlight"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">"Lorem ipsum"</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>


<p>is wrong. The problem is that by default (as of Rails&nbsp;3.2.3) <em>all</em> of the attributes for our Micropost model are accessible. As discussed in <a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-users#sec-accessible_attributes">Section&nbsp;6.1.2.2</a> and <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-revisiting_attr_accessible">Section&nbsp;9.4.1.1</a>, this means that anyone could change any aspect of a micropost object simply by using a command-line client to issue malicious requests. For example, a malicious user could change the <code>user_id</code> attributes on microposts, thereby associating microposts with the wrong users. This means that we should remove <code>:user_id</code> from the <code>attr_accessible</code> list, and once we do, the code above will fail. We’ll fix this issue in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-user_micropost_associations">Section&nbsp;10.1.3</a>.</p>

<div class="label" id="sec-user_micropost_associations"></div>


<h3><a id="sec-10_1_3" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-user_micropost_associations" class="heading"><span class="number">10.1.3</span> User/Micropost associations</a></h3>


<p>When constructing data models for web applications, it is essential to be able to make <em>associations</em> between individual models. In the present case, each micropost is associated with one user, and each user is associated with (potentially) many microposts—a relationship seen briefly in <a class="ref" href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-demo_user_has_many_microposts">Section&nbsp;2.3.3</a> and shown schematically in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig-micropost_belongs_to_user">Figure&nbsp;10.2</a> and <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig-user_has_many_microposts">Figure&nbsp;10.3</a>. As part of implementing these associations, we’ll write tests for the Micropost model that, unlike <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-initial_micropost_spec">Listing&nbsp;10.2</a>, are compatible with the use of <code>attr_accessible</code> in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_accessible_attribute">Listing&nbsp;10.7</a>.</p>

<div class="label" id="fig-micropost_belongs_to_user"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/micropost_belongs_to_user.png" alt="micropost_belongs_to_user"></span></div><div class="caption"><span class="header">Figure 10.2: </span><span class="description">The <code>belongs_to</code> relationship between a micropost and its user.</span></div></div>




<div class="label" id="fig-user_has_many_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/user_has_many_microposts.png" alt="user_has_many_microposts"></span></div><div class="caption"><span class="header">Figure 10.3: </span><span class="description">The <code>has_many</code> relationship between a user and its microposts.</span></div></div>


<p>Using the <code>belongs_to</code>/<code>has_many</code> association defined in this section, Rails constructs the methods shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#table-association_methods">Table&nbsp;10.1</a>.</p>

<div class="label" id="table-association_methods"></div>


<div class="table"><div class="center">
<table class="tabular"><tbody><tr><th class="align_left"><strong>Method</strong></th><th class="align_left"><strong>Purpose</strong></th></tr><tr class="top_bar"><td class="align_left"><code>micropost.user</code></td><td class="align_left">Return the User object associated with the micropost.</td></tr><tr><td class="align_left"><code>user.microposts</code></td><td class="align_left">Return an array of the user’s microposts.</td></tr><tr><td class="align_left"><code>user.microposts.create(arg)</code></td><td class="align_left">Create a micropost (<code>user_id = user.id</code>).</td></tr><tr><td class="align_left"><code>user.microposts.create!(arg)</code></td><td class="align_left">Create a micropost (exception on failure).</td></tr><tr><td class="align_left"><code>user.microposts.build(arg)</code></td><td class="align_left">Return a new Micropost object (<code>user_id = user.id</code>).</td></tr></tbody></table></div><div class="caption"><span class="header">Table 10.1: </span><span class="description">A summary of user/micropost association methods.</span></div></div>


<p>Note from <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#table-association_methods">Table&nbsp;10.1</a> that instead of</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">create</span>
<span class="no">Micropost</span><span class="o">.</span><span class="n">create!</span>
<span class="no">Micropost</span><span class="o">.</span><span class="n">new</span>
</pre></div>
</div>


<p>we have</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create</span>
<span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span>
<span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
</pre></div>
</div>


<p>This pattern is the canonical way to make a micropost: <em>through</em> its association with a user. When a new micropost is made in this way, its <code>user_id</code> is <em>automatically</em> set to the right value, which fixes the issue noted in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-accessible_attribute">Section&nbsp;10.1.2</a>. In particular, we can replace the code</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">before</span> <span class="k">do</span>
  <span class="c1"># This code is wrong!</span>
  <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">"Lorem ipsum"</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>from <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_validity_test">Listing&nbsp;10.3</a> with</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">"Lorem ipsum"</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>Once we define the proper associations, the resulting <code>@micropost</code> variable will automatically have <code>user_id</code> equal to its associated user.</p>

<p>Building the micropost through the User association doesn’t fix the security problem of having an accessible <code>user_id</code>, and
because this is such an important security concern we’ll add a failing test to catch it, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-attr_accessible_user_id_test">Listing&nbsp;10.5</a>.</p>

<div class="label" id="code-attr_accessible_user_id_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.5.</span> <span class="description">A test to ensure that the <code>user_id</code> isn’t accessible. <br> <code>spec/models/micropost_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">"Lorem ipsum"</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"accessible attributes"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"should not allow access to user_id"</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="k">do</span>
        <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
      <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="ss">ActiveModel::MassAssignmentSecurity</span><span class="o">::</span><span class="no">Error</span><span class="p">)</span>
    <span class="k">end</span>    
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This test verifies that calling <code>Micropost.new</code> with a nonempty <code>user_id</code> raises a mass assignment security error exception. This behavior is on by default as of Rails&nbsp;3.2.3, but previous versions had it off, so you should make sure that your application is configured properly, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-application_whitelist">Listing&nbsp;10.6</a>.</p>

<div class="label" id="code-application_whitelist"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.6.</span> <span class="description">Ensuring that Rails throws errors on invalid mass assignment. <br> <code>config/application.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="k">module</span> <span class="nn">SampleApp</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="ss">Rails::Application</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">config</span><span class="o">.</span><span class="n">active_record</span><span class="o">.</span><span class="n">whitelist_attributes</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>In the case of the Micropost model, there is only <em>one</em> attribute that needs to be editable through the web, namely, the <code>content</code> attribute, so we need to remove <code>:user_id</code> from the accessible list, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_accessible_attribute">Listing&nbsp;10.7</a>.</p>

<div class="label" id="code-micropost_accessible_attribute"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.7.</span> <span class="description">Making the <code>content</code> attribute (and <em>only</em> the <code>content</code> attribute) accessible. <br> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span>

  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As seen in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#table-association_methods">Table&nbsp;10.1</a>, another result of the user/micropost association is <code>micropost.user</code>, which simply returns the micropost’s user. We can test this with the <code>it</code> and <code>its</code> methods as follows:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">its</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="n">user</span> <span class="p">}</span>
</pre></div>
</div>


<p>The resulting Micropost model tests are shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_belongs_to_user_spec">Listing&nbsp;10.8</a>.</p>

<div class="label" id="code-micropost_belongs_to_user_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.8.</span> <span class="description">Tests for the micropost’s user association. <br> <code>spec/models/micropost_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">"Lorem ipsum"</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">its</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="n">user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"accessible attributes"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"should not allow access to user_id"</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="k">do</span>
        <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
      <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="ss">ActiveModel::MassAssignmentSecurity</span><span class="o">::</span><span class="no">Error</span><span class="p">)</span>
    <span class="k">end</span>    
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"when user_id is not present"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>On the User model side of the association, we’ll defer the more detailed tests to <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-ordering_and_dependency">Section&nbsp;10.1.4</a>; for now, we’ll simply test for the presence of a <code>microposts</code> attribute (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-user_has_many_microposts_spec">Listing&nbsp;10.9</a>).</p>

<div class="label" id="code-user_has_many_microposts_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.9.</span> <span class="description">A test for the user’s <code>microposts</code> attribute. <br> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">"user@example.com"</span><span class="p">,</span> 
                     <span class="ss">password:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">"foobar"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:microposts</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>After all that work, the code to implement the association is almost comically short: we can get the tests in both <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_belongs_to_user_spec">Listing&nbsp;10.8</a> and <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-user_has_many_microposts_spec">Listing&nbsp;10.9</a> to pass by adding just two lines: <code>belongs_to :user</code> (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_belongs_to_user">Listing&nbsp;10.10</a>) and <code>has_many :microposts</code> (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-user_has_many_microposts">Listing&nbsp;10.11</a>).</p>

<div class="label" id="code-micropost_belongs_to_user"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.10.</span> <span class="description">A micropost <code>belongs_to</code> a user. <br> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>

  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>  
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-user_has_many_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.11.</span> <span class="description">A user <code>has_many</code> microposts. <br> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="n">has_secure_password</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>At this point, you should compare the entries in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#table-association_methods">Table&nbsp;10.1</a> with the code in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_belongs_to_user_spec">Listing&nbsp;10.8</a> and <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-user_has_many_microposts_spec">Listing&nbsp;10.9</a> to satisfy yourself that you understand the basic nature of the associations. You should also check that the tests pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models
</pre></div>
</div>




<div class="label" id="sec-ordering_and_dependency"></div>


<h3><a id="sec-10_1_4" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-ordering_and_dependency" class="heading"><span class="number">10.1.4</span> Micropost refinements</a></h3>


<p>The test in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-user_has_many_microposts_spec">Listing&nbsp;10.9</a> of the <code>has_many</code> association doesn’t test for much—it merely verifies the <em>existence</em> of a <code>microposts</code> attribute. In this section, we’ll add <em>ordering</em> and <em>dependency</em> to microposts, while also testing that the <code>user.microposts</code> method actually returns an array of microposts.</p>

<p>We will need to construct some microposts in the User model test, which means that we should make a micropost factory at this point. To do this, we need a way to make an association in Factory Girl. Happily, this is easy, as seen in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_factory">Listing&nbsp;10.12</a>.</p>

<div class="label" id="code-micropost_factory"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.12.</span> <span class="description">The complete factory file, including a new factory for microposts. <br> <code>spec/factories.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com"</span><span class="p">}</span>   
    <span class="n">password</span> <span class="s2">"foobar"</span>
    <span class="n">password_confirmation</span> <span class="s2">"foobar"</span>

    <span class="n">factory</span> <span class="ss">:admin</span> <span class="k">do</span>
      <span class="n">admin</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">factory</span> <span class="ss">:micropost</span> <span class="k">do</span>
    <span class="n">content</span> <span class="s2">"Lorem ipsum"</span>
    <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here we tell Factory Girl about the micropost’s associated user just by including a user in the definition of the factory:</p>

<div class="code"><div class="highlight"><pre><span class="n">factory</span> <span class="ss">:micropost</span> <span class="k">do</span>
  <span class="n">content</span> <span class="s2">"Lorem ipsum"</span>
  <span class="n">user</span>
<span class="k">end</span>
</pre></div>
</div>


<p>As we’ll see in the next section, this allows us to define factory microposts as follows:</p>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
</pre></div>
</div>


<div class="label" id="sec-default_scope"></div>


<h4><a id="sec-10_1_4_1" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-default_scope" class="heading">Default scope</a></h4>


<p>By default, using <code>user.microposts</code> to pull a user’s microposts from the database makes no guarantees about the order of the posts, but (following the convention of blogs and Twitter) we want the microposts to come out in reverse order of when they were created, i.e., most recent first. To test this ordering, we first create a couple of microposts as follows:</p>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
<span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
</pre></div>
</div>


<p>Here we indicate (using the time helpers discussed in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sidebar-time_helpers">Box&nbsp;8.1</a>) that the second post was created more recently, i.e., <code>1.hour.ago</code>, while the first post was created <code>1.day.ago</code>. Note how convenient the use of Factory Girl is: not only can we assign the user using mass assignment (since factories bypass <code>attr_accessible</code>), we can also set <code>created_at</code> manually, which Active Record won’t allow us to do. (Recall that <code>created_at</code> and <code>updated_at</code> are “magic” columns, automatically set to the proper creation and update timestamps, so any explicit initialization values are overwritten by the magic.)</p>

<p>Most database adapters (including the one for SQLite) return the microposts in order of their ids, so we can arrange for an initial test that almost certainly fails using the code in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_ordering_test">Listing&nbsp;10.13</a>. This uses the <code>let!</code> (read “let bang”) method in place of <code>let</code>; the reason is that <code>let</code> variables are <em>lazy</em>, meaning that they only spring into existence when referenced. The problem is that we want the microposts to exist immediately, so that the timestamps are in the right order and so that <code>@user.microposts</code> isn’t empty. We accomplish this with <code>let!</code>, which forces the corresponding variable to come into existence immediately.</p>

<div class="label" id="code-micropost_ordering_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.13.</span> <span class="description">Testing the order of a user’s microposts. <br> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"micropost associations"</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span> 
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should have the right microposts in the right order"</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span><span class="n">newer_micropost</span><span class="p">,</span> <span class="n">older_micropost</span><span class="o">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The key line here is</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span><span class="n">newer_micropost</span><span class="p">,</span> <span class="n">older_micropost</span><span class="o">]</span>
</pre></div>
</div>


<p>indicating that the posts should be ordered newest first. This should fail because by default the posts will be ordered by&nbsp;id, i.e., <code>[older_micropost, newer_micropost]</code>. This test also verifies the basic correctness of the <code>has_many</code> association itself, by checking (as indicated in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#table-association_methods">Table&nbsp;10.1</a>) that <code>user.microposts</code> is an array of microposts.</p>

<p>To get the ordering test to pass, we use a Rails facility called <code>default_scope</code> with an <code>:order</code> parameter, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_ordering">Listing&nbsp;10.14</a>. (This is our first example of the notion of <em>scope</em>. We will learn about scope in a more general context in <a class="ref" href="http://ruby.railstutorial.org/chapters/following-users#top">Chapter&nbsp;11</a>.)</p>

<div class="label" id="code-micropost_ordering"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.14.</span> <span class="description">Ordering the microposts with <code>default_scope</code>.  <br> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">default_scope</span> <span class="ss">order:</span> <span class="s1">'microposts.created_at DESC'</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The order here is <code>’microposts.created_at DESC’</code>, where <code>DESC</code> is SQL for “descending”, i.e., in descending order from newest to oldest.</p>

<div class="label" id="sec-dependent_destroy"></div>


<h4><a id="sec-10_1_4_2" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-dependent_destroy" class="heading">Dependent: destroy</a></h4>


<p>Apart from proper ordering, there is a second refinement we’d like to add to microposts. Recall from <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-destroying_users">Section&nbsp;9.4</a> that site administrators have the power to <em>destroy</em> users. It stands to reason that, if a user is destroyed, the user’s microposts should be destroyed as well. We can test for this by first destroying a micropost’s user and then verifying that the associated microposts are no longer in the database.</p>

<p>In order to test destroying microposts properly, we first need to capture a given user’s posts in a local variable, and then destroy the user. A straighforward implementation looks like this:</p>

<div class="code"><div class="highlight"><pre><span class="n">microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span>
<span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
<span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
  <span class="c1"># Make sure the micropost doesn't appear in the database.</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Unfortunately, this doesn’t work, due to a subtlety about Ruby arrays. Array assignment in Ruby copies a <em>reference</em> to the array, not the full array itself, which means that changes to the original array also affect the copy. For example, suppose we create an array, assign a second variable to it, and then reverse the first array in place using the <code>reverse!</code> method:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
<span class="go">=&gt; [1, 2, 3]</span>
<span class="gp">&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">a</span>
<span class="go">=&gt; [1, 2, 3]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">reverse!</span>
<span class="go">=&gt; [3, 2, 1]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [3, 2, 1]</span>
<span class="gp">&gt;&gt; </span><span class="n">b</span>
<span class="go">=&gt; [3, 2, 1]</span>
</pre></div>
</div>


<p>Somewhat suprisingly, here <code>b</code> gets reversed as well as <code>a</code>. This is because both <code>a</code> and <code>b</code> point to the same array. (The same thing happens with other Ruby data structures, such as strings and hashes.)</p>

<p>In the case of a user’s microposts, we would have this:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span>
<span class="gp">&gt;&gt; </span><span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
<span class="gp">&gt;&gt; </span><span class="n">microposts</span>
<span class="go">=&gt; []</span>
</pre></div>
</div>


<p>(Because we haven’t implemented the destruction of associated microposts yet, this code won’t currently work, and is included only to illustrate the principle.) Here we see that destroying a user leaves the <code>microposts</code> variable with no elements; i.e., it’s the empty array&nbsp;<code>[]</code>.</p>

<p>This behavior means that we must take great care when making duplicates of Ruby objects. To duplicate relatively simple objects such as arrays, we can use the <code>dup</code> method:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
<span class="go">=&gt; [1, 2, 3]</span>
<span class="gp">&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">dup</span>
<span class="go">=&gt; [1, 2, 3]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">reverse!</span>
<span class="go">=&gt; [3, 2, 1]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [3, 2, 1]</span>
<span class="gp">&gt;&gt; </span><span class="n">b</span>
<span class="go">=&gt; [1, 2, 3]</span>
</pre></div>
</div>


<p>(This is known as a “shallow copy”. Making a “deep copy” is a much more difficult problem, and in fact has no general solution, but dropping “ruby deep copy” into a search engine should be enough to get you started if you need to copy a more complicated structure such as a nested array.) Applying the <code>dup</code> method to the user’s microposts gives us code like this:</p>

<div class="code"><div class="highlight"><pre><span class="n">microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">dup</span>
<span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
<span class="n">microposts</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_empty</span>
<span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
  <span class="c1"># Make sure the micropost doesn't appear in the database.</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Here we’ve included the line</p>

<div class="code"><div class="highlight"><pre><span class="n">microposts</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_empty</span>
</pre></div>
</div>


<p>as a safety check to catch any errors should the <code>dup</code> ever be accidentally removed.<sup class="footnote" id="fnref-10_3"><a href="http://ruby.railstutorial.org/chapters/user-microposts#fn-10_3">3</a></sup> The full implementation appears in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_dependency_test">Listing&nbsp;10.15</a>.</p>

<div class="label" id="code-micropost_dependency_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.15.</span> <span class="description">Testing that microposts are destroyed when users are. <br> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"micropost associations"</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span> 
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="s2">"should destroy associated microposts"</span> <span class="k">do</span>
      <span class="n">microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">dup</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
      <span class="n">microposts</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_empty</span>
      <span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
        <span class="no">Micropost</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_nil</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here we have used <code>Micropost.find_by_id</code>, which returns <code>nil</code> if the record is not found, whereas <code>Micropost.find</code> raises an exception on failure, which is a bit harder to test for. (In case you’re curious,</p>

<div class="code"><div class="highlight"><pre><span class="nb">lambda</span> <span class="k">do</span> 
  <span class="no">Micropost</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">raise_error</span><span class="p">(</span><span class="ss">ActiveRecord::RecordNotFound</span><span class="p">)</span>
</pre></div>
</div>


<p>does the trick in this case.)</p>

<p>The application code to get <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_dependency_test">Listing&nbsp;10.15</a> to pass is less than one line; in fact, it’s just an option to the <code>has_many</code> association method, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_dependency">Listing&nbsp;10.16</a>.</p>

<div class="label" id="code-micropost_dependency"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.16.</span> <span class="description">Ensuring that a user’s microposts are destroyed along with the user. <br> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="n">has_secure_password</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here the option <code>dependent: :destroy</code> in</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
</pre></div>
</div>


<p>arranges for the dependent microposts (i.e., the ones belonging to the given user) to be destroyed when the user itself is destroyed. This prevents userless microposts from being stranded in the database when admins choose to remove users from the system.</p>

<p>With that, the final form of the user/micropost association is in place, and all the tests should be passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-micropost_validations"></div>


<h3><a id="sec-10_1_5" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-micropost_validations" class="heading"><span class="number">10.1.5</span> Content validations</a></h3>


<p>Before leaving the Micropost model, we’ll add validations for the micropost <code>content</code>  (following the example from <a class="ref" href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-putting_the_micro_in_microposts">Section&nbsp;2.3.2</a>). Like the <code>user_id</code>, the <code>content</code> attribute must be present, and it is further constrained to be no longer than 140 characters, making it an honest <em>micro</em>post. The tests generally follow the examples from the User model validation tests in <a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-users#sec-user_validations">Section&nbsp;6.2</a>, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_validations_tests">Listing&nbsp;10.17</a>.</p>

<div class="label" id="code-micropost_validations_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.17.</span> <span class="description">Tests for the Micropost model validations. <br> <code>spec/models/micropost_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">"Lorem ipsum"</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"when user_id is not present"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"with blank content"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s2">" "</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"with content that is too long"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s2">"a"</span> <span class="o">*</span> <span class="mi">141</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As in <a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-users#sec-user_validations">Section&nbsp;6.2</a>, the code in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_validations_tests">Listing&nbsp;10.17</a> uses string multiplication to test the micropost length validation:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails console
<span class="gp">&gt;</span>&gt; <span class="s2">"a"</span> * 10
<span class="go">=&gt; "aaaaaaaaaa"</span>
<span class="gp">&gt;</span>&gt; <span class="s2">"a"</span> * 141
<span class="go">=&gt; "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span>
<span class="go">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"</span>
</pre></div>
</div>


<p>The application code is a one-liner:</p>

<div class="code"><div class="highlight"><pre><span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">140</span> <span class="p">}</span>
</pre></div>
</div>


<p>The resulting Micropost model is shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_validations">Listing&nbsp;10.18</a>.</p>

<div class="label" id="code-micropost_validations"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.18.</span> <span class="description">The Micropost model validations. <br> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span>

  <span class="n">belongs_to</span> <span class="ss">:user</span>

  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">140</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>

  <span class="n">default_scope</span> <span class="ss">order:</span> <span class="s1">'microposts.created_at DESC'</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-showing_microposts"></div>


<h2><a id="sec-10_2" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-showing_microposts" class="heading"><span class="number">10.2</span> Showing microposts</a></h2>


<p>Although we don’t yet have a way to create microposts through the web—that comes in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-creating_microposts">Section&nbsp;10.3.2</a>—that won’t stop us from displaying them (and testing that display). Following Twitter’s lead, we’ll plan to display a user’s microposts not on a separate microposts <code>index</code> page, but rather directly on the user <code>show</code> page itself, as mocked up in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig-user_microposts_mockup">Figure&nbsp;10.4</a>. We’ll start with fairly simple ERb templates for adding a micropost display to the user profile, and then we’ll add microposts to the sample data populator from <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-sample_users">Section&nbsp;9.3.2</a> so that we have something to display.</p>

<div class="label" id="fig-user_microposts_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/user_microposts_mockup_bootstrap.png" alt="user_microposts_mockup_bootstrap"></span></div><div class="caption"><span class="header">Figure 10.4: </span><span class="description">A mockup of a profile page with microposts.&nbsp;<a href="http://railstutorial.org/images/figures/user_microposts_mockup_bootstrap-full.png">(full size)</a></span></div></div>


<p>As with the discussion of the signin machinery in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-remember_me">Section&nbsp;8.2.1</a>, <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-augmenting_the_user_show_page">Section&nbsp;10.2.1</a> will often push several elements onto the <a href="http://en.wikipedia.org/wiki/Stack_(data_structure)">stack</a> at a time, and then pop them off one by one. If you start getting bogged down, be patient; there’s some nice payoff in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-sample_microposts">Section&nbsp;10.2.2</a>.</p>

<div class="label" id="sec-augmenting_the_user_show_page"></div>


<h3><a id="sec-10_2_1" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-augmenting_the_user_show_page" class="heading"><span class="number">10.2.1</span> Augmenting the user show page</a></h3>


<p>We begin with tests for displaying the user’s microposts, which we’ll create in the request spec for Users. Our strategy is to create a couple of factory microposts associated with the user, and then verify that the show page contains each post’s content. We’ll also verify that, as in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig-user_microposts_mockup">Figure&nbsp;10.4</a>, the total number of microposts also gets displayed.</p>

<p>We can create the posts with the <code>let</code> method, but as in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_ordering_test">Listing&nbsp;10.13</a> we want the association to exist immediately so that the posts appear on the user show page. To accomplish this, we use the <code>let!</code> variant:</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">let!</span><span class="p">(</span><span class="ss">:m1</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">"Foo"</span><span class="p">)</span> <span class="p">}</span>
<span class="n">let!</span><span class="p">(</span><span class="ss">:m2</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">"Bar"</span><span class="p">)</span> <span class="p">}</span>

<span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>With the microposts so defined, we can test for their appearance on the profile page using the code in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-user_show_microposts_test">Listing&nbsp;10.19</a>.</p>

<div class="label" id="code-user_show_microposts_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.19.</span> <span class="description">A test for showing microposts on the user <code>show</code> page. <br> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"profile page"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:m1</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">"Foo"</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:m2</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">"Bar"</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'h1'</span><span class="p">,</span>    <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"microposts"</span> <span class="k">do</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">m1</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">m2</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note here that we can use the <code>count</code> method <em>through</em> the association:</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>


<p>The association <code>count</code> method is smart, and performs the count directly in the database. In particular, it does <em>not</em> pull all the microposts out of the database and then call <code>length</code> on the resulting array, as this could become inefficient as the number of microposts grew. Instead, it asks the database to count the microposts with the given <code>user_id</code>. In the unlikely event that finding the count is still a bottleneck in your application, you can make it even faster with a <a href="http://railscasts.com/episodes/23-counter-cache-column"><em>counter cache</em></a>.</p>

<p>Although the tests in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-user_show_microposts_test">Listing&nbsp;10.19</a> won’t pass until <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_partial">Listing&nbsp;10.21</a>, we’ll get started on the application code by inserting a list of microposts into the user profile page, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-user_show_microposts">Listing&nbsp;10.20</a>.</p>

<div class="label" id="code-user_show_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.20.</span> <span class="description">Adding microposts to the user <code>show</code> page. <br> <code>app/views/users/show.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  .
  .
  .
  <span class="nt">&lt;aside&gt;</span>
    .
    .
    .
  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span8"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Microposts (<span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>)<span class="nt">&lt;/h3&gt;</span>
      <span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">"microposts"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ol&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>We’ll deal with the microposts list momentarily, but there are several other things to note first. In <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-user_show_microposts">Listing&nbsp;10.20</a>, the use of <code>if @user.microposts.any?</code> (a construction we saw before in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#code-errors_partial">Listing&nbsp;7.23</a>) makes sure that an empty list won’t be displayed when the user has no microposts.</p>

<p>Also note from <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-user_show_microposts">Listing&nbsp;10.20</a> that we’ve preemptively added pagination for microposts through</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>If you compare this with the analogous line on the user index page, <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#code-will_paginate_index_view">Listing&nbsp;9.34</a>, you’ll see that before we had just</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>This worked because, in the context of the Users controller, <code>will_paginate</code> <em>assumes</em> the existence of an instance variable called <code>@users</code> (which, as we saw in <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-pagination">Section&nbsp;9.3.3</a>, should be of class <code>ActiveRecord::Relation</code>). In the present case, since we are still in the Users controller but want to paginate <em>microposts</em> instead, we pass an explicit <code>@microposts</code> variable to <code>will_paginate</code>. Of course, this means that we will have to define such a variable in the user <code>show</code> action (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-user_show_microposts_instance">Listing&nbsp;10.22</a>).</p>

<p>Finally, note that we have taken this opportunity to add a count of the current number of microposts:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h3&gt;</span>Microposts (<span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>)<span class="nt">&lt;/h3&gt;</span>
</pre></div>
</div>


<p>As noted, <code>@user.microposts.count</code> is the analogue of the <code>User.count</code> method, except that it counts the microposts belonging to a given user through the user/micropost association.</p>

<p>We come finally to the micropost list itself:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">"microposts"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ol&gt;</span>
</pre></div>
</div>


<p>This code, which uses the <em>ordered list</em> tag&nbsp;<code>ol</code>, is responsible for generating the list of microposts, but you can see that it just defers the heavy lifting to a micropost partial. We saw in <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-partial_refactoring">Section&nbsp;9.3.4</a> that the code</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>automatically renders each of the users in the <code>@users</code> variable using the <code>_user.html.erb</code> partial. Similarly, the code</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>does exactly the same thing for microposts. This means that we must define a <code>_micropost.html.erb</code> partial (along with a <code>micropost</code> views directory), as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_partial">Listing&nbsp;10.21</a>.</p>

<div class="label" id="code-micropost_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.21.</span> <span class="description">A partial for showing a single micropost. <br> <code>app/views/microposts/_micropost.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"timestamp"</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p>This uses the awesome <code>time_ago_in_words</code> helper method, whose effect we will see in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-sample_microposts">Section&nbsp;10.2.2</a>.</p>

<p>Thus far, despite defining all the relevant ERb templates, the test in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-user_show_microposts_test">Listing&nbsp;10.19</a> should have been failing for want of an <code>@microposts</code> variable. We can get it to pass with <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-user_show_microposts_instance">Listing&nbsp;10.22</a>.</p>

<div class="label" id="code-user_show_microposts_instance"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.22.</span> <span class="description">Adding an <code>@microposts</code> instance variable to the user <code>show</code> action. <br> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Notice here how clever <code>paginate</code> is—it even works through the microposts association, reaching into the <tt>microposts</tt> table and pulling out the desired page of microposts.</p>

<p>At this point, we can get a look at our new user profile page in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig-user_profile_no_microposts">Figure&nbsp;10.5</a>. It’s rather… disappointing. Of course, this is because there are not currently any microposts. It’s time to change that.</p>

<div class="label" id="fig-user_profile_no_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/user_profile_no_microposts_bootstrap.png" alt="user_profile_no_microposts_bootstrap"></span></div><div class="caption"><span class="header">Figure 10.5: </span><span class="description">The user profile page with code for microposts—but no microposts.&nbsp;<a href="http://railstutorial.org/images/figures/user_profile_no_microposts_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec-sample_microposts"></div>


<h3><a id="sec-10_2_2" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-sample_microposts" class="heading"><span class="number">10.2.2</span> Sample microposts</a></h3>


<p>With all the work making templates for user microposts in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-augmenting_the_user_show_page">Section&nbsp;10.2.1</a>, the ending was rather anticlimactic. We can rectify this sad situation by adding microposts to the sample populator from <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-sample_users">Section&nbsp;9.3.2</a>. Adding sample microposts for <em>all</em> the users actually takes a rather long time, so first we’ll select just the first six users<sup class="footnote" id="fnref-10_4"><a href="http://ruby.railstutorial.org/chapters/user-microposts#fn-10_4">4</a></sup> using the <code>:limit</code> option to the <code>User.all</code> method:<sup class="footnote" id="fnref-10_5"><a href="http://ruby.railstutorial.org/chapters/user-microposts#fn-10_5">5</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">limit:</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>


<p>We then make 50 microposts for each user (plenty to overflow the pagination limit of&nbsp;30), generating sample content for each micropost using the Faker gem’s handy <a href="http://faker.rubyforge.org/rdoc/classes/Faker/Lorem.html"><tt>Lorem.sentence</tt> method</a>. (<code>Faker::Lorem.sentence</code> returns <em>lorem ipsum</em> text; as noted in <a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-users#top">Chapter&nbsp;6</a>, <em>lorem ipsum</em> has a <a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean">fascinating back story</a>.) The result is the new sample data populator shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-sample_microposts">Listing&nbsp;10.23</a>.</p>

<div class="label" id="code-sample_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.23.</span> <span class="description">Adding microposts to the sample data. <br> <code>lib/tasks/sample_data.rake</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">"Fill database with sample data"</span>
  <span class="n">task</span> <span class="ss">populate:</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">limit:</span> <span class="mi">6</span><span class="p">)</span>
    <span class="mi">50</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
      <span class="n">content</span> <span class="o">=</span> <span class="ss">Faker::Lorem</span><span class="o">.</span><span class="n">sentence</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
      <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content:</span> <span class="n">content</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Of course, to generate the new sample data we have to run the <code>db:populate</code> Rake task:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>With that, we are in a position to enjoy the fruits of our <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-augmenting_the_user_show_page">Section&nbsp;10.2.1</a> labors by displaying information for each micropost.<sup class="footnote" id="fnref-10_6"><a href="http://ruby.railstutorial.org/chapters/user-microposts#fn-10_6">6</a></sup> The preliminary results appear in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig-user_profile_microposts_no_styling">Figure&nbsp;10.6</a>.</p>

<div class="label" id="fig-user_profile_microposts_no_styling"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/user_profile_microposts_no_styling_bootstrap.png" alt="user_profile_microposts_no_styling_bootstrap"></span></div><div class="caption"><span class="header">Figure 10.6: </span><span class="description">The user profile (<a href="http://localhost:3000/users/1">/users/1</a>) with unstyled microposts.&nbsp;<a href="http://railstutorial.org/images/figures/user_profile_microposts_no_styling_bootstrap-full.png">(full size)</a></span></div></div>


<p>The page shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig-user_profile_microposts_no_styling">Figure&nbsp;10.6</a> has no micropost-specific styling, so let’s add some (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_css">Listing&nbsp;10.24</a>) and take a look the resulting pages.<sup class="footnote" id="fnref-10_7"><a href="http://ruby.railstutorial.org/chapters/user-microposts#fn-10_7">7</a></sup> <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig-user_profile_with_microposts">Figure&nbsp;10.7</a>, which displays the user profile page for the first (signed-in) user, while <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig-other_profile_with_microposts">Figure&nbsp;10.8</a> shows the profile for a second user. Finally, <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig-user_profile_microposts_page_2_rails_3">Figure&nbsp;10.9</a> shows the <em>second</em> page of microposts for the first user, along with the pagination links at the bottom of the display. In all three cases, observe that each micropost display indicates the time since it was created (e.g., “Posted 1 minute ago.”); this is the work of the <code>time_ago_in_words</code> method from <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_partial">Listing&nbsp;10.21</a>. If you wait a couple minutes and reload the pages, you’ll see how the text gets automatically updated based on the new time.</p>

<div class="label" id="code-micropost_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.24.</span> <span class="description">The CSS for microposts (including all the CSS for this chapter). <br> <code>app/assets/stylesheets/custom.css.scss</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">microposts</span> <span class="o">*/</span>

<span class="nc">.microposts</span> <span class="p">{</span>
  <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
  <span class="na">margin</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">;</span>

  <span class="nt">li</span> <span class="p">{</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="mh">#e8e8e8</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nc">.content</span> <span class="p">{</span>
  <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.timestamp</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$grayLight</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.gravatar</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">aside</span> <span class="p">{</span>
  <span class="nt">textarea</span> <span class="p">{</span>
    <span class="na">height</span><span class="o">:</span> <span class="mi">100</span><span class="kt">px</span><span class="p">;</span>
    <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig-user_profile_with_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/user_profile_with_microposts_bootstrap.png" alt="user_profile_with_microposts_bootstrap"></span></div><div class="caption"><span class="header">Figure 10.7: </span><span class="description">The user profile (<a href="http://localhost:3000/users/1">/users/1</a>) with microposts.&nbsp;<a href="http://railstutorial.org/images/figures/user_profile_with_microposts_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="fig-other_profile_with_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/other_profile_with_microposts_bootstrap.png" alt="other_profile_with_microposts_bootstrap"></span></div><div class="caption"><span class="header">Figure 10.8: </span><span class="description">The profile of a different user, also with microposts (<a href="http://localhost:3000/users/5">/users/5</a>).&nbsp;<a href="http://railstutorial.org/images/figures/other_profile_with_microposts_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="fig-user_profile_microposts_page_2_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/user_profile_microposts_page_2_rails_3_bootstrap.png" alt="user_profile_microposts_page_2_rails_3_bootstrap"></span></div><div class="caption"><span class="header">Figure 10.9: </span><span class="description">Micropost pagination links (<a href="http://localhost:3000/users/1?page=2">/users/1?page=2</a>).&nbsp;<a href="http://railstutorial.org/images/figures/user_profile_microposts_page_2_rails_3_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec-manipulating_microposts"></div>


<h2><a id="sec-10_3" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-manipulating_microposts" class="heading"><span class="number">10.3</span> Manipulating microposts</a></h2>


<p>Having finished both the data modeling and display templates for microposts, we now turn our attention to the interface for creating them through the web. The result will be our third example of using an HTML form to create a resource—in this case, a Microposts resource.<sup class="footnote" id="fnref-10_8"><a href="http://ruby.railstutorial.org/chapters/user-microposts#fn-10_8">8</a></sup> In this section, we’ll also see the first hint of a <em>status feed</em>—a notion brought to full fruition in <a class="ref" href="http://ruby.railstutorial.org/chapters/following-users#top">Chapter&nbsp;11</a>. Finally, as with users, we’ll make it possible to destroy microposts through the web.</p>

<p>There is one break with past convention worth noting: the interface to the Microposts resource will run principally through the Users and StaticPages controllers, so we won’t need actions like <code>new</code> or <code>edit</code> in the Microposts controller; we’ll only need <code>create</code> and <code>destroy</code>. This means that the routes for the Microposts resource are unusually simple, as seen in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-microposts_resource">Listing&nbsp;10.25</a>. The code in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-microposts_resource">Listing&nbsp;10.25</a> leads in turn to the RESTful routes shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#table-RESTful_microposts">Table&nbsp;10.2</a>, which is a small subset of the full set of routes seen in <a class="ref" href="http://ruby.railstutorial.org/chapters/a-demo-app#table-demo_RESTful_microposts">Table&nbsp;2.3</a>. Of course, this simplicity is a sign of being <em>more</em> advanced, not less—we’ve come a long way since our reliance on scaffolding in <a class="ref" href="http://ruby.railstutorial.org/chapters/a-demo-app#top">Chapter&nbsp;2</a>, and we no longer need most of its complexity.</p>

<div class="label" id="code-microposts_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.25.</span> <span class="description">Routes for the Microposts resource. <br> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span>   <span class="ss">only:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="table-RESTful_microposts"></div>


<div class="table"><div class="center">
<table class="tabular"><tbody><tr><th class="align_left"><strong>HTTP request</strong></th><th class="align_left"><strong>URI</strong></th><th class="align_left"><strong>Action</strong></th><th class="align_left"><strong>Purpose</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>POST</tt></td><td class="align_left">/microposts</td><td class="align_left"><code>create</code></td><td class="align_left">create a new micropost</td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left">/microposts/1</td><td class="align_left"><code>destroy</code></td><td class="align_left">delete micropost with id <code>1</code></td></tr></tbody></table></div><div class="caption"><span class="header">Table 10.2: </span><span class="description">RESTful routes provided by the Microposts resource in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-microposts_resource">Listing&nbsp;10.25</a>.</span></div></div>




<div class="label" id="sec-access_control"></div>


<h3><a id="sec-10_3_1" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-access_control" class="heading"><span class="number">10.3.1</span> Access control</a></h3>


<p>We begin our development of the Microposts resource with some access control in the Microposts controller. The idea is simple: both the <code>create</code> and <code>destroy</code> actions should require users to be signed in. The RSpec code to test for this appears in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_access_control">Listing&nbsp;10.26</a>. (We’ll test for and add a third protection—ensuring that only a micropost’s user can destroy it—in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-destroying_microposts">Section&nbsp;10.3.4</a>.)</p>

<div class="label" id="code-micropost_access_control"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.26.</span> <span class="description">Access control tests for microposts. <br> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">"for non-signed-in users"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">"in the Microposts controller"</span> <span class="k">do</span>

        <span class="n">describe</span> <span class="s2">"submitting to the create action"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">post</span> <span class="n">microposts_path</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">"submitting to the destroy action"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">micropost_path</span><span class="p">(</span><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">))</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Rather than using the (yet-to-be-built) web interface for microposts, the code in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_access_control">Listing&nbsp;10.26</a> operates at the level of the individual micropost actions, a strategy we first saw in <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#code-edit_update_wrong_user_tests">Listing&nbsp;9.14</a>. In this case, a non-signed-in user is redirected upon submitting a <tt>POST</tt> request to /microposts (<code>post microposts_path</code>, which hits the <code>create</code> action) or submitting a <tt>DELETE</tt> request to /microposts/1 (<code>delete micropost_path(micropost)</code>, which hits the <code>destroy</code> action).</p>

<p>Writing the application code needed to get the tests in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_access_control">Listing&nbsp;10.26</a> to pass requires a little refactoring first. Recall from <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-requiring_signed_in_users">Section&nbsp;9.2.1</a> that we enforced the signin requirement using a before filter that called the <code>signed_in_user</code> method (<a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#code-authorize_before_filter">Listing&nbsp;9.12</a>). At the time, we only needed that method in the Users controller, but now we find that we need it in the Microposts controller as well, so we’ll move it into the Sessions helper, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-sessions_helper_authenticate">Listing&nbsp;10.27</a>.<sup class="footnote" id="fnref-10_9"><a href="http://ruby.railstutorial.org/chapters/user-microposts#fn-10_9">9</a></sup></p>

<div class="label" id="code-sessions_helper_authenticate"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.27.</span> <span class="description">Moving the <code>signed_in_user</code> method into the Sessions helper. <br> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">==</span> <span class="n">current_user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">signed_in_user</span>
    <span class="k">unless</span> <span class="n">signed_in?</span>
      <span class="n">store_location</span>
      <span class="n">redirect_to</span> <span class="n">signin_url</span><span class="p">,</span> <span class="ss">notice:</span> <span class="s2">"Please sign in."</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>To avoid code repetition, you should also remove <code>signed_in_user</code> from the Users controller at this time.</p>

<p>With the code in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-sessions_helper_authenticate">Listing&nbsp;10.27</a>, the <code>signed_in_user</code> method is now available in the Microposts controller, which means that we can restrict access to the <code>create</code> and <code>destroy</code> actions with the before filter shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-microposts_controller_access_control">Listing&nbsp;10.28</a>. (Since we didn’t generate it at the command line, you will have to create the Microposts controller file by hand.)</p>

<div class="label" id="code-microposts_controller_access_control"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.28.</span> <span class="description">Adding authentication to the Microposts controller actions. <br> <code>app/controllers/microposts_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that we haven’t restricted the actions the before filter applies to since it applies to them both by default. If we were to add, say, an <code>index</code> action accessible even to non-signed-in users, we would need to specify the protected actions explicitly:</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">index</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>At this point, the tests should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb
</pre></div>
</div>




<div class="label" id="sec-creating_microposts"></div>


<h3><a id="sec-10_3_2" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-creating_microposts" class="heading"><span class="number">10.3.2</span> Creating microposts</a></h3>


<p>In <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#top">Chapter&nbsp;7</a>, we implemented user signup by making an HTML form that issued an HTTP <tt>POST</tt> request to the <code>create</code> action in the Users controller. The implementation of micropost creation is similar; the main difference is that, rather than using a separate page at /microposts/new, we will (following Twitter’s convention) put the form on the Home page itself (i.e., the root path&nbsp;/), as mocked up in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig-home_page_with_micropost_form_mockup">Figure&nbsp;10.10</a>.</p>

<div class="label" id="fig-home_page_with_micropost_form_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/home_page_with_micropost_form_mockup_bootstrap.png" alt="home_page_with_micropost_form_mockup_bootstrap"></span></div><div class="caption"><span class="header">Figure 10.10: </span><span class="description">A mockup of the Home page with a form for creating microposts.&nbsp;<a href="http://railstutorial.org/images/figures/home_page_with_micropost_form_mockup_bootstrap-full.png">(full size)</a></span></div></div>


<p>When we last left the Home page, it appeared as in <a class="ref" href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#fig-sample_app_logo">Figure&nbsp;5.6</a>—that is, it had a “Sign up now!” button in the middle. Since a micropost creation form only makes sense in the context of a particular signed-in user, one goal of this section will be to serve different versions of the Home page depending on a visitor’s signin status. We’ll implement this in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-microposts_home_page">Listing&nbsp;10.31</a> below, but we can still write the tests now. As with the Users resource, we’ll use an integration test:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test micropost_pages
</pre></div>
</div>


<p>The micropost creation tests then parallel those for user creation from <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#code-basic_signup_tests">Listing&nbsp;7.16</a>; the result appears in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-microposts_create_tests">Listing&nbsp;10.29</a>.</p>

<div class="label" id="code-microposts_create_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.29.</span> <span class="description">Tests for creating microposts. <br> <code>spec/requests/micropost_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Micropost pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"micropost creation"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"with invalid information"</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">"should not create a micropost"</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Post"</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">"error messages"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Post"</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'error'</span><span class="p">)</span> <span class="p">}</span> 
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>

      <span class="n">before</span> <span class="p">{</span> <span class="n">fill_in</span> <span class="s1">'micropost_content'</span><span class="p">,</span> <span class="ss">with:</span> <span class="s2">"Lorem ipsum"</span> <span class="p">}</span>
      <span class="n">it</span> <span class="s2">"should create a micropost"</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Post"</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>We’ll start with the <code>create</code> action for microposts, which is similar to its user analogue (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#code-user_create_action">Listing&nbsp;7.25</a>); the principal difference lies in using the user/micropost association to <code>build</code> the new micropost, as seen in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-microposts_create_action">Listing&nbsp;10.30</a>.</p>

<div class="label" id="code-microposts_create_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.30.</span> <span class="description">The Microposts controller <code>create</code> action. <br> <code>app/controllers/microposts_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:micropost</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Micropost created!"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'static_pages/home'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>To build a form for creating microposts, we use the code in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-microposts_home_page">Listing&nbsp;10.31</a>, which serves up different HTML based on whether the site visitor is signed in or not.</p>

<div class="label" id="code-microposts_home_page"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.31.</span> <span class="description">Adding microposts creation to the Home page (<a href="http://localhost:3000/">/</a>). <br> <code>app/views/static_pages/home.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"span4"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/user_info'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/micropost_form'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;/div&gt;</span>  
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"center hero-unit"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Welcome to the Sample App<span class="nt">&lt;/h1&gt;</span>

    <span class="nt">&lt;h2&gt;</span>
      This is the home page for the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      sample application.
    <span class="nt">&lt;/h2&gt;</span>

    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up now!"</span><span class="p">,</span> <span class="n">signup_path</span><span class="p">,</span> 
                                <span class="ss">class:</span> <span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">image_tag</span><span class="p">(</span><span class="s2">"rails.png"</span><span class="p">,</span> <span class="ss">alt:</span> <span class="s2">"Rails"</span><span class="p">),</span> <span class="s1">'http://rubyonrails.org/'</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span> 
</pre></div>
</div></div>


<p>Having so much code in each branch of the <code>if</code>-<code>else</code> conditional is a bit messy, and cleaning it up using partials is left as an exercise (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-micropost_exercises">Section&nbsp;10.5</a>). Filling in the necessary partials from <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-microposts_home_page">Listing&nbsp;10.31</a> isn’t an exercise, though; we fill in the new Home page sidebar in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-user_info">Listing&nbsp;10.32</a>
and the micropost form partial in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_form">Listing&nbsp;10.33</a>.</p>

<div class="label" id="code-user_info"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.32.</span> <span class="description">The partial for the user info sidebar. <br> <code>app/views/shared/_user_info.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">current_user</span><span class="p">,</span> <span class="ss">size:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;h1&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;span&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"view my profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">"micropost"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/span&gt;</span>
</pre></div>
</div></div>


<p>As in <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#code-user_index_view">Listing&nbsp;9.25</a>, the code in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-user_info">Listing&nbsp;10.32</a> uses the version of the <code>gravatar_for</code> helper defined in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#code-gravatar_option">Listing&nbsp;7.29</a>.</p>

<p>Note that, as in the profile sidebar (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-user_show_microposts">Listing&nbsp;10.20</a>), the user info in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-user_info">Listing&nbsp;10.32</a> displays the total number of microposts for the user. There’s a slight difference in the display, though; in the profile sidebar, “Microposts” is a label, and showing “Microposts (1)” makes sense. In the present case, though, saying “1 microposts” is ungrammatical, so we arrange to display “1 micropost” (but “2 microposts”) using <code>pluralize</code>.</p>

<p>We next define the form for creating microposts (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_form">Listing&nbsp;10.33</a>), which is similar to the signup form in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#code-signup_form">Listing&nbsp;7.17</a>.</p>

<div class="label" id="code-micropost_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.33.</span> <span class="description">The form partial for creating microposts. <br> <code>app/views/shared/_micropost_form.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@micropost</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_area</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">placeholder:</span> <span class="s2">"Compose new micropost..."</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Post"</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>We need to make two changes before the form in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_form">Listing&nbsp;10.33</a> will work. First, we need to define <code>@micropost</code>, which (as before) we do through the association:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
</pre></div>
</div>


<p>The result appears in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_instance_variable">Listing&nbsp;10.34</a>.</p>

<div class="label" id="code-micropost_instance_variable"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.34.</span> <span class="description">Adding a micropost instance variable to the <code>home</code> action. <br> <code>app/controllers/static_pages_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span> <span class="k">if</span> <span class="n">signed_in?</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The code in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_instance_variable">Listing&nbsp;10.34</a> has the advantage that it will break the test suite if we forget to require the user to sign in.</p>

<p>The second change needed to get <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_form">Listing&nbsp;10.33</a> to work is to redefine the error messages partial so that</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>works. You may recall from <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#code-f_error_messages">Listing&nbsp;7.22</a> that the error messages partial references the <code>@user</code> variable explicitly, but in the present case we have an <code>@micropost</code> variable instead. We should define an error messages partial that works regardless of the kind of object passed to it. Happily, the form variable&nbsp;<code>f</code> can access the associated object through <code>f.object</code>, so that in</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</pre></div>
</div>


<p><code>f.object</code> is <code>@user</code>, and in</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@micropost</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</pre></div>
</div>


<p><code>f.object</code> is <code>@micropost</code>.</p>

<p>To pass the object to the partial, we use a hash with value equal to the object and key equal to the desired name of the variable in the partial, which is what this code accomplishes:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>In other words, <code>object: f.object</code> creates a variable called <code>object</code> in the <code>error_messages</code> partial. We can use this object to construct a customized error message, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-updated_error_messages_partial">Listing&nbsp;10.35</a>.</p>

<div class="label" id="code-updated_error_messages_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.35.</span> <span class="description">Updating the error-messages partial from <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#code-errors_partial">Listing&nbsp;7.23</a> to work with other objects. <br> <code>app/views/shared/_error_messages.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"error_explanation"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-error"</span><span class="nt">&gt;</span>
      The form contains <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">)</span> <span class="cp">%&gt;</span>.
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
    <span class="cp">&lt;%</span> <span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span>* <span class="cp">&lt;%=</span> <span class="n">msg</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>As this point, the tests in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-microposts_create_tests">Listing&nbsp;10.29</a> should be passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/micropost_pages_spec.rb
</pre></div>
</div>


<p>Unfortunately, the User request spec is now broken because the signup and edit forms use the old version of the error messages partial. To fix them, we’ll update them with the more general version, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-signup_errors_updated">Listing&nbsp;10.36</a> and <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-edit_errors_updated">Listing&nbsp;10.37</a>. (<em>Note</em>: Your code will differ if you implemented <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#code-new_edit_partial">Listing&nbsp;9.50</a> and <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#code-new_user_with_partial">Listing&nbsp;9.51</a> from the exercises in <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-updating_deleting_exercises">Section&nbsp;9.6</a>. <a href="http://en.wikipedia.org/wiki/Mutatis_mutandis"><em>Mutatis mutandis</em>.</a>)</p>

<div class="label" id="code-signup_errors_updated"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.36.</span> <span class="description">Updating the rendering of user signup errors. <br> <code>app/views/users/new.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Sign up'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span6 offset3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
      .
      .
      .
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code-edit_errors_updated"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.37.</span> <span class="description">Updating the errors for editing users. <br> <code>app/views/users/edit.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Edit user"</span><span class="p">)</span> <span class="cp">%&gt;</span> 
<span class="nt">&lt;h1&gt;</span>Update your profile<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span6 offset3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
      .
      .
      .
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://gravatar.com/emails"</span><span class="nt">&gt;</span>change<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>At this point, all the tests should be passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>Additionally, all the HTML in this section should render properly, showing the form as in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig-home_with_form">Figure&nbsp;10.11</a>, and a form with a submission error as in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig-home_form_errors">Figure&nbsp;10.12</a>. You are invited at this point to create a new post for yourself and verify that everything is working—but you should probably wait until after <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-a_proto_feed">Section&nbsp;10.3.3</a>.</p>

<div class="label" id="fig-home_with_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/home_with_form_bootstrap.png" alt="home_with_form_bootstrap"></span></div><div class="caption"><span class="header">Figure 10.11: </span><span class="description">The Home page (<a href="http://localhost:3000/">/</a>) with a new micropost form.&nbsp;<a href="http://railstutorial.org/images/figures/home_with_form_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="fig-home_form_errors"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/home_form_errors_bootstrap.png" alt="home_form_errors_bootstrap"></span></div><div class="caption"><span class="header">Figure 10.12: </span><span class="description">The home page with form errors.&nbsp;<a href="http://railstutorial.org/images/figures/home_form_errors_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec-a_proto_feed"></div>


<h3><a id="sec-10_3_3" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-a_proto_feed" class="heading"><span class="number">10.3.3</span> A proto-feed</a></h3>


<p>The comment at the end of <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-creating_microposts">Section&nbsp;10.3.2</a> alluded to a problem: the current Home page doesn’t display any microposts. If you like, you can verify that the form shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig-home_with_form">Figure&nbsp;10.11</a> is working by submitting a valid entry and then navigating to the <a href="http://localhost:3000/users/1">profile page</a> to see the post, but that’s rather cumbersome. It would be far better to have a <em>feed</em> of microposts that includes the user’s own posts, as mocked up in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig-proto_feed_mockup">Figure&nbsp;10.13</a>. (In <a class="ref" href="http://ruby.railstutorial.org/chapters/following-users#top">Chapter&nbsp;11</a>, we’ll generalize this feed to include the microposts of users being <em>followed</em> by the current user.)</p>

<div class="label" id="fig-proto_feed_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/proto_feed_mockup_bootstrap.png" alt="proto_feed_mockup_bootstrap"></span></div><div class="caption"><span class="header">Figure 10.13: </span><span class="description">A mockup of the Home page with a proto-feed.&nbsp;<a href="http://railstutorial.org/images/figures/proto_feed_mockup_bootstrap-full.png">(full size)</a></span></div></div>


<p>Since each user should have a feed, we are led naturally to a <code>feed</code> method in the User model. Eventually, we will test that the feed returns the microposts of the users being followed, but for now we’ll just test that the <code>feed</code> method <em>includes</em> the current user’s microposts but <em>excludes</em> the posts of a different user. We can express these requirements in code with <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-feed_specs">Listing&nbsp;10.38</a>.</p>

<div class="label" id="code-feed_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.38.</span> <span class="description">Tests for the (proto-)status feed. <br> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:microposts</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"micropost associations"</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span> 
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"status"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:unfollowed_post</span><span class="p">)</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
      <span class="k">end</span>

      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">newer_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">older_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="kp">include</span><span class="p">(</span><span class="n">unfollowed_post</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>These tests introduce (via the RSpec boolean convention) the array <code>include?</code> method, which simply checks if an array includes the given element:<sup class="footnote" id="fnref-10_10"><a href="http://ruby.railstutorial.org/chapters/user-microposts#fn-10_10">10</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"foo"</span><span class="p">,</span> <span class="ss">:bar</span><span class="o">]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="ss">:bar</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">"baz"</span><span class="p">)</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>This example shows just how flexible the RSpec boolean convention is; even though <code>include</code> is already a Ruby keyword (used to include a module, as seen in, e.g., <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-sessions_helper_include">Listing&nbsp;8.14</a>), in this context RSpec correctly guesses that we want to test array inclusion.</p>

<p>We can arrange for an appropriate micropost <code>feed</code> method by selecting all the microposts with <code>user_id</code> equal to the current user’s id, which we accomplish using the <code>where</code> method on the <code>Micropost</code> model, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-proto_status_feed">Listing&nbsp;10.39</a>.<sup class="footnote" id="fnref-10_11"><a href="http://ruby.railstutorial.org/chapters/user-microposts#fn-10_11">11</a></sup></p>

<div class="label" id="code-proto_status_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.39.</span> <span class="description">A preliminary implementation for the micropost status feed. <br> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="c1"># This is preliminary. See "Following users" for the full implementation.</span>
    <span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id = ?"</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The question mark in</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id = ?"</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div>
</div>


<p>ensures that <code>id</code>&nbsp;is properly <em>escaped</em> before being included in the underlying SQL query, thereby avoiding a serious security hole called <a href="http://en.wikipedia.org/wiki/SQL_injection"><em>SQL injection</em></a>. The&nbsp;<code>id</code> attribute here is just an integer, so there is no danger in this case, but <em>always</em> escaping variables injected into SQL statements is a good habit to cultivate.</p>

<p>Alert readers might note at this point that the code in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-proto_status_feed">Listing&nbsp;10.39</a> is essentially equivalent to writing</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">feed</span>
  <span class="n">microposts</span>
<span class="k">end</span>
</pre></div>
</div>


<p>We’ve used the code in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-proto_status_feed">Listing&nbsp;10.39</a> instead because it generalizes much more naturally to the full status feed needed in <a class="ref" href="http://ruby.railstutorial.org/chapters/following-users#top">Chapter&nbsp;11</a>.</p>

<p>To test the display of the status feed, we first create a couple of microposts and then verify that a list element (<code>li</code>) appears on the page for each one (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-home_page_feed_test">Listing&nbsp;10.40</a>).</p>

<div class="label" id="code-home_page_feed_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.40.</span> <span class="description">A test for rendering the feed on the Home page. <br> <code>spec/requests/static_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"for signed-in users"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">"Lorem ipsum"</span><span class="p">)</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">"Dolor sit amet"</span><span class="p">)</span>
        <span class="n">sign_in</span> <span class="n">user</span>
        <span class="n">visit</span> <span class="n">root_path</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"should render the user's feed"</span> <span class="k">do</span>
        <span class="n">user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
          <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">"li#</span><span class="si">#{</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-home_page_feed_test">Listing&nbsp;10.40</a> assumes that each feed item has a unique CSS&nbsp;id, so that</p>

<div class="code"><div class="highlight"><pre><span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">"li#</span><span class="si">#{</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</pre></div>
</div>


<p>will generate a match for each item. (Note that the first&nbsp;<code>#</code> in <code>li##{item.id}</code> is Capybara syntax for a CSS&nbsp;id, whereas the second&nbsp;<code>#</code> is the beginning of a Ruby string interpolation&nbsp;<code>#{}</code>.)</p>

<p>To use the feed in the sample application, we add an <code>@feed_items</code> instance variable for the current user’s (paginated) feed, as in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-feed_instance_variable">Listing&nbsp;10.41</a>, and then add a feed partial (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-feed_partial">Listing&nbsp;10.42</a>) to the Home page (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-home_with_feed">Listing&nbsp;10.44</a>). (Adding tests for pagination is left as an exercise; see <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-micropost_exercises">Section&nbsp;10.5</a>.)</p>

<div class="label" id="code-feed_instance_variable"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.41.</span> <span class="description">Adding a feed instance variable to the <code>home</code> action. <br> <code>app/controllers/static_pages_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="k">if</span> <span class="n">signed_in?</span>
      <span class="vi">@micropost</span>  <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-feed_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.42.</span> <span class="description">The status feed partial. <br> <code>app/views/shared/_feed.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@feed_items</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">"microposts"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">partial:</span> <span class="s1">'shared/feed_item'</span><span class="p">,</span> <span class="ss">collection:</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/ol&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>The status feed partial defers the feed item rendering to a feed item partial using the code</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">partial:</span> <span class="s1">'shared/feed_item'</span><span class="p">,</span> <span class="ss">collection:</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>Here we pass a <code>:collection</code> parameter with the feed items, which causes <code>render</code> to use the given partial (<code>’feed_item’</code> in this case) to render each item in the collection. (We have omitted the <code>:partial</code> parameter in previous renderings, writing, e.g., <code>render ’shared/micropost’</code>, but with a <code>:collection</code> parameter that syntax doesn’t work.) The feed item partial itself appears in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-feed_item_partial">Listing&nbsp;10.43</a>.</p>

<div class="label" id="code-feed_item_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.43.</span> <span class="description">A partial for a single feed item. <br> <code>app/views/shared/_feed_item.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">),</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"user"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"timestamp"</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-feed_item_partial">Listing&nbsp;10.43</a> also adds a CSS&nbsp;id for each feed item using</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
</pre></div>
</div>


<p>as required by the test in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-home_page_feed_test">Listing&nbsp;10.40</a>.</p>

<p>We can then add the feed to the Home page by rendering the feed partial as usual (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-home_with_feed">Listing&nbsp;10.44</a>). The result is a display of the feed on the Home page, as required (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig-home_with_proto_feed">Figure&nbsp;10.14</a>).</p>

<div class="label" id="code-home_with_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.44.</span> <span class="description">Adding a status feed to the Home page. <br> <code>app/views/static_pages/home.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
    .
    .
    .
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span8"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Micropost Feed<span class="nt">&lt;/h3&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/feed'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="label" id="fig-home_with_proto_feed"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/home_with_proto_feed_bootstrap.png" alt="home_with_proto_feed_bootstrap"></span></div><div class="caption"><span class="header">Figure 10.14: </span><span class="description">The Home page (<a href="http://localhost:3000/">/</a>) with a proto-feed.&nbsp;<a href="http://railstutorial.org/images/figures/home_with_proto_feed-full.png">(full size)</a></span></div></div>


<p>At this point, creating a new micropost works as expected, as seen in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig-micropost_created">Figure&nbsp;10.15</a>. There is one subtlety, though: on <em>failed</em> micropost submission, the Home page expects an <code>@feed_items</code> instance variable, so failed submissions currently break (as you should be able to verify by running your test suite). The easiest solution is to suppress the feed entirely by assigning it an empty array, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-microposts_create_action_with_feed">Listing&nbsp;10.45</a>.<sup class="footnote" id="fnref-10_12"><a href="http://ruby.railstutorial.org/chapters/user-microposts#fn-10_12">12</a></sup></p>

<div class="label" id="fig-micropost_created"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/micropost_created_bootstrap.png" alt="micropost_created_bootstrap"></span></div><div class="caption"><span class="header">Figure 10.15: </span><span class="description">The Home page after creating a new micropost.&nbsp;<a href="http://railstutorial.org/images/figures/micropost_created_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="code-microposts_create_action_with_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.45.</span> <span class="description">Adding an (empty) <code>@feed_items</code> instance variable to the <code>create</code> action. <br> <code>app/controllers/microposts_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:micropost</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Micropost created!"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="o">[]</span>
      <span class="n">render</span> <span class="s1">'static_pages/home'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>At this point, the proto-feed should be working, and the test suite should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-destroying_microposts"></div>


<h3><a id="sec-10_3_4" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-destroying_microposts" class="heading"><span class="number">10.3.4</span> Destroying microposts</a></h3>


<p>The last piece of functionality to add to the Microposts resource is the ability to destroy posts. As with user deletion (<a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-the_destroy_action">Section&nbsp;9.4.2</a>), we accomplish this with “delete” links, as mocked up in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig-micropost_delete_links_mockup">Figure&nbsp;10.16</a>. Unlike that case, which restricted user destruction to admin users, the delete links will work only for microposts created by the current user.</p>

<div class="label" id="fig-micropost_delete_links_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/micropost_delete_links_mockup_bootstrap.png" alt="micropost_delete_links_mockup_bootstrap"></span></div><div class="caption"><span class="header">Figure 10.16: </span><span class="description">A mockup of the proto-feed with micropost delete links.&nbsp;<a href="http://railstutorial.org/images/figures/micropost_delete_links_mockup_bootstrap-full.png">(full size)</a></span></div></div>


<p>Our first step is to add a delete link to the micropost partial as in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-feed_item_partial">Listing&nbsp;10.43</a>, and while we’re at it we’ll add a similar link to the feed item partial from <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-feed_item_partial">Listing&nbsp;10.43</a>. The results appear in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_partial_with_delete">Listing&nbsp;10.46</a> and <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-feed_item_partial_with_delete">Listing&nbsp;10.47</a>. (The two cases are almost identical, and eliminating this duplication is left as an exercise (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-micropost_exercises">Section&nbsp;10.5</a>).)</p>

<div class="label" id="code-micropost_partial_with_delete"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.46.</span> <span class="description">Adding a delete link to the micropost partial. <br> <code>app/views/microposts/_micropost.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"timestamp"</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"delete"</span><span class="p">,</span> <span class="n">micropost</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                     <span class="ss">data:</span> <span class="p">{</span> <span class="ss">confirm:</span> <span class="s2">"You sure?"</span> <span class="p">},</span>
                                     <span class="ss">title:</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code-feed_item_partial_with_delete"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.47.</span> <span class="description">The feed item partial with added delete link. <br> <code>app/views/shared/_feed_item.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">),</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"user"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"timestamp"</span><span class="nt">&gt;</span>
      Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
    <span class="nt">&lt;/span&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"delete"</span><span class="p">,</span> <span class="n">feed_item</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                     <span class="ss">data:</span> <span class="p">{</span> <span class="ss">confirm:</span> <span class="s2">"You sure?"</span> <span class="p">},</span>
                                     <span class="ss">title:</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p>The test for destroying microposts uses Capybara to click the “delete” link and expects the Micropost count to decrease by&nbsp;1 (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_destroy_specs">Listing&nbsp;10.48</a>).</p>

<div class="label" id="code-micropost_destroy_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.48.</span> <span class="description">Tests for the Microposts controller <code>destroy</code> action. <br> <code>spec/requests/micropost_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Micropost pages"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"micropost destruction"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"as correct user"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>

      <span class="n">it</span> <span class="s2">"should delete a micropost"</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">"delete"</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The application code is also analogous to the user case in <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#code-admin_destroy_before_filter">Listing&nbsp;9.48</a>; the main difference is that, rather than using an <code>admin_user</code> before filter, in the case of microposts we have a <code>correct_user</code> before filter to check that the current user actually has a micropost with the given id. The code appears in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-microposts_destroy_action">Listing&nbsp;10.49</a>, and the result of destroying the second-most-recent post appears in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig-home_post_delete">Figure&nbsp;10.17</a>.</p>

<div class="label" id="code-microposts_destroy_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.49.</span> <span class="description">The Microposts controller <code>destroy</code> action. <br> <code>app/controllers/microposts_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@micropost</span><span class="o">.</span><span class="n">destroy</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span> <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">nil?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>In the <code>correct_user</code> before filter, note that we find microposts <em>through</em> the association:</p>

<div class="code"><div class="highlight"><pre><span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>This automatically ensures that we find only microposts belonging to the current user. In this case, we use <code>find_by_id</code> instead of <code>find</code> because the latter raises an exception when the micropost doesn’t exist instead of returning <code>nil</code>. By the way, if you’re comfortable with exceptions in Ruby, you could also write the <code>correct_user</code> filter like this:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">correct_user</span>
  <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="k">rescue</span>
  <span class="n">redirect_to</span> <span class="n">root_url</span>
<span class="k">end</span>
</pre></div>
</div>


<p>It might occur to you that we could implement the <code>correct_user</code> filter using the <code>Micropost</code> model directly, like this:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="n">redirect_to</span> <span class="n">root_url</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>This would be equivalent to the code in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-microposts_destroy_action">Listing&nbsp;10.49</a>, but, as explained by <a href="http://www.rubyfocus.biz/">Wolfram Arnold</a> in the blog post <a href="http://www.rubyfocus.biz/blog/2011/06/15/access_control_101_in_rails_and_the_citibank-hack.html">Access Control 101 in Rails and the Citibank Hack</a>, for security purposes it is a good practice always to run lookups through the association.</p>

<div class="label" id="fig-home_post_delete"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/home_post_delete_bootstrap.png" alt="home_post_delete_bootstrap"></span></div><div class="caption"><span class="header">Figure 10.17: </span><span class="description">The user home page after deleting the second-most-recent micropost.&nbsp;<a href="http://railstutorial.org/images/figures/home_post_delete_bootstrap-full.png">(full size)</a></span></div></div>


<p>With the code in this section, our Micropost model and interface are complete, and the test suite should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<h2><a id="sec-10_4" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-10_4" class="heading"><span class="number">10.4</span> Conclusion</a></h2>


<p>With the addition of the Microposts resource, we are nearly finished with our sample application. All that remains is to add a social layer by letting users follow each other. We’ll learn how to model such user relationships, and see the implications for the status feed, in <a class="ref" href="http://ruby.railstutorial.org/chapters/following-users#top">Chapter&nbsp;11</a>.</p>

<p>Before proceeding, be sure to commit and merge your changes if you’re using Git for version control:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">"Add user microposts"</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge user-microposts
<span class="gp">$</span> git push
</pre></div>
</div>


<p>You can also push the app up to Heroku at this point. Because the data model has changed through the addition of the <code>microposts</code> table, you will also need to migrate the production database:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku pg:reset DATABASE
<span class="gp">$</span> heroku run rake db:migrate
<span class="gp">$</span> heroku run rake db:populate
</pre></div>
</div>


<div class="label" id="sec-micropost_exercises"></div>


<h2><a id="sec-10_5" href="http://ruby.railstutorial.org/chapters/user-microposts#sec-micropost_exercises" class="heading"><span class="number">10.5</span> Exercises</a></h2>


<p>We’ve covered enough material now that there is a combinatorial explosion of possible extensions to the application. Below are just a few of the many possibilities.</p>

<ol>
<li>Add tests for the sidebar micropost counts (including proper pluralization).</li>
<li>Add tests for micropost pagination.</li>
<li>Refactor the Home page to use separate partials for the two branches of the <code>if</code>-<code>else</code> statement.</li>
<li>Write a test to make sure delete links do not appear for microposts not created by the current user.</li>
<li>Using partials, eliminate the duplication in the delete links from <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_partial_with_delete">Listing&nbsp;10.46</a> and <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-feed_item_partial_with_delete">Listing&nbsp;10.47</a>.</li>
<li>Very long words currently break our layout, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig-long_word_micropost">Figure&nbsp;10.18</a>. Fix this problem using the <code>wrap</code> helper defined in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-wrap">Listing&nbsp;10.50</a>. Note the use of the <code>raw</code> method to prevent Rails from escaping the resulting HTML, together with the <code>sanitize</code> method needed to prevent cross-site scripting. This code also uses the strange-looking but useful <em>ternary operator</em> (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sidebar-ternary_operator">Box&nbsp;10.1</a>).</li>
<li><strong>(challenging)</strong> Add a JavaScript display to the Home page to count down from&nbsp;140 characters.</li>
</ol>




<div class="label" id="sidebar-ternary_operator"></div>


<div class="sidebar"><span class="title"><span class="header">Box 10.1.</span><span class="description">10 types of people</span></span>
<p>There are 10 kinds of people in the world: Those who like the ternary operator, those who don’t, and those who don’t know about it. (If you happen to be in the third category, soon you won’t be any longer.)</p>

<p>When you do a lot of programming, you quickly learn that one of the most common bits of control flow goes something like this:</p>

<pre class="verbatim">  if boolean? 
    do_one_thing 
  else 
    do_something_else 
  end </pre>


<p>Ruby, like many other languages (including C/C++, Perl, PHP, and Java), allows you to replace this with a much more compact expression using the <em>ternary operator</em> (so called because it consists of three parts):</p>

<pre class="verbatim">  boolean? ? do_one_thing : do_something_else </pre>


<p>You can also use the ternary operator to replace assignment:</p>

<pre class="verbatim">  if boolean?
    var = foo
  else 
    var = bar
  end </pre>


<p>becomes</p>

<pre class="verbatim">  var = boolean? ? foo : bar</pre>


<p>Another common use is in a function’s return value:</p>

<pre class="verbatim">  def foo
    do_stuff
    boolean? ? "bar" : "baz"
  end</pre>


<p>Since Ruby implicitly returns the value of the last expression in a function, here the <tt>foo</tt> method returns <tt>"bar"</tt> or <tt>"baz"</tt> depending on the value of <tt>boolean?</tt>. It is this final construction that appears in <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-wrap">Listing&nbsp;10.50</a>.</p>
</div>




<div class="label" id="fig-long_word_micropost"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/long_word_micropost_bootstrap.png" alt="long_word_micropost_bootstrap"></span></div><div class="caption"><span class="header">Figure 10.18: </span><span class="description">The (broken) site layout with a particularly long word.&nbsp;<a href="http://railstutorial.org/images/figures/long_word_micropost_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="code-wrap"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.50.</span> <span class="description">A helper to wrap long words. <br> <code>app/helpers/microposts_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">MicropostsHelper</span>

  <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">sanitize</span><span class="p">(</span><span class="n">raw</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">wrap_long_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">' '</span><span class="p">)))</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">wrap_long_string</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">max_width</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
      <span class="n">zero_width_space</span> <span class="o">=</span> <span class="s2">"&amp;#8203;"</span>
      <span class="n">regex</span> <span class="o">=</span> <span class="sr">/.{1,</span><span class="si">#{</span><span class="n">max_width</span><span class="si">}</span><span class="sr">}/</span>
      <span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">max_width</span><span class="p">)</span> <span class="p">?</span> <span class="n">text</span> <span class="p">:</span> 
                                  <span class="n">text</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">zero_width_space</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="navigation">  <a class="prev_page" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#top">
    «&nbsp;<span class="number">Chapter 9</span> Updating, showing, and deleting users
  </a>
  <a class="next_page" href="http://ruby.railstutorial.org/chapters/following-users#top">
    <span class="number">Chapter 11</span> Following users&nbsp;»
  </a>
</div><div class="footnotes">
<ol>
<li id="fn-10_1">Technically, we treated sessions as a resource in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#top">Chapter&nbsp;8</a>, but sessions are not saved to the database the way users and microposts are.&nbsp;<a class="arrow" href="http://ruby.railstutorial.org/chapters/user-microposts#fnref-10_1">↑</a></li>
<li id="fn-10_2">The <code>content</code> attribute will be a <code>string</code>, but, as noted briefly in <a class="ref" href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-modeling_demo_microposts">Section&nbsp;2.1.2</a>, for longer text fields you should use the <code>text</code> data type.&nbsp;<a class="arrow" href="http://ruby.railstutorial.org/chapters/user-microposts#fnref-10_2">↑</a></li>
<li id="fn-10_3">Initially, I forgot to duplicate the microposts property, and in fact previous versions of the tutorial had a bug in this test. Having a safety check would have revealed the error. Thanks to alert reader Jacob Turino for catching the bug and bringing it to my attention.&nbsp;<a class="arrow" href="http://ruby.railstutorial.org/chapters/user-microposts#fnref-10_3">↑</a></li>
<li id="fn-10_4">(i.e., the five users with custom Gravatars, and one with the default Gravatar)&nbsp;<a class="arrow" href="http://ruby.railstutorial.org/chapters/user-microposts#fnref-10_4">↑</a></li>
<li id="fn-10_5">Tail your <code>log/development.log</code> file if you’re curious about the SQL this method generates.&nbsp;<a class="arrow" href="http://ruby.railstutorial.org/chapters/user-microposts#fnref-10_5">↑</a></li>
<li id="fn-10_6">By design, the Faker gem’s <em>lorem ipsum</em> text is randomized, so the contents of your sample microposts will differ.&nbsp;<a class="arrow" href="http://ruby.railstutorial.org/chapters/user-microposts#fnref-10_6">↑</a></li>
<li id="fn-10_7">For convenience, <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code-micropost_css">Listing&nbsp;10.24</a> actually has <em>all</em> the CSS needed for this chapter.&nbsp;<a class="arrow" href="http://ruby.railstutorial.org/chapters/user-microposts#fnref-10_7">↑</a></li>
<li id="fn-10_8">The other two resources are Users in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#sec-signup_form">Section&nbsp;7.2</a> and Sessions in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_failure">Section&nbsp;8.1</a>.&nbsp;<a class="arrow" href="http://ruby.railstutorial.org/chapters/user-microposts#fnref-10_8">↑</a></li>
<li id="fn-10_9">We noted in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-remember_me">Section&nbsp;8.2.1</a> that helper methods are available only in <em>views</em> by default, but we arranged for the Sessions helper methods to be available in the controllers as well by adding <code>include SessionsHelper</code> to the Application controller (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-sessions_helper_include">Listing&nbsp;8.14</a>).&nbsp;<a class="arrow" href="http://ruby.railstutorial.org/chapters/user-microposts#fnref-10_9">↑</a></li>
<li id="fn-10_10">Learning about methods such as <code>include?</code> is one reason why, as noted in <a class="ref" href="http://ruby.railstutorial.org/chapters/beginning#sec-comments_for_various_readers">Section&nbsp;1.1.1</a>, I recommend reading a pure Ruby book after finishing this one.&nbsp;<a class="arrow" href="http://ruby.railstutorial.org/chapters/user-microposts#fnref-10_10">↑</a></li>
<li id="fn-10_11">See the Rails Guide on the <a href="http://guides.rubyonrails.org/active_record_querying.html">Active Record Query Interface</a> for more on <code>where</code> and the like.&nbsp;<a class="arrow" href="http://ruby.railstutorial.org/chapters/user-microposts#fnref-10_11">↑</a></li>
<li id="fn-10_12">Unfortunately, returning a paginated feed doesn’t work in this case. Implement it and click on a pagination link to see why.&nbsp;<a class="arrow" href="http://ruby.railstutorial.org/chapters/user-microposts#fnref-10_12">↑</a></li>
</ol>
</div>





    </div>
  <div id="book_bottom">
  </div>
</div>
        
        </div>

    <div>Michael Hartl is a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for sites to earn advertising fees by advertising and linking to Amazon.com.</div>
 
    <div id="container-bottom"></div>
    
<div id="fb-root" class=" fb_reset"><script type="text/javascript" src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/all.js" async=""></script><div style="position: absolute; top: -10000px; height: 0px; width: 0px;"><div><iframe name="fb_xdm_frame_http" frameborder="0" allowtransparency="true" scrolling="no" id="fb_xdm_frame_http" aria-hidden="true" title="Facebook Cross Domain Communication Frame" tab-index="-1" style="border: none;" src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/xd_arbiter.html"></iframe><iframe name="fb_xdm_frame_https" frameborder="0" allowtransparency="true" scrolling="no" id="fb_xdm_frame_https" aria-hidden="true" title="Facebook Cross Domain Communication Frame" tab-index="-1" style="border: none;" src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/xd_arbiter(1).html"></iframe></div></div><div style="position: absolute; top: -10000px; height: 0px; width: 0px;"><div><iframe name="f1c97c07f8" frameborder="0" allowtransparency="true" scrolling="no" style="display: none;" src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/oauth.html"></iframe></div></div></div>
<script>
  window.fbAsyncInit = function() {
    FB.init({appId: '145973438749643', status: true, cookie: true,
             xfbml: true});
  };
  (function() {
    var e = document.createElement('script');
    e.type = 'text/javascript';
    e.src = document.location.protocol +
      '//connect.facebook.net/en_US/all.js';
    e.async = true;
    document.getElementById('fb-root').appendChild(e);
  }());
</script>

  
      <script type="text/javascript">
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
  </script><script src="./Learn Web Development with the Ruby on Rails Tutorial   User Microposts_files/ga.js" type="text/javascript"></script>
  <script type="text/javascript">
  try {
  var pageTracker = _gat._getTracker("UA-8667566-1");
  pageTracker._trackPageview();
  } catch(err) {}</script>

  
  
  </div>

</div></body></html>