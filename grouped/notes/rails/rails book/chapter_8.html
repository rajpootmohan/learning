<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- saved from url=(0059)http://ruby.railstutorial.org/chapters/sign-in-sign-out#top -->
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Learn Web Development with the Ruby on Rails Tutorial | Sign In Sign Out</title>
    
<meta name="robots" content="all">
<meta name="MSSmartTagsPreventParsing" content="true">
<meta name="description" content="Ruby on Rails Tutorial: Learn Rails by Example by Michael Hartl">
<meta name="keywords" content="Learn Ruby Rails Tutorial web development Rails 3">
<meta name="author" content="Michael Hartl">
<meta property="og:title" content="Ruby on Rails Tutorial: Learn Rails by Example">
<meta property="og:site_name" content="Ruby on Rails Tutorial">
<meta property="og:image" content="http://railstutorial.org/images/layout/logo.png">
<meta property="og:url" content="http://railstutorial.org/">
<meta property="og:type" content="article">
<meta property="og:description" content="Ruby on Rails Tutorial: Learn Web Development with Rails by Michael Hartl teaches web development with Ruby on Rails. Rails Tutorial is fully up-to-date with Rails 3.0 and Rails 3.2.">
    <link href="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/polytexnic.css" media="screen" rel="stylesheet" type="text/css">
    <link href="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/pygments.css" media="screen" rel="stylesheet" type="text/css">

      <link href="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
      
    <link href="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/print.css" media="print" rel="stylesheet" type="text/css">
    <!--[if lte IE 7]><link href="/stylesheets/ie.css?1364087846" media="screen" rel="stylesheet" type="text/css" /><![endif]-->
    <!--[if lt IE 7]>  <div style='border: 1px solid #F7941D; background: #FEEFDA; text-align: center; clear: both; height: 75px; position: relative;'>    <div style='position: absolute; right: 3px; top: 3px; font-family: courier new; font-weight: bold;'><a href='#' onclick='javascript:this.parentNode.parentNode.style.display="none"; return false;'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-cornerx.jpg' style='border: none;' alt='Close this notice'/></a></div>    <div style='width: 640px; margin: 0 auto; text-align: left; padding: 0; overflow: hidden; color: black;'>      <div style='width: 75px; float: left;'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-warning.jpg' alt='Warning!'/></div>      <div style='width: 275px; float: left; font-family: Arial, sans-serif;'>        <div style='font-size: 14px; font-weight: bold; margin-top: 12px;'>You are using an outdated browser</div>        <div style='font-size: 12px; margin-top: 6px; line-height: 12px;'>For a better experience using this site, please upgrade to a modern web browser.</div>      </div>      <div style='width: 75px; float: left;'><a href='http://www.firefox.com' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-firefox.jpg' style='border: none;' alt='Get Firefox 3.5'/></a></div>      <div style='width: 75px; float: left;'><a href='http://www.browserforthebetter.com/download.html' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-ie8.jpg' style='border: none;' alt='Get Internet Explorer 8'/></a></div>      <div style='width: 73px; float: left;'><a href='http://www.apple.com/safari/download/' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-safari.jpg' style='border: none;' alt='Get Safari 4'/></a></div>      <div style='float: left;'><a href='http://www.google.com/chrome' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-chrome.jpg' style='border: none;' alt='Get Google Chrome'/></a></div>    </div>  </div>  <![endif]-->
    <link href="http://feeds.feedburner.com/railstutorial" rel="alternate" title="Rails Tutorial News" type="application/rss+xml">

    
    <script src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/widgets.js" charset="utf-8"></script>    
    
  <!--<base href="http://ruby.railstutorial.org/chapters/sign-in-sign-out">--><base href=".">
  <script type="text/javascript" src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/MathJax.js">
  MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$','$'],["\\(","\\)"]]},
    processEscapes: true,
    "HTML-CSS": {
      availableFonts: ["TeX"]
    }
  });
</script>    


  <style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Hover_Arrow {position: absolute; width: 15px; height: 11px; cursor: pointer}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuTitle {background-color: #CCCCCC; margin: -5px 0 0 0; text-align: center; font-style: italic; font-size: 80%; color: #444444; padding: 2px 0; overflow: hidden}
.MathJax_MenuArrow {position: absolute; right: .5em; color: #666666}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_Menu_Close {position: absolute; width: 31px; height: 31px; top: -15px; left: -15px}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MathJax_Display {text-align: center; margin: 1em 0em; position: relative; display: block; width: 100%}
.MathJax .merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
#MathJax_Tooltip {background-color: InfoBackground; color: InfoText; border: 1px solid black; box-shadow: 2px 2px 5px #AAAAAA; -webkit-box-shadow: 2px 2px 5px #AAAAAA; -moz-box-shadow: 2px 2px 5px #AAAAAA; -khtml-box-shadow: 2px 2px 5px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true'); padding: 3px 4px; position: absolute; left: 0; top: 0; width: auto; height: auto; display: none}
.MathJax {display: inline; font-style: normal; font-weight: normal; line-height: normal; font-size: 100%; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; border: 0; padding: 0; margin: 0}
.MathJax img, .MathJax nobr, .MathJax a {border: 0; padding: 0; margin: 0; max-width: none; max-height: none; vertical-align: 0; line-height: normal; text-decoration: none}
img.MathJax_strut {border: 0 !important; padding: 0 !important; margin: 0 !important; vertical-align: 0 !important}
.MathJax span {display: inline; position: static; border: 0; padding: 0; margin: 0; vertical-align: 0; line-height: normal; text-decoration: none}
.MathJax nobr {white-space: nowrap ! important}
.MathJax img {display: inline ! important; float: none ! important}
.MathJax_Processing {visibility: hidden; position: fixed; width: 0; height: 0; overflow: hidden}
.MathJax_Processed {display: none!important}
.MathJax_ExBox {display: block; overflow: hidden; width: 1px; height: 60ex}
.MathJax .MathJax_EmBox {display: block; overflow: hidden; width: 1px; height: 60em}
.MathJax .MathJax_HitBox {cursor: text; background: white; opacity: 0; filter: alpha(opacity=0)}
.MathJax .MathJax_HitBox * {filter: none; opacity: 1; background: transparent}
#MathJax_Tooltip * {filter: none; opacity: 1; background: transparent}
@font-face {font-family: MathJax_Main; src: url('http://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Main-Regular.woff') format('woff'), url('http://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Main-Regular.otf') format('opentype')}
@font-face {font-family: MathJax_Main; src: url('http://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Main-Bold.woff') format('woff'), url('http://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Main-Bold.otf') format('opentype'); font-weight: bold}
@font-face {font-family: MathJax_Main; src: url('http://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Main-Italic.woff') format('woff'), url('http://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Main-Italic.otf') format('opentype'); font-style: italic}
@font-face {font-family: MathJax_Math; src: url('http://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Math-Italic.woff') format('woff'), url('http://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Math-Italic.otf') format('opentype'); font-style: italic}
@font-face {font-family: MathJax_Caligraphic; src: url('http://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Caligraphic-Regular.woff') format('woff'), url('http://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Caligraphic-Regular.otf') format('opentype')}
@font-face {font-family: MathJax_Size1; src: url('http://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Size1-Regular.woff') format('woff'), url('http://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Size1-Regular.otf') format('opentype')}
@font-face {font-family: MathJax_Size2; src: url('http://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Size2-Regular.woff') format('woff'), url('http://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Size2-Regular.otf') format('opentype')}
@font-face {font-family: MathJax_Size3; src: url('http://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Size3-Regular.woff') format('woff'), url('http://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Size3-Regular.otf') format('opentype')}
@font-face {font-family: MathJax_Size4; src: url('http://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Size4-Regular.woff') format('woff'), url('http://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Size4-Regular.otf') format('opentype')}
.MathJax .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><style type="text/css">.fb_hidden{position:absolute;top:-10000px;z-index:10001}
.fb_invisible{display:none}
.fb_reset{background:none;border-spacing:0;border:0;color:#000;cursor:auto;direction:ltr;font-family:"lucida grande", tahoma, verdana, arial, sans-serif;font-size:11px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:1;margin:0;overflow:visible;padding:0;text-align:left;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;visibility:visible;white-space:normal;word-spacing:normal}
.fb_link img{border:none}
.fb_dialog{background:rgba(82, 82, 82, .7);position:absolute;top:-10000px;z-index:10001}
.fb_dialog_advanced{padding:10px;-moz-border-radius:8px;-webkit-border-radius:8px;border-radius:8px}
.fb_dialog_content{background:#fff;color:#333}
.fb_dialog_close_icon{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 0 transparent;_background-image:url(http://static.ak.fbcdn.net/rsrc.php/v2/yL/r/s816eWC-2sl.gif);cursor:pointer;display:block;height:15px;position:absolute;right:18px;top:17px;width:15px;top:8px\9;right:7px\9}
.fb_dialog_mobile .fb_dialog_close_icon{top:5px;left:5px;right:auto}
.fb_dialog_padding{background-color:transparent;position:absolute;width:1px;z-index:-1}
.fb_dialog_close_icon:hover{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -15px transparent;_background-image:url(http://static.ak.fbcdn.net/rsrc.php/v2/yL/r/s816eWC-2sl.gif)}
.fb_dialog_close_icon:active{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -30px transparent;_background-image:url(http://static.ak.fbcdn.net/rsrc.php/v2/yL/r/s816eWC-2sl.gif)}
.fb_dialog_loader{background-color:#f2f2f2;border:1px solid #606060;font-size:24px;padding:20px}
.fb_dialog_top_left,
.fb_dialog_top_right,
.fb_dialog_bottom_left,
.fb_dialog_bottom_right{height:10px;width:10px;overflow:hidden;position:absolute}
/* @noflip */
.fb_dialog_top_left{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 0;left:-10px;top:-10px}
/* @noflip */
.fb_dialog_top_right{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 -10px;right:-10px;top:-10px}
/* @noflip */
.fb_dialog_bottom_left{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 -20px;bottom:-10px;left:-10px}
/* @noflip */
.fb_dialog_bottom_right{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 -30px;right:-10px;bottom:-10px}
.fb_dialog_vert_left,
.fb_dialog_vert_right,
.fb_dialog_horiz_top,
.fb_dialog_horiz_bottom{position:absolute;background:#525252;filter:alpha(opacity=70);opacity:.7}
.fb_dialog_vert_left,
.fb_dialog_vert_right{width:10px;height:100%}
.fb_dialog_vert_left{margin-left:-10px}
.fb_dialog_vert_right{right:0;margin-right:-10px}
.fb_dialog_horiz_top,
.fb_dialog_horiz_bottom{width:100%;height:10px}
.fb_dialog_horiz_top{margin-top:-10px}
.fb_dialog_horiz_bottom{bottom:0;margin-bottom:-10px}
.fb_dialog_iframe{line-height:0}
.fb_dialog_content .dialog_title{background:#6d84b4;border:1px solid #3b5998;color:#fff;font-size:14px;font-weight:bold;margin:0}
.fb_dialog_content .dialog_title > span{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/yd/r/Cou7n-nqK52.gif)
no-repeat 5px 50%;float:left;padding:5px 0 7px 26px}
body.fb_hidden{-webkit-transform:none;height:100%;margin:0;left:-10000px;overflow:visible;position:absolute;top:-10000px;width:100%
}
.fb_dialog.fb_dialog_mobile.loading{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/ya/r/3rhSv5V8j3o.gif)
white no-repeat 50% 50%;min-height:100%;min-width:100%;overflow:hidden;position:absolute;top:0;z-index:10001}
.fb_dialog.fb_dialog_mobile.loading.centered{max-height:590px;min-height:590px;max-width:500px;min-width:500px}
#fb-root #fb_dialog_ipad_overlay{background:rgba(0, 0, 0, .45);position:absolute;left:0;top:0;width:100%;min-height:100%;z-index:10000}
#fb-root #fb_dialog_ipad_overlay.hidden{display:none}
.fb_dialog.fb_dialog_mobile.loading iframe{visibility:hidden}
.fb_dialog_content .dialog_header{-webkit-box-shadow:white 0 1px 1px -1px inset;background:-webkit-gradient(linear, 0 0, 0 100%, from(#738ABA), to(#2C4987));border-bottom:1px solid;border-color:#1d4088;color:#fff;font:14px Helvetica, sans-serif;font-weight:bold;text-overflow:ellipsis;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0;vertical-align:middle;white-space:nowrap}
.fb_dialog_content .dialog_header table{-webkit-font-smoothing:subpixel-antialiased;height:43px;width:100%
}
.fb_dialog_content .dialog_header td.header_left{font-size:12px;padding-left:5px;vertical-align:middle;width:60px
}
.fb_dialog_content .dialog_header td.header_right{font-size:12px;padding-right:5px;vertical-align:middle;width:60px
}
.fb_dialog_content .touchable_button{background:-webkit-gradient(linear, 0 0, 0 100%, from(#4966A6),
color-stop(0.5, #355492), to(#2A4887));border:1px solid #29447e;-webkit-background-clip:padding-box;-webkit-border-radius:3px;-webkit-box-shadow:rgba(0, 0, 0, .117188) 0 1px 1px inset,
rgba(255, 255, 255, .167969) 0 1px 0;display:inline-block;margin-top:3px;max-width:85px;line-height:18px;padding:4px 12px;position:relative}
.fb_dialog_content .dialog_header .touchable_button input{border:none;background:none;color:#fff;font:12px Helvetica, sans-serif;font-weight:bold;margin:2px -12px;padding:2px 6px 3px 6px;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0}
.fb_dialog_content .dialog_header .header_center{color:#fff;font-size:16px;font-weight:bold;line-height:18px;text-align:center;vertical-align:middle}
.fb_dialog_content .dialog_content{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/y9/r/jKEcVPZFk-2.gif) no-repeat 50% 50%;border:1px solid #555;border-bottom:0;border-top:0;height:150px}
.fb_dialog_content .dialog_footer{background:#f2f2f2;border:1px solid #555;border-top-color:#ccc;height:40px}
#fb_dialog_loader_close{float:left}
.fb_dialog.fb_dialog_mobile .fb_dialog_close_button{text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0}
.fb_dialog.fb_dialog_mobile .fb_dialog_close_icon{visibility:hidden}
.fb_iframe_widget{position:relative;display:-moz-inline-block;display:inline-block}
.fb_iframe_widget iframe{position:absolute}
.fb_iframe_widget_lift{z-index:1}
.fb_iframe_widget span{display:inline-block;position:relative;text-align:justify;vertical-align:text-bottom}
.fb_hide_iframes iframe{position:relative;left:-10000px}
.fb_iframe_widget_loader{position:relative;display:inline-block}
.fb_iframe_widget_fluid{display:inline}
.fb_iframe_widget_fluid span{width:100%}
.fb_iframe_widget_loader iframe{min-height:32px;z-index:2;zoom:1}
.fb_iframe_widget_loader .FB_Loader{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/y9/r/jKEcVPZFk-2.gif) no-repeat;height:32px;width:32px;margin-left:-16px;position:absolute;left:50%;z-index:4}
.fb_button_simple,
.fb_button_simple_rtl{background-image:url(http://static.ak.fbcdn.net/rsrc.php/v2/yH/r/eIpbnVKI9lR.png);background-repeat:no-repeat;cursor:pointer;outline:none;text-decoration:none}
.fb_button_simple_rtl{background-position:right 0}
.fb_button_simple .fb_button_text{margin:0 0 0 20px;padding-bottom:1px}
.fb_button_simple_rtl .fb_button_text{margin:0 10px 0 0}
a.fb_button_simple:hover .fb_button_text,
a.fb_button_simple_rtl:hover .fb_button_text,
.fb_button_simple:hover .fb_button_text,
.fb_button_simple_rtl:hover .fb_button_text{text-decoration:underline}
.fb_button,
.fb_button_rtl{background:#29447e url(http://static.ak.fbcdn.net/rsrc.php/v2/yL/r/FGFbc80dUKj.png);background-repeat:no-repeat;cursor:pointer;display:inline-block;padding:0 0 0 1px;text-decoration:none;outline:none}
.fb_button .fb_button_text,
.fb_button_rtl .fb_button_text{background:#5f78ab url(http://static.ak.fbcdn.net/rsrc.php/v2/yL/r/FGFbc80dUKj.png);border-top:solid 1px #879ac0;border-bottom:solid 1px #1a356e;color:#fff;display:block;font-family:"lucida grande",tahoma,verdana,arial,sans-serif;font-weight:bold;padding:2px 6px 3px 6px;margin:1px 1px 0 21px;text-shadow:none}
a.fb_button,
a.fb_button_rtl,
.fb_button,
.fb_button_rtl{text-decoration:none}
a.fb_button:active .fb_button_text,
a.fb_button_rtl:active .fb_button_text,
.fb_button:active .fb_button_text,
.fb_button_rtl:active .fb_button_text{border-bottom:solid 1px #29447e;border-top:solid 1px #45619d;background:#4f6aa3;text-shadow:none}
.fb_button_xlarge,
.fb_button_xlarge_rtl{background-position:left -60px;font-size:24px;line-height:30px}
.fb_button_xlarge .fb_button_text{padding:3px 8px 3px 12px;margin-left:38px}
a.fb_button_xlarge:active{background-position:left -99px}
.fb_button_xlarge_rtl{background-position:right -268px}
.fb_button_xlarge_rtl .fb_button_text{padding:3px 8px 3px 12px;margin-right:39px}
a.fb_button_xlarge_rtl:active{background-position:right -307px}
.fb_button_large,
.fb_button_large_rtl{background-position:left -138px;font-size:13px;line-height:16px}
.fb_button_large .fb_button_text{margin-left:24px;padding:2px 6px 4px 6px}
a.fb_button_large:active{background-position:left -163px}
.fb_button_large_rtl{background-position:right -346px}
.fb_button_large_rtl .fb_button_text{margin-right:25px}
a.fb_button_large_rtl:active{background-position:right -371px}
.fb_button_medium,
.fb_button_medium_rtl{background-position:left -188px;font-size:11px;line-height:14px}
a.fb_button_medium:active{background-position:left -210px}
.fb_button_medium_rtl{background-position:right -396px}
.fb_button_text_rtl,
.fb_button_medium_rtl .fb_button_text{padding:2px 6px 3px 6px;margin-right:22px}
a.fb_button_medium_rtl:active{background-position:right -418px}
.fb_button_small,
.fb_button_small_rtl{background-position:left -232px;font-size:10px;line-height:10px}
.fb_button_small .fb_button_text{padding:2px 6px 3px;margin-left:17px}
a.fb_button_small:active,
.fb_button_small:active{background-position:left -250px}
.fb_button_small_rtl{background-position:right -440px}
.fb_button_small_rtl .fb_button_text{padding:2px 6px;margin-right:18px}
a.fb_button_small_rtl:active{background-position:right -458px}
.fb_share_count_wrapper{position:relative;float:left}
.fb_share_count{background:#b0b9ec none repeat scroll 0 0;color:#333;font-family:"lucida grande", tahoma, verdana, arial, sans-serif;text-align:center}
.fb_share_count_inner{background:#e8ebf2;display:block}
.fb_share_count_right{margin-left:-1px;display:inline-block}
.fb_share_count_right .fb_share_count_inner{border-top:solid 1px #e8ebf2;border-bottom:solid 1px #b0b9ec;margin:1px 1px 0 1px;font-size:10px;line-height:10px;padding:2px 6px 3px;font-weight:bold}
.fb_share_count_top{display:block;letter-spacing:-1px;line-height:34px;margin-bottom:7px;font-size:22px;border:solid 1px #b0b9ec}
.fb_share_count_nub_top{border:none;display:block;position:absolute;left:7px;top:35px;margin:0;padding:0;width:6px;height:7px;background-repeat:no-repeat;background-image:url(http://static.ak.fbcdn.net/rsrc.php/v2/yU/r/bSOHtKbCGYI.png)}
.fb_share_count_nub_right{border:none;display:inline-block;padding:0;width:5px;height:10px;background-repeat:no-repeat;background-image:url(http://static.ak.fbcdn.net/rsrc.php/v2/yX/r/i_oIVTKMYsL.png);vertical-align:top;background-position:right 5px;z-index:10;left:2px;margin:0 2px 0 0;position:relative}
.fb_share_no_count{display:none}
.fb_share_size_Small .fb_share_count_right .fb_share_count_inner{font-size:10px}
.fb_share_size_Medium .fb_share_count_right .fb_share_count_inner{font-size:11px;padding:2px 6px 3px;letter-spacing:-1px;line-height:14px}
.fb_share_size_Large .fb_share_count_right .fb_share_count_inner{font-size:13px;line-height:16px;padding:2px 6px 4px;font-weight:normal;letter-spacing:-1px}
.fb_share_count_hidden .fb_share_count_nub_top,
.fb_share_count_hidden .fb_share_count_top,
.fb_share_count_hidden .fb_share_count_nub_right,
.fb_share_count_hidden .fb_share_count_right{visibility:hidden}
.fb_connect_bar_container div,
.fb_connect_bar_container span,
.fb_connect_bar_container a,
.fb_connect_bar_container img,
.fb_connect_bar_container strong{background:none;border-spacing:0;border:0;direction:ltr;font-style:normal;font-variant:normal;letter-spacing:normal;line-height:1;margin:0;overflow:visible;padding:0;text-align:left;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;visibility:visible;white-space:normal;word-spacing:normal;vertical-align:baseline}
.fb_connect_bar_container{position:fixed;left:0 !important;right:0 !important;height:42px !important;padding:0 25px !important;margin:0 !important;vertical-align:middle !important;border-bottom:1px solid #333 !important;background:#3b5998 !important;z-index:99999999 !important;overflow:hidden !important}
.fb_connect_bar_container_ie6{position:absolute;top:expression(document.compatMode=="CSS1Compat"? document.documentElement.scrollTop+"px":body.scrollTop+"px")}
.fb_connect_bar{position:relative;margin:auto;height:100%;width:100%;padding:6px 0 0 0 !important;background:none;color:#fff !important;font-family:"lucida grande", tahoma, verdana, arial, sans-serif !important;font-size:13px !important;font-style:normal !important;font-variant:normal !important;font-weight:normal !important;letter-spacing:normal !important;line-height:1 !important;text-decoration:none !important;text-indent:0 !important;text-shadow:none !important;text-transform:none !important;white-space:normal !important;word-spacing:normal !important}
.fb_connect_bar a:hover{color:#fff}
.fb_connect_bar .fb_profile img{height:30px;width:30px;vertical-align:middle;margin:0 6px 5px 0}
.fb_connect_bar div a,
.fb_connect_bar span,
.fb_connect_bar span a{color:#bac6da;font-size:11px;text-decoration:none}
.fb_connect_bar .fb_buttons{float:right;margin-top:7px}
.fb_edge_widget_with_comment{position:relative;*z-index:1000}
.fb_edge_widget_with_comment span.fb_edge_comment_widget{position:absolute}
.fb_edge_widget_with_comment span.fb_send_button_form_widget{z-index:1}
.fb_edge_widget_with_comment span.fb_send_button_form_widget .FB_Loader{left:0;top:1px;margin-top:6px;margin-left:0;background-position:50% 50%;background-color:#fff;height:150px;width:394px;border:1px #666 solid;border-bottom:2px solid #283e6c;z-index:1}
.fb_edge_widget_with_comment span.fb_send_button_form_widget.dark .FB_Loader{background-color:#000;border-bottom:2px solid #ccc}
.fb_edge_widget_with_comment span.fb_send_button_form_widget.siderender
.FB_Loader{margin-top:0}
.fbpluginrecommendationsbarleft,
.fbpluginrecommendationsbarright{position:fixed !important;bottom:0;z-index:999}
/* @noflip */
.fbpluginrecommendationsbarleft{left:10px}
/* @noflip */
.fbpluginrecommendationsbarright{right:10px}</style></head>
<body class="book" data-twttr-rendered="true"><div style="visibility: hidden; overflow: hidden; position: absolute; top: 0px; height: 1px; width: auto; padding: 0px; border: 0px; margin: 0px; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal;"><div id="MathJax_Hidden"></div></div><div id="MathJax_Message" style="display: none;"></div> 

  <div id="container">
    <div id="header" class="clearfix"><div id="title">
  <div id="logo"><a href="http://ruby.railstutorial.org/"><img alt="Logo" src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/logo.png"></a></div>
  <h1 id="name">
    <a href="http://ruby.railstutorial.org/">Ruby on Rails Tutorial</a>
  </h1>
  <br>
  <h2 id="authors">
    <a href="http://ruby.railstutorial.org/#author">by Michael Hartl</a>
  </h2>
</div>
</div>
    <div id="menu"><div class="links">
  <div class="box">
    <span>
      <a href="http://ruby.railstutorial.org/">Home</a>
    </span>
    <span class="division">
      |
    </span>
    <span>
      <a href="http://ruby.railstutorial.org/ruby-on-rails-tutorial-book">Book</a>
    </span>
    <span class="division">
      |
    </span>
    <span>
      <a href="http://ruby.railstutorial.org/help">Help</a>
    </span>
    <span class="division">
      |
    </span>
    <span>
      <a href="http://ruby.railstutorial.org/contact">Contact</a>
    </span>
    <span class="division">
      |
    </span>
    <span>
      <a href="http://news.railstutorial.org/">News</a>
    </span>
    <span class="img">
      <a href="http://feeds.feedburner.com/railstutorial"><img alt="Feed-icon16x16" class="feed" src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/feed-icon16x16.png"></a>
    </span>
    <!-- %span.division -->
    <!-- 
    -->
    <!-- %span -->
    <!-- = link_to "By Email", email_url -->
    <!-- %span.img -->
    <!-- = link_to email_icon, email_url -->
    <span class="division">
      |
    </span>
    <span>
      <a href="http://twitter.com/railstutorial">Follow</a>
    </span>
    <span>
      <a href="http://twitter.com/railstutorial"><img alt="Twitter-small" src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/twitter-small.png"></a>
    </span>
  </div>
</div>
</div>     
      <div id="content">         
        <div id="sidebar">
  <div class="content">
      <!-- = link_to image_tag("icons/feed-icon32x32.png"), feed_url -->
    <!-- = link_to image_tag("icons/twitter.png"), twitter_url -->
    <!-- = link_to image_tag("icons/mail-icons/mail-icon-32x32.png"), email_url -->
    <div id="navtool">
      <table class="layout">
        <tbody><tr>
          <td colspan="2"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#book_menu"><img alt="Up A Level" src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/sb_button_up.png"></a></td>
        </tr>
        <tr>
          <td><a href="http://ruby.railstutorial.org/chapters/sign-up#top"><img alt="Previous Chapter" src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/sb_button_prev.png"></a></td>
          <td><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#top"><img alt="Next Chapter" src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/sb_button_next.png"></a></td>
        </tr>
      </tbody></table>
      <a href="http://www.amazon.com/gp/product/0321832051/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=0321832051&linkCode=as2&tag=therubonraitu-20"><img alt="Ruby on Rails Tutorial: Learn Web Development with Rails" src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/sb_button_buy_print_edition_red.png"></a><img src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/ir" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;">
      <br>
      <a href="http://ruby.railstutorial.org/#buy"><img alt="Buy Screencasts" src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/sb_button_pdf_screencasts_red.png"></a>
      <center><a href="http://youtu.be/bOdn9EdUquo" target="_blank"><img alt="Screencasts_thumbnail_play" src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/screencasts_thumbnail_play.png"></a></center>
      <div class="connect">
        <table class="center">
          <tbody><tr>
            <td><a href="http://feeds.feedburner.com/railstutorial"><img alt="Feed-icon24x24" src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/feed-icon24x24.png" title="Get news updates via RSS"></a></td>
            <td><a href="http://feedburner.google.com/fb/a/mailverify?uri=railstutorial&loc=en_US"><img alt="Mail-icon-24x24" src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/mail-icon-24x24.png" title="Get news updates by email"></a></td>
            <td><a href="http://www.facebook.com/pages/Ruby-on-Rails-Tutorial/197151265072"><img alt="Facebook-icon24x24" src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/facebook-icon24x24.png" title="Become a fan on Facebook"></a></td>
            <td><a href="http://twitter.com/railstutorial"><img alt="Twitter-icon24x24" src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/twitter-icon24x24.png" title="Follow on Twitter"></a></td>
          </tr>
        </tbody></table>
      </div>
      <div class="section">
        <div class="switcher">
          <span class="title round">Rails 3.2</span>
          •
          <span class="switcher_link"><a href="http://ruby.railstutorial.org/book?version=4.0">Rails 4.0</a></span>
        </div>
        <div class="share"><fb:like href="http://railstutorial.org/" show_faces="false" layout="button_count" colorscheme="light" fb-xfbml-state="rendered" class="fb_edge_widget_with_comment fb_iframe_widget"><span style="height: 21px; width: 79px;"><iframe id="f15c9bf14" name="f372e1ef54" scrolling="no" style="border: none; overflow: hidden; height: 21px; width: 79px;" title="Like this content on Facebook." class="fb_ltr" src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/like.html"></iframe></span></fb:like></div>
      </div>
      <div class="section">
        <a href="http://ruby.railstutorial.org/book?version=4.0#top">
          Read the Rails 4.0 edition
        </a>
      </div>
    </div>
    <!-- .section -->
    <!-- Sidebar areas labeled with class "section", like this one, will be styled suitably for text. -->
    <!-- .section -->
    <!-- %a{ :href => '/affiliates' } -->
    <!-- Rails Tutorial Affiliate Program&mdash;50% commissions -->
  </div>
</div>
<!-- %h3 Get Involved -->
<!-- 
-->
<!-- .links -->
<!-- %p.subscribe -->
<!-- %span= link_to(image_tag('feed-icon32x32.png'), feed_url) -->
<!-- = link_to("Subscribe", feed_url) -->
<!-- %p.follow -->
<!-- = link_to(image_tag('twitter.png'), twitter_url) -->
<!-- = link_to("Follow", twitter_url) -->
<!-- 
-->

                      
        <div id="main" class="withsidebar">
          


<div id="book_menu">
  <a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#main_content">skip to content</a>
  |
  <a href="http://ruby.railstutorial.org/book/ruby-on-rails-tutorial">view as single page</a>
</div>


<div id="book_wrap">
  <div id="book_top">
  </div>
    <div id="book">


<h1 class="title">Ruby on Rails Tutorial </h1>


<h1 class="subtitle">  Learn Web Development with Rails</h1>


<h2 class="author">Michael Hartl</h2>




<h2 class="contents">Contents</h2>


<div id="table_of_contents"><ol><li class="chapter"><a href="http://ruby.railstutorial.org/chapters/beginning#top"><span class="number">Chapter 1</span> From zero to deploy</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-introduction"><span class="number">1.1</span> Introduction</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-comments_for_various_readers"><span class="number">1.1.1</span> Comments for various readers</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-1_1_2"><span class="number">1.1.2</span> “Scaling” Rails</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-conventions"><span class="number">1.1.3</span> Conventions in this book</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-up_and_running"><span class="number">1.2</span> Up and running</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-development_tools"><span class="number">1.2.1</span> Development environments</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-1_2_1_1">IDEs</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-1_2_1_2">Text editors and command lines</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-1_2_1_3">Browsers</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-1_2_1_4">A note about tools</a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-rubygems"><span class="number">1.2.2</span> Ruby, RubyGems, Rails, and Git</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-rails_installer_windows">Rails Installer (Windows)</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-install_git">Install Git</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-install_ruby">Install Ruby</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-install_rubygems">Install RubyGems</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-install_rails">Install Rails</a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-the_first_application"><span class="number">1.2.3</span> The first application</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-bundler"><span class="number">1.2.4</span> Bundler</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-rails_server"><span class="number">1.2.5</span> <tt>rails server</tt></a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-mvc"><span class="number">1.2.6</span> Model-view-controller (MVC)</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-version_control"><span class="number">1.3</span> Version control with Git</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-git_setup"><span class="number">1.3.1</span> Installation and setup</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-1_3_1_1">First-time system setup</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-1_3_1_2">First-time repository setup</a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-adding_and_committing"><span class="number">1.3.2</span> Adding and committing</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-1_3_3"><span class="number">1.3.3</span> What good does Git do you?</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-github"><span class="number">1.3.4</span> GitHub</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-git_commands"><span class="number">1.3.5</span> Branch, edit, commit, merge</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-git_branch">Branch</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-git_edit">Edit</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-git_commit">Commit</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-git_merge">Merge</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-git_push">Push</a></li></ol></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-deploying"><span class="number">1.4</span> Deploying</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-heroku_setup"><span class="number">1.4.1</span> Heroku setup</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-heroku_step_one"><span class="number">1.4.2</span> Heroku deployment, step one</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-1_4_3"><span class="number">1.4.3</span> Heroku deployment, step two</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-heroku_commands"><span class="number">1.4.4</span> Heroku commands</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/beginning#sec-beginning_conclusion"><span class="number">1.5</span> Conclusion</a></li></ol></li><li class="chapter"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#top"><span class="number">Chapter 2</span> A demo app</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-planning_the_application"><span class="number">2.1</span> Planning the application</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-modeling_demo_users"><span class="number">2.1.1</span> Modeling demo users</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-modeling_demo_microposts"><span class="number">2.1.2</span> Modeling demo microposts</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-demo_users_resource"><span class="number">2.2</span> The Users resource</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-a_user_tour"><span class="number">2.2.1</span> A user tour</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-mvc_in_action"><span class="number">2.2.2</span> MVC in action</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-weaknesses_of_this_users_resource"><span class="number">2.2.3</span> Weaknesses of this Users resource</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-microposts_resource"><span class="number">2.3</span> The Microposts resource</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-a_micropost_microtour"><span class="number">2.3.1</span> A micropost microtour</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-putting_the_micro_in_microposts"><span class="number">2.3.2</span> Putting the <em>micro</em> in microposts</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-demo_user_has_many_microposts"><span class="number">2.3.3</span> A user <tt>has_many</tt> microposts</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-inheritance_hierarchies"><span class="number">2.3.4</span> Inheritance hierarchies</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-deploying_the_demo_app"><span class="number">2.3.5</span> Deploying the demo app</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/a-demo-app#sec-2_4"><span class="number">2.4</span> Conclusion</a></li></ol></li><li class="chapter"><a href="http://ruby.railstutorial.org/chapters/static-pages#top"><span class="number">Chapter 3</span> Mostly static pages</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-static_pages"><span class="number">3.1</span> Static pages</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-truly_static_pages"><span class="number">3.1.1</span> Truly static pages</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-static_pages_with_rails"><span class="number">3.1.2</span> Static pages with Rails</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-first_tests"><span class="number">3.2</span> Our first tests</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-TDD"><span class="number">3.2.1</span> Test-driven development</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-adding_a_page"><span class="number">3.2.2</span> Adding a page</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-red">Red</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-green">Green</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-refactor">Refactor</a></li></ol></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-slightly_dynamic_pages"><span class="number">3.3</span> Slightly dynamic pages</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-testing_a_title_change"><span class="number">3.3.1</span> Testing a title change</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-passing_title_tests"><span class="number">3.3.2</span> Passing title tests</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-embedded_ruby"><span class="number">3.3.3</span> Embedded Ruby</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-layouts"><span class="number">3.3.4</span> Eliminating duplication with layouts</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-static_pages_conclusion"><span class="number">3.4</span> Conclusion</a></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-static_pages_exercises"><span class="number">3.5</span> Exercises</a></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-advanced_setup"><span class="number">3.6</span> Advanced setup</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-eliminating_bundle_exec"><span class="number">3.6.1</span> Eliminating <tt>bundle exec</tt></a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-rvm_bundler_integration">RVM Bundler integration</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-binstubs">binstubs</a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-guard"><span class="number">3.6.2</span> Automated tests with Guard</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-spork"><span class="number">3.6.3</span> Speeding up tests with Spork</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-spork_and_guard">Guard with Spork</a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/static-pages#sec-tests_inside_sublime_text"><span class="number">3.6.4</span> Tests inside Sublime Text</a></li></ol></li></ol></li><li class="chapter"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#top"><span class="number">Chapter 4</span> Rails-flavored Ruby</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-motivation"><span class="number">4.1</span> Motivation</a></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-strings_and_methods"><span class="number">4.2</span> Strings and methods</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-comments"><span class="number">4.2.1</span> Comments</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-strings"><span class="number">4.2.2</span> Strings</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-printing">Printing</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-single_quoted_strings">Single-quoted strings</a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-objects_and_message_passing"><span class="number">4.2.3</span> Objects and message passing</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-method_definitions"><span class="number">4.2.4</span> Method definitions</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-back_to_the_title_helper"><span class="number">4.2.5</span> Back to the title helper</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-other_data_structures"><span class="number">4.3</span> Other data structures</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-arrays_and_ranges"><span class="number">4.3.1</span> Arrays and ranges</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-blocks"><span class="number">4.3.2</span> Blocks</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-hashes_and_symbols"><span class="number">4.3.3</span> Hashes and symbols</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-css_revisited"><span class="number">4.3.4</span> CSS revisited</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-ruby_classes"><span class="number">4.4</span> Ruby classes</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-constructors"><span class="number">4.4.1</span> Constructors</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-a_class_of_our_own"><span class="number">4.4.2</span> Class inheritance</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-modifying_built_in_classes"><span class="number">4.4.3</span> Modifying built-in classes</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-a_controller_class"><span class="number">4.4.4</span> A controller class</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-a_user_class"><span class="number">4.4.5</span> A user class</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-conclusion"><span class="number">4.5</span> Conclusion</a></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-exercises"><span class="number">4.6</span> Exercises</a></li></ol></li><li class="chapter"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#top"><span class="number">Chapter 5</span> Filling in the layout</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-structure"><span class="number">5.1</span> Adding some structure</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-adding_to_the_layout"><span class="number">5.1.1</span> Site navigation</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-custom_css"><span class="number">5.1.2</span> Bootstrap and custom CSS</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-partials"><span class="number">5.1.3</span> Partials</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-sass_and_the_asset_pipeline"><span class="number">5.2</span> Sass and the asset pipeline</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-the_asset_pipeline"><span class="number">5.2.1</span> The asset pipeline</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-5_2_1_1">Asset directories</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-5_2_1_2">Manifest files</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-5_2_1_3">Preprocessor engines</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-5_2_1_4">Efficiency in production</a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-sass"><span class="number">5.2.2</span> Syntactically awesome stylesheets</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-5_2_2_1">Nesting</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-5_2_2_2">Variables</a></li></ol></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-layout_links"><span class="number">5.3</span> Layout links</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-route_tests"><span class="number">5.3.1</span> Route tests</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-rails_routes"><span class="number">5.3.2</span> Rails routes</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-named_routes"><span class="number">5.3.3</span> Named routes</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-pretty_rspec"><span class="number">5.3.4</span> Pretty RSpec</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-user_signup"><span class="number">5.4</span> User signup: A first step</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-users_controller"><span class="number">5.4.1</span> Users controller</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-signup_url"><span class="number">5.4.2</span> Signup URI</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-layout_conclusion"><span class="number">5.5</span> Conclusion</a></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-layout_exercises"><span class="number">5.6</span> Exercises</a></li></ol></li><li class="chapter"><a href="http://ruby.railstutorial.org/chapters/modeling-users#top"><span class="number">Chapter 6</span> Modeling users</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-user_model"><span class="number">6.1</span> User model</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-database_migrations"><span class="number">6.1.1</span> Database migrations</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-the_model_file"><span class="number">6.1.2</span> The model file</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-model_annotation">Model annotation</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-accessible_attributes">Accessible attributes</a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-creating_user_objects"><span class="number">6.1.3</span> Creating user objects</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-finding_user_objects"><span class="number">6.1.4</span> Finding user objects</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-updating_user_objects"><span class="number">6.1.5</span> Updating user objects</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-user_validations"><span class="number">6.2</span> User validations</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-initial_user_tests"><span class="number">6.2.1</span> Initial user tests</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-presence_validation"><span class="number">6.2.2</span> Validating presence</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-length_validation"><span class="number">6.2.3</span> Length validation</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-format_validation"><span class="number">6.2.4</span> Format validation</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-uniqueness_validation"><span class="number">6.2.5</span> Uniqueness validation</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-the_caveat">The uniqueness caveat</a></li></ol></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-adding_a_secure_password"><span class="number">6.3</span> Adding a secure password</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-an_encrypted_password"><span class="number">6.3.1</span> An encrypted password</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-password_and_confirmation"><span class="number">6.3.2</span> Password and confirmation</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-user_authentication"><span class="number">6.3.3</span> User authentication</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-has_secure_password"><span class="number">6.3.4</span> User has secure password</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-creating_a_user"><span class="number">6.3.5</span> Creating a user</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-6_4"><span class="number">6.4</span> Conclusion</a></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/modeling-users#sec-6_5"><span class="number">6.5</span> Exercises</a></li></ol></li><li class="chapter"><a href="http://ruby.railstutorial.org/chapters/sign-up#top"><span class="number">Chapter 7</span> Sign up</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-showing_users"><span class="number">7.1</span> Showing users</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-rails_environments"><span class="number">7.1.1</span> Debug and Rails environments</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-a_users_resource"><span class="number">7.1.2</span> A Users resource</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-tests_with_factories"><span class="number">7.1.3</span> Testing the user show page (with factories)</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-a_gravatar_image"><span class="number">7.1.4</span> A Gravatar image and a sidebar</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-signup_form"><span class="number">7.2</span> Signup form</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-tests_for_user_signup"><span class="number">7.2.1</span> Tests for user signup</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-using_form_for"><span class="number">7.2.2</span> Using <tt>form_for</tt></a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-the_form_html"><span class="number">7.2.3</span> The form HTML</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-signup_failure"><span class="number">7.3</span> Signup failure</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-a_working_form"><span class="number">7.3.1</span> A working form</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-signup_error_messages"><span class="number">7.3.2</span> Signup error messages</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-signup_success"><span class="number">7.4</span> Signup success</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-the_finished_signup_form"><span class="number">7.4.1</span> The finished signup form</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-the_flash"><span class="number">7.4.2</span> The flash</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-the_first_signup"><span class="number">7.4.3</span> The first signup</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-deploying_to_production_with_ssl"><span class="number">7.4.4</span> Deploying to production with SSL</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-7_5"><span class="number">7.5</span> Conclusion</a></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-up#sec-signup_exercises"><span class="number">7.6</span> Exercises</a></li></ol></li><li class="chapter"><a href="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out.html"><span class="number">Chapter 8</span> Sign in, sign out</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_failure"><span class="number">8.1</span> Sessions and signin failure</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-sessions_controller"><span class="number">8.1.1</span> Sessions controller</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_tests"><span class="number">8.1.2</span> Signin tests</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_form"><span class="number">8.1.3</span> Signin form</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-reviewing_form_submission"><span class="number">8.1.4</span> Reviewing form submission</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-rendering_with_a_flash_message"><span class="number">8.1.5</span> Rendering with a flash message</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_success"><span class="number">8.2</span> Signin success</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-remember_me"><span class="number">8.2.1</span> Remember me</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-a_working_sign_in_method"><span class="number">8.2.2</span> A working <tt>sign_in</tt> method</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-current_user"><span class="number">8.2.3</span> Current user</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-changing_the_layout_links"><span class="number">8.2.4</span> Changing the layout links</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_upon_signup"><span class="number">8.2.5</span> Signin upon signup</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signing_out"><span class="number">8.2.6</span> Signing out</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-cucumber"><span class="number">8.3</span> Introduction to Cucumber (optional)</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-installation_and_setup"><span class="number">8.3.1</span> Installation and setup</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-features_and_steps"><span class="number">8.3.2</span> Features and steps</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-rspec_custom_matchers"><span class="number">8.3.3</span> Counterpoint: RSpec custom matchers</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-8_4"><span class="number">8.4</span> Conclusion</a></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-sign_in_out_exercises"><span class="number">8.5</span> Exercises</a></li></ol></li><li class="chapter"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#top"><span class="number">Chapter 9</span> Updating, showing, and deleting users</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-updating_users"><span class="number">9.1</span> Updating users</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-edit_form"><span class="number">9.1.1</span> Edit form</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-unsuccessful_edits"><span class="number">9.1.2</span> Unsuccessful edits</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-successful_edits"><span class="number">9.1.3</span> Successful edits</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-authorization"><span class="number">9.2</span> Authorization</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-requiring_signed_in_users"><span class="number">9.2.1</span> Requiring signed-in users</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-requiring_the_right_user"><span class="number">9.2.2</span> Requiring the right user</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-friendly_forwarding"><span class="number">9.2.3</span> Friendly forwarding</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-showing_all_users"><span class="number">9.3</span> Showing all users</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-user_index"><span class="number">9.3.1</span> User index</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-sample_users"><span class="number">9.3.2</span> Sample users</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-pagination"><span class="number">9.3.3</span> Pagination</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-partial_refactoring"><span class="number">9.3.4</span> Partial refactoring</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-destroying_users"><span class="number">9.4</span> Deleting users</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-administrative_users"><span class="number">9.4.1</span> Administrative users</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-revisiting_attr_accessible">Revisiting <tt>attr_accessible</tt></a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-the_destroy_action"><span class="number">9.4.2</span> The <tt>destroy</tt> action</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-updating_and_deleting_users_conclusion"><span class="number">9.5</span> Conclusion</a></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-updating_deleting_exercises"><span class="number">9.6</span> Exercises</a></li></ol></li><li class="chapter"><a href="http://ruby.railstutorial.org/chapters/user-microposts#top"><span class="number">Chapter 10</span> User microposts</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-a_micropost_model"><span class="number">10.1</span> A Micropost model</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-the_basic_model"><span class="number">10.1.1</span> The basic model</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-accessible_attribute"><span class="number">10.1.2</span> Accessible attributes and the first validation</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-user_micropost_associations"><span class="number">10.1.3</span> User/Micropost associations</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-ordering_and_dependency"><span class="number">10.1.4</span> Micropost refinements</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-default_scope">Default scope</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-dependent_destroy">Dependent: destroy</a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-micropost_validations"><span class="number">10.1.5</span> Content validations</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-showing_microposts"><span class="number">10.2</span> Showing microposts</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-augmenting_the_user_show_page"><span class="number">10.2.1</span> Augmenting the user show page</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-sample_microposts"><span class="number">10.2.2</span> Sample microposts</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-manipulating_microposts"><span class="number">10.3</span> Manipulating microposts</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-access_control"><span class="number">10.3.1</span> Access control</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-creating_microposts"><span class="number">10.3.2</span> Creating microposts</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-a_proto_feed"><span class="number">10.3.3</span> A proto-feed</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-destroying_microposts"><span class="number">10.3.4</span> Destroying microposts</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-10_4"><span class="number">10.4</span> Conclusion</a></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/user-microposts#sec-micropost_exercises"><span class="number">10.5</span> Exercises</a></li></ol></li><li class="chapter"><a href="http://ruby.railstutorial.org/chapters/following-users#top"><span class="number">Chapter 11</span> Following users</a></li><li><ol><li class="section"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-the_relationship_model"><span class="number">11.1</span> The Relationship model</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-a_problem_with_the_data_model"><span class="number">11.1.1</span> A problem with the data model (and a solution)</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-relationship_user_associations"><span class="number">11.1.2</span> User/relationship associations</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-relationship_validations"><span class="number">11.1.3</span> Validations</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-following"><span class="number">11.1.4</span> Followed users</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-followers"><span class="number">11.1.5</span> Followers</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-a_web_interface_for_following_and_followers"><span class="number">11.2</span> A web interface for following users</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-sample_following_data"><span class="number">11.2.1</span> Sample following data</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-stats_and_a_follow_form"><span class="number">11.2.2</span> Stats and a follow form</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-following_and_followers_pages"><span class="number">11.2.3</span> Following and followers pages</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-a_working_follow_button_the_standard_way"><span class="number">11.2.4</span> A working follow button the standard way</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-a_working_follow_button_with_ajax"><span class="number">11.2.5</span> A working follow button with Ajax</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-the_status_feed"><span class="number">11.3</span> The status feed</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-motivation_and_strategy"><span class="number">11.3.1</span> Motivation and strategy</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-a_first_feed_implementation"><span class="number">11.3.2</span> A first feed implementation</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-scopes_subselects_and_a_lambda"><span class="number">11.3.3</span> Subselects</a></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-the_new_status_feed"><span class="number">11.3.4</span> The new status feed</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-following_conclusion"><span class="number">11.4</span> Conclusion</a></li><li><ol><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-extensions_to_the_sample_application"><span class="number">11.4.1</span> Extensions to the sample application</a></li><li><ol><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-replies">Replies</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-messaging">Messaging</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-follower_notifications">Follower notifications</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-password_reminders">Password reminders</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-signup_confirmation">Signup confirmation</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-rss_feed">RSS feed</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-rest_api">REST API</a></li><li class="subsubsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-search">Search</a></li></ol></li><li class="subsection"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-guide_to_further_resources"><span class="number">11.4.2</span> Guide to further resources</a></li></ol></li><li class="section"><a href="http://ruby.railstutorial.org/chapters/following-users#sec-following_exercises"><span class="number">11.5</span> Exercises</a></li></ol></li></ol></div>


<div id="main_content"></div>


<p> <span class="preamble">
 <span id="foreword">
<strong> Foreword</strong> <br>
 </span>
 </span></p>

<p>My former company (CD Baby) was one of the first to loudly switch to Ruby on Rails, and then even more loudly switch back to PHP (Google me to read about the drama). This book by Michael Hartl came so highly recommended that I had to try it, and the <em>Ruby on Rails Tutorial</em> is what I used to switch back to Rails again.</p>

<p>Though I’ve worked my way through many Rails books, this is the one that finally made me “get” it. Everything is done very much “the Rails way”—a way that felt very unnatural to me before, but now after doing this book finally feels natural. This is also the only Rails book that does test-driven development the entire time, an approach highly recommended by the experts but which has never been so clearly demonstrated before. Finally, by including Git, GitHub, and Heroku in the demo examples, the author really gives you a feel for what it’s like to do a real-world project. The tutorial’s code examples are not in isolation.</p>

<p>The linear narrative is such a great format. Personally, I powered through the <em>Rails Tutorial</em> in three long days, doing all the examples and challenges at the end of each chapter. Do it from start to finish, without jumping around, and you’ll get the ultimate benefit.</p>

<p>Enjoy!</p>

<p><a href="http://sivers.org/">Derek Sivers</a> (<a href="http://sivers.org/">sivers.org</a>) <br>
<em>Formerly: Founder,</em> <a href="http://www.cdbaby.com/"><em>CD Baby</em></a> <br>
<em>Currently: Founder,</em> <a href="http://thoughts.pro/"><em>Thoughts Ltd.</em></a> <br></p>

<p> <span class="preamble">
<strong> Acknowledgments</strong> <br>
 </span></p>

<p>The <em>Ruby on Rails Tutorial</em> owes a lot to my previous Rails book, <em>RailsSpace</em>, and hence to my coauthor <a href="http://aure.com/">Aurelius Prochazka</a>. I’d like to thank Aure both for the work he did on that book and for his support of this one. I’d also like to thank Debra Williams Cauley, my editor on both <em>RailsSpace</em> and the <em>Ruby on Rails Tutorial</em>; as long as she keeps taking me to baseball games, I’ll keep writing books for her.</p>

<p>I’d like to acknowledge a long list of Rubyists who have taught and inspired me over the years: David Heinemeier Hansson, Yehuda Katz, Carl Lerche, Jeremy Kemper, Xavier Noria, Ryan Bates, Geoffrey Grosenbach, Peter Cooper, Matt Aimonetti, Gregg Pollack, Wayne&nbsp;E. Seguin, Amy Hoy, Dave Chelimsky, Pat Maddox, Tom Preston-Werner, Chris Wanstrath, Chad Fowler, Josh Susser, Obie Fernandez, Ian McFarland, Steven Bristol, Pratik Naik, Sarah Mei, Sarah Allen, Wolfram Arnold, Alex Chaffee, Giles Bowkett, Evan Dorn, Long Nguyen, James Lindenbaum, Adam Wiggins, Tikhon Bernstam, Ron Evans, Wyatt Greene, Miles Forrest, the good people at Pivotal Labs, the Heroku gang, the thoughtbot guys, and the GitHub crew. Finally, many, many readers—far too many to list—have contributed a huge number of bug reports and suggestions during the writing of this book, and I gratefully acknowledge their help in making it as good as it can&nbsp;be. <br></p>

<p> <span class="preamble">
 <span id="author">
<strong> About the author</strong> <br>
 </span>
 </span></p>

<p><a href="http://michaelhartl.com/">Michael Hartl</a> is the author of the <a href="http://ruby.railstutorial.org/"><em>Ruby on Rails Tutorial</em></a>, the leading introduction to web development with <a href="http://rubyonrails.org/">Ruby on Rails</a>. His prior experience includes writing and developing <em>RailsSpace</em>, an extremely obsolete Rails tutorial book, and developing Insoshi, a once-popular and now-obsolete social networking platform in Ruby on Rails. In 2011, Michael received a <a href="http://rubyheroes.com/heroes">Ruby Hero Award</a> for his contributions to the Ruby community. He is a graduate of <a href="http://college.harvard.edu/">Harvard College</a>, has a <a href="http://resolver.caltech.edu/CaltechETD:etd-05222003-161626">Ph.D. in Physics</a> from <a href="http://www.caltech.edu/">Caltech</a>, and is an alumnus of the <a href="http://ycombinator.com/">Y&nbsp;Combinator</a> entrepreneur program. <br></p>

<p> <span id="license" class="preamble">
<strong> Copyright and license</strong> <br>
 </span></p>

<p><em>Ruby on Rails Tutorial: Learn Web Development with Rails</em>. Copyright © 2012 by Michael Hartl. All source code in the <em>Ruby on Rails Tutorial</em> is available jointly under the <a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a> and the <a href="http://people.freebsd.org/~phk/">Beerware License</a>.</p>

<div class="code"><div class="highlight"><pre>The MIT License

Copyright (c) 2012 Michael Hartl

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
</pre></div>
</div>


<div class="code"><div class="highlight"><pre>/*
 * ----------------------------------------------------------------------------
 * "THE BEER-WARE LICENSE" (Revision 42):
 * Michael Hartl wrote this code. As long as you retain this notice you
 * can do whatever you want with this stuff. If we meet some day, and you think
 * this stuff is worth it, you can buy me a beer in return.
 * ----------------------------------------------------------------------------
 */
</pre></div>
</div>


<div id="top"></div>


<h1 class="chapter"><a id="sec-8" href="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out.html" class="heading"><span class="number">Chapter 8</span> Sign in, sign out</a></h1>


<p>Now that new users can sign up for our site (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#top">Chapter&nbsp;7</a>), it’s time to give registered users the ability to sign in and sign out. This will allow us to add customizations based on signin status and based on the identity of the current user. For example, in this chapter we’ll update the site header with signin/signout links and a profile link. In <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#top">Chapter&nbsp;10</a>, we’ll use the identity of a signed-in user to create microposts associated with that user, and in <a class="ref" href="http://ruby.railstutorial.org/chapters/following-users#top">Chapter&nbsp;11</a> we’ll allow the current user to follow other users of the application (thereby receiving a feed of their microposts).</p>

<p>Having users sign in will also allow us to implement a security model, restricting access to particular pages based on the identity of the signed-in user. For instance, as we’ll see in <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#top">Chapter&nbsp;9</a>, only signed-in users will be able to access the page used to edit user information. The signin system will also make possible special privileges for administrative users, such as the ability (also introduced in <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#top">Chapter&nbsp;9</a>) to delete users from the database.</p>

<p>After implementing the core authentication machinery, we’ll take a short detour to investigate <em>Cucumber</em>, a popular system for behavior-driven development (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-cucumber">Section&nbsp;8.3</a>). In particular, we’ll re-implement a couple of the RSpec integration tests in Cucumber to see how the two methods compare.</p>

<p>As in previous chapters, we’ll do our work on a topic branch and merge in the changes at the end:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b sign-in-out
</pre></div>
</div>


<div class="label" id="sec-signin_failure"></div>


<h2><a id="sec-8_1" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_failure" class="heading"><span class="number">8.1</span> Sessions and signin failure</a></h2>


<p>A <a href="http://en.wikipedia.org/wiki/Session_(computer_science)"><em>session</em></a> is a semi-permanent connection between two computers, such as a client computer running a web browser and a server running Rails. We’ll be using sessions to implement the common pattern of “signing in”, and in this context there are several different models for session behavior common on the web: “forgetting” the session on browser close, using an optional “remember me” checkbox for persistent sessions, and automatically remembering sessions until the user explicitly signs out.<sup class="footnote" id="fnref-8_1"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fn-8_1">1</a></sup> We’ll opt for the final of these options: when users sign in, we will remember their signin status “forever”, clearing the session only when the user explicitly signs out. (We’ll see in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-remember_me">Section&nbsp;8.2.1</a> just how long “forever” is.)</p>

<p>It’s convenient to model sessions as a RESTful resource: we’ll have a signin page for <em>new</em> sessions, signing in will <em>create</em> a session, and signing out will <em>destroy</em> it. Unlike the Users resource, which uses a database back-end (via the User model) to persist data, the Sessions resource will use a <a href="http://en.wikipedia.org/wiki/HTTP_cookie"><em>cookie</em></a>, which is a small piece of text placed on the user’s browser. Much of the work involved in signin comes from building this cookie-based authentication machinery. In this section and the next, we’ll prepare for this work by constructing a Sessions controller, a signin form, and the relevant controller actions. We’ll then complete user signin in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_success">Section&nbsp;8.2</a> by adding the necessary cookie-manipulation code.</p>

<div class="label" id="sec-sessions_controller"></div>


<h3><a id="sec-8_1_1" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-sessions_controller" class="heading"><span class="number">8.1.1</span> Sessions controller</a></h3>


<p>The elements of signing in and out correspond to particular REST actions of the Sessions controller: the signin form is handled by the <code>new</code> action (covered in  this section), actually signing in is handled by sending a <tt>POST</tt> request to the <code>create</code> action (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_failure">Section&nbsp;8.1</a> and <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_success">Section&nbsp;8.2</a>), and signing out is handled by sending a <tt>DELETE</tt> request to the <code>destroy</code> action (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signing_out">Section&nbsp;8.2.6</a>). (Recall the association of HTTP verbs with REST actions from <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#table-RESTful_users">Table&nbsp;7.1</a>.) To get started, we’ll generate a Sessions controller and an integration test for the authentication machinery:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Sessions --no-test-framework
<span class="gp">$</span> rails generate integration_test authentication_pages
</pre></div>
</div>


<p>Following the model from <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#sec-signup_form">Section&nbsp;7.2</a> for the signup page, we’ll create a signin form for creating new sessions, as mocked up in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fig-signin_mockup">Figure&nbsp;8.1</a>.</p>

<div class="label" id="fig-signin_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/signin_mockup_bootstrap.png" alt="signin_mockup_bootstrap"></span></div><div class="caption"><span class="header">Figure 8.1: </span><span class="description">A mockup of the signin form.&nbsp;<a href="http://railstutorial.org/images/figures/signin_mockup_bootstrap-full.png">(full size)</a></span></div></div>


<p>The signin page will live at the URI given by <code>signin_path</code> (defined momentarily), and as usual we’ll start with a minimalist test, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-new_session_tests">Listing&nbsp;8.1</a>. (Compare to the analogous code for the signup page in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#code-initial_signup_test">Listing&nbsp;7.6</a>.)</p>

<div class="label" id="code-new_session_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.1.</span> <span class="description">Tests for the <code>new</code> session action and view. <br> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"signin page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'h1'</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The tests initially fail, as required:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>To get the tests in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-new_session_tests">Listing&nbsp;8.1</a> to pass, we first need to define routes for the Sessions resource, together with a custom named route for the signin page (which we’ll map to the Session controller’s <code>new</code> action). As with the Users resource, we can use the <code>resources</code> method to define the standard RESTful routes:</p>

<div class="code"><div class="highlight"><pre><span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
</pre></div>
</div>


<p>Since we have no need to show or edit sessions, we’ve restricted the actions to <code>new</code>, <code>create</code>, and <code>destroy</code> using the <code>:only</code> option accepted by <code>resources</code>. The full result, including named routes for signin and signout, appears in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-sessions_resource">Listing&nbsp;8.2</a>.</p>

<div class="label" id="code-sessions_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.2.</span> <span class="description">Adding a resource to get the standard RESTful actions for sessions. <br> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>

  <span class="n">match</span> <span class="s1">'/signup'</span><span class="p">,</span>  <span class="ss">to:</span> <span class="s1">'users#new'</span>
  <span class="n">match</span> <span class="s1">'/signin'</span><span class="p">,</span>  <span class="ss">to:</span> <span class="s1">'sessions#new'</span>
  <span class="n">match</span> <span class="s1">'/signout'</span><span class="p">,</span> <span class="ss">to:</span> <span class="s1">'sessions#destroy'</span><span class="p">,</span> <span class="ss">via:</span> <span class="ss">:delete</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note the use of <code>via: :delete</code> for the signout route, which indicates that it should be invoked using an HTTP <tt>DELETE</tt> request.</p>

<p>The resources defined in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-sessions_resource">Listing&nbsp;8.2</a> provide URIs and actions similar to those for users (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#table-RESTful_users">Table&nbsp;7.1</a>), as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#table-RESTful_sessions">Table&nbsp;8.1</a>. Note that the routes for signin and signout are custom, but the route for creating a session is simply the default (i.e., <code>[resource name]_path</code>).</p>

<div class="label" id="table-RESTful_sessions"></div>


<div class="table"><div class="center">
<table class="tabular"><tbody><tr><th class="align_left"><strong>HTTP request</strong></th><th class="align_left"><strong>URI</strong></th><th class="align_left"><strong>Named route</strong></th><th class="align_left"><strong>Action</strong></th><th class="align_left"><strong>Purpose</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>GET</tt></td><td class="align_left">/signin</td><td class="align_left"><code>signin_path</code></td><td class="align_left"><code>new</code></td><td class="align_left">page for  a new session (signin)</td></tr><tr><td class="align_left"><tt>POST</tt></td><td class="align_left">/sessions</td><td class="align_left"><code>sessions_path</code></td><td class="align_left"><code>create</code></td><td class="align_left">create a new session</td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left">/signout</td><td class="align_left"><code>signout_path</code></td><td class="align_left"><code>destroy</code></td><td class="align_left">delete a session (sign out)</td></tr></tbody></table></div><div class="caption"><span class="header">Table 8.1: </span><span class="description">RESTful routes provided by the sessions rules in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-sessions_resource">Listing&nbsp;8.2</a>.</span></div></div>


<p>The next step to get the tests in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-new_session_tests">Listing&nbsp;8.1</a> to pass is to add a <code>new</code> action to the Sessions controller, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-new_session_title">Listing&nbsp;8.3</a> (which also defines the <code>create</code> and <code>destroy</code> actions for future reference).</p>

<div class="label" id="code-new_session_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.3.</span> <span class="description">The initial Sessions controller. <br> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The final step is to define the initial version of the signin page. Note that, since it is the page for a new session, the signin page lives in the file <code>app/views/sessions/new.html.erb</code>, which we have to create. The contents, which for now only define the page title and top-level heading, appear as in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-initial_signin_page">Listing&nbsp;8.4</a>.</p>

<div class="label" id="code-initial_signin_page"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.4.</span> <span class="description">The initial signin view. <br> <code>app/views/sessions/new.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Sign in"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign in<span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div></div>


<p>With that, the tests in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-new_session_tests">Listing&nbsp;8.1</a> should be passing, and we’re ready to make the actual signin form.</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-signin_tests"></div>


<h3><a id="sec-8_1_2" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_tests" class="heading"><span class="number">8.1.2</span> Signin tests</a></h3>


<p>Comparing <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fig-signin_mockup">Figure&nbsp;8.1</a> with <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#fig-signup_mockup">Figure&nbsp;7.11</a>, we see that the signin form (or, equivalently, the new session form) is similar in appearance to the signup form, except with two fields (email and password) in place of four. As with the signup form, we can test the signin form by using Capybara to fill in the form values and then click the button.</p>

<p>In the process of writing the tests, we’ll be forced to design aspects of the application, which is one of the nice side-effects of test-driven development. We’ll start with invalid signin, as mocked up in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fig-signin_failure_mockup">Figure&nbsp;8.2</a>.</p>

<div class="label" id="fig-signin_failure_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/signin_failure_mockup_bootstrap.png" alt="signin_failure_mockup_bootstrap"></span></div><div class="caption"><span class="header">Figure 8.2: </span><span class="description">A mockup of signin failure.&nbsp;<a href="http://railstutorial.org/images/figures/signin_failure_mockup_bootstrap-full.png">(full size)</a></span></div></div>


<p>As seen in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fig-signin_failure_mockup">Figure&nbsp;8.2</a>, when the signin information is invalid we want to re-render the signin page and display an error message. We’ll render the error as a flash message, which we can test for as follows:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">'Invalid'</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>(We saw similar code in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#code-after_save_tests">Listing&nbsp;7.32</a> from the exercises in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#top">Chapter&nbsp;7</a>.) Here the selector element (i.e., the tag) we’re looking for is</p>

<div class="code"><div class="highlight"><pre><span class="n">div</span><span class="o">.</span><span class="n">alert</span><span class="o">.</span><span class="n">alert</span><span class="o">-</span><span class="n">error</span>
</pre></div>
</div>


<p>Recalling that the dot means “class” in CSS (<a class="ref" href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-custom_css">Section&nbsp;5.1.2</a>), you might be able to guess that this tests for a <code>div</code> tag with the classes <code>"alert"</code> and <code>"alert-error"</code>. We also test that the error message contains the text <code>"Invalid"</code>. Putting these together, the test looks for an element of the following form:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-error"</span><span class="nt">&gt;</span>Invalid...<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>Combining the title and flash tests gives the code in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-initial_failing_signin_test">Listing&nbsp;8.5</a>. As we’ll see, these tests miss an important subtlety, which we’ll address in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-rendering_with_a_flash_message">Section&nbsp;8.1.5</a>.</p>

<div class="label" id="code-initial_failing_signin_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.5.</span> <span class="description">The tests for signin failure. <br> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"signin"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"with invalid information"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Sign in"</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">'Invalid'</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Having written tests for signin failure, we now turn to signin success. The changes we’ll test for are the rendering of the user’s profile page (as determined by the page title, which should be the user’s name), together with three planned changes to the site navigation:</p>

<ol>
<li>The appearance of a link to the profile page</li>
<li>The appearance of a “Sign out” link</li>
<li>The disappearance of the “Sign in” link</li>
</ol>


<p>(We’ll defer the test for the “Settings” link to <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-updating_users">Section&nbsp;9.1</a> and for the “Users” link to <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-showing_all_users">Section&nbsp;9.3</a>.) A mockup of these changes appears in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fig-signin_success_mockup">Figure&nbsp;8.3</a>.<sup class="footnote" id="fnref-8_2"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fn-8_2">2</a></sup> Note that the signout and profile links appear in a dropdown “Account” menu; in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-changing_the_layout_links">Section&nbsp;8.2.4</a>, we’ll see how to make such a menu with Bootstrap.</p>

<div class="label" id="fig-signin_success_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/signin_success_mockup_bootstrap.png" alt="signin_success_mockup_bootstrap"></span></div><div class="caption"><span class="header">Figure 8.3: </span><span class="description">A mockup of the user profile after a successful signin.&nbsp;<a href="http://railstutorial.org/images/figures/signin_success_mockup_bootstrap-full.png">(full size)</a></span></div></div>


<p>The test code for signin success appears in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-signin_success_tests">Listing&nbsp;8.6</a>.</p>

<div class="label" id="code-signin_success_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.6.</span> <span class="description">Test for signin success. <br> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"signin"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
        <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">click_button</span> <span class="s2">"Sign in"</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Profile'</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign out'</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here we’ve used the <code>have_link</code> method. It takes as arguments the text of the link and an optional <code>:href</code> parameter, so that</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Profile'</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
</pre></div>
</div>


<p>ensures that the anchor tag&nbsp;<code>a</code> has the right <code>href</code> (URI) attribute—in this case, a link to the user’s profile page. Note also that we take care to <code>upcase</code> the user’s email address to make sure our ability to find the user in the database is case-insensitive.</p>

<div class="label" id="sec-signin_form"></div>


<h3><a id="sec-8_1_3" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_form" class="heading"><span class="number">8.1.3</span> Signin form</a></h3>


<p>With our tests in place, we’re ready to start developing the signin form. Recall from <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#code-signup_form">Listing&nbsp;7.17</a> that the signup form uses the <code>form_for</code> helper, taking as an argument the user instance variable <code>@user</code>:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>The main difference between this and the signin form is that we have no Session model, and hence no analogue for the <code>@user</code> variable. This means that, in constructing the new session form, we have to give <code>form_for</code> slightly more information; in particular, whereas</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</pre></div>
</div>


<p>allows Rails to infer that the <code>action</code> of the form should be to <tt>POST</tt> to the URI /users, in the case of sessions we need to indicate the <em>name</em> of the resource and the corresponding URI:</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url:</span> <span class="n">sessions_path</span><span class="p">)</span>
</pre></div>
</div>


<p>(A second option is to use <code>form_tag</code> in place of <code>form_for</code>; this might be more even idiomatically correct Rails, but it has less in common with the signup form, and at this stage I want to emphasize the parallel structure. Making a working form with <code>form_tag</code> is left as an exercise (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-sign_in_out_exercises">Section&nbsp;8.5</a>).)</p>

<p>With the proper <code>form_for</code> in hand, it’s easy to make a signin form to match the mockup in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fig-signin_mockup">Figure&nbsp;8.1</a> using the signup form (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#code-signup_form">Listing&nbsp;7.17</a>) as a model, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-signin_form">Listing&nbsp;8.7</a>.</p>

<div class="label" id="code-signin_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.7.</span> <span class="description">Code for the signin form. <br> <code>app/views/sessions/new.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Sign in"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign in<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span6 offset3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url:</span> <span class="n">sessions_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Sign in"</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;p&gt;</span>New user? <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up now!"</span><span class="p">,</span> <span class="n">signup_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>Note that we’ve added a link to the signup page for convenience. With the code in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-signin_form">Listing&nbsp;8.7</a>, the signin form appears as in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fig-signin_form">Figure&nbsp;8.4</a>.</p>

<div class="label" id="fig-signin_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/signin_form_bootstrap.png" alt="signin_form_bootstrap"></span></div><div class="caption"><span class="header">Figure 8.4: </span><span class="description">The signin form  (<a href="http://localhost:3000/signin">/signin</a>).&nbsp;<a href="http://railstutorial.org/images/figures/signin_form_bootstrap-full.png">(full size)</a></span></div></div>


<p>Though you’ll soon get out of the habit of looking at the HTML generated by Rails (instead trusting the helpers to do their job), for now let’s take a look at it (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-signin_form_html">Listing&nbsp;8.8</a>).</p>

<div class="label" id="code-signin_form_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.8.</span> <span class="description">HTML for the signin form produced by <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-signin_form">Listing&nbsp;8.7</a>.</span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">accept-charset=</span><span class="s">"UTF-8"</span> <span class="na">action=</span><span class="s">"/sessions"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"session_email"</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"session_email"</span> <span class="na">name=</span><span class="s">"session[email]"</span> <span class="na">size=</span><span class="s">"30"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"session_password"</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"session_password"</span> <span class="na">name=</span><span class="s">"session[password]"</span> <span class="na">size=</span><span class="s">"30"</span> 
           <span class="na">type=</span><span class="s">"password"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"btn btn-large btn-primary"</span> <span class="na">name=</span><span class="s">"commit"</span> <span class="na">type=</span><span class="s">"submit"</span> 
       <span class="na">value=</span><span class="s">"Sign in"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div></div>


<p>Comparing <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-signin_form_html">Listing&nbsp;8.8</a> with <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#code-signup_form_html">Listing&nbsp;7.20</a>, you might be able to guess that submitting this form will result in a <code>params</code> hash where <code>params[:session][:email]</code> and <code>params[:session][:password]</code> correspond to the email and password fields.</p>

<div class="label" id="sec-reviewing_form_submission"></div>


<h3><a id="sec-8_1_4" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-reviewing_form_submission" class="heading"><span class="number">8.1.4</span> Reviewing form submission</a></h3>


<p>As in the case of creating users (signup), the first step in creating sessions (signin) is to handle <em>invalid</em> input. We already have tests for the signup failure (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-initial_failing_signin_test">Listing&nbsp;8.5</a>), and the application code is simple apart from a couple of subtleties. We’ll start by reviewing what happens when a form gets submitted, and then arrange for helpful error messages to appear in the case of signin failure (as mocked up in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fig-signin_failure_mockup">Figure&nbsp;8.2</a>.) Then we’ll lay the foundation for successful signin (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_success">Section&nbsp;8.2</a>) by evaluating each signin submission based on the validity of its email/password combination.</p>

<p>Let’s start by defining a minimalist <code>create</code> action for the Sessions controller (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-initial_create_session">Listing&nbsp;8.9</a>), which does nothing but render the <code>new</code> view. Submitting the <a href="http://localhost:3000/sessions/new">/sessions/new</a> form with blank fields then yields the result shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fig-initial_failed_signin_rails_3">Figure&nbsp;8.5</a>.</p>

<div class="label" id="code-initial_create_session"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.9.</span> <span class="description">A preliminary version of the Sessions <code>create</code> action. <br> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">render</span> <span class="s1">'new'</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="fig-initial_failed_signin_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/initial_failed_signin_rails_3_bootstrap.png" alt="initial_failed_signin_rails_3_bootstrap"></span></div><div class="caption"><span class="header">Figure 8.5: </span><span class="description">The initial failed signin, with <code>create</code> as in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-initial_create_session">Listing&nbsp;8.9</a>.&nbsp;<a href="http://railstutorial.org/images/figures/initial_failed_signin_rails_3_bootstrap-full.png">(full size)</a></span></div></div>


<p>Carefully inspecting the debug information in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fig-initial_failed_signin_rails_3">Figure&nbsp;8.5</a> shows that, as hinted at the end of <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_form">Section&nbsp;8.1.3</a>, the submission results in a <code>params</code> hash containing the email and password under the key <code>:session</code>:</p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">session</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="s">''</span>
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="s">''</span>
<span class="l-Scalar-Plain">commit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Sign in</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">create</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sessions</span>
</pre></div>
</div>


<p>As with the case of user signup (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#fig-signup_failure_rails_3">Figure&nbsp;7.15</a>) these parameters form a <em>nested</em> hash like the one we saw in <a class="ref" href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#code-nested_hashes">Listing&nbsp;4.6</a>. In particular, <code>params</code> contains a nested hash of the form</p>

<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">session:</span> <span class="p">{</span> <span class="ss">password:</span> <span class="s2">""</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">""</span> <span class="p">}</span> <span class="p">}</span>
</pre></div>
</div>


<p>
This means that</p>

<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">]</span>
</pre></div>
</div>


<p>is itself a hash:</p>

<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">password:</span> <span class="s2">""</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">""</span> <span class="p">}</span>
</pre></div>
</div>


<p>As a result,</p>

<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span>
</pre></div>
</div>


<p>is the submitted email address and</p>

<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span>
</pre></div>
</div>


<p>is the submitted password.</p>

<p>In other words, inside the <code>create</code> action the <code>params</code> hash has all the information needed to authenticate users by email and password. Not coincidentally, we already have exactly the methods we need: the <code>User.find_by_email</code> method provided by Active Record (<a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-users#sec-finding_user_objects">Section&nbsp;6.1.4</a>) and the  <code>authenticate</code> method provided by <code>has_secure_password</code> (<a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-users#sec-user_authentication">Section&nbsp;6.3.3</a>). Recalling that <code>authenticate</code> returns <code>false</code> for an invalid authentication, our strategy for user signin can be summarized as follows:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">create</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
    <span class="c1"># Sign the user in and redirect to the user's show page.</span>
  <span class="k">else</span>
    <span class="c1"># Create an error message and re-render the signin form.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>The first line here pulls the user out of the database using the submitted email address. (Recall from <a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-users#sec-uniqueness_validation">Section&nbsp;6.2.5</a> that email addresses are saved as all lower-case, so here we use the <code>downcase</code> method to ensure a match when the submitted address is valid.) The next line can be a bit confusing but is fairly common in idiomatic Rails programming:</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>This uses <code>&amp;&amp;</code> (logical <em>and</em>) to determine if the resulting user is valid. Taking into account that any object other than <code>nil</code> and <code>false</code> itself is <code>true</code> in a boolean context (<a class="ref" href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-objects_and_message_passing">Section&nbsp;4.2.3</a>), the possibilities appear as in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#table-user_and_and">Table&nbsp;8.2</a>. We see from <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#table-user_and_and">Table&nbsp;8.2</a> that the <code>if</code> statement is <code>true</code> only if a user with the given email both exists in the database and has the given password, exactly as required.</p>

<div class="label" id="table-user_and_and"></div>


<div class="table"><div class="center">
<table class="tabular"><tbody><tr><th class="align_left"><strong>User</strong></th><th class="align_left"><strong>Password</strong></th><th class="align_left"><strong>a &amp;&amp; b</strong></th></tr><tr class="top_bar"><td class="align_left">nonexistent</td><td class="align_left"><em>anything</em></td><td class="align_left"><code>nil &amp;&amp; [anything] == false</code></td></tr><tr><td class="align_left">valid user</td><td class="align_left">wrong password</td><td class="align_left"><code>true &amp;&amp; false == false</code></td></tr><tr><td class="align_left">valid user</td><td class="align_left">right password</td><td class="align_left"><code>true &amp;&amp; true == true</code></td></tr></tbody></table></div><div class="caption"><span class="header">Table 8.2: </span><span class="description">Possible results of <code>user &amp;&amp; user.authenticate(…)</code>.</span></div></div>




<div class="label" id="sec-rendering_with_a_flash_message"></div>


<h3><a id="sec-8_1_5" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-rendering_with_a_flash_message" class="heading"><span class="number">8.1.5</span> Rendering with a flash message</a></h3>


<p>Recall from <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#sec-signup_error_messages">Section&nbsp;7.3.2</a> that we displayed signup errors using the User model error messages. These errors are associated with a particular Active Record object, but this strategy won’t work here because the session isn’t an Active Record model. Instead, we’ll put a message in the flash to be displayed upon failed signin. A first, slightly incorrect, attempt appears in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-failed_signin_attempt">Listing&nbsp;8.10</a>.</p>

<div class="label" id="code-failed_signin_attempt"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.10.</span> <span class="description">An (unsuccessful) attempt at handling failed signin. <br> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="c1"># Sign the user in and redirect to the user's show page.</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span> <span class="c1"># Not quite right!</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Because of the flash message display in the site layout (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#code-layout_flash">Listing&nbsp;7.26</a>), the <code>flash[:error]</code> message automatically gets displayed; because of the Bootstrap CSS, it automatically gets nice styling (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fig-failed_signin_flash">Figure&nbsp;8.6</a>).</p>

<div class="label" id="fig-failed_signin_flash"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/failed_signin_flash_bootstrap.png" alt="failed_signin_flash_bootstrap"></span></div><div class="caption"><span class="header">Figure 8.6: </span><span class="description">The flash message for a failed signin.&nbsp;<a href="http://railstutorial.org/images/figures/failed_signin_flash_bootstrap-full.png">(full size)</a></span></div></div>


<p>Unfortunately, as noted in the text and in the comment in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-failed_signin_attempt">Listing&nbsp;8.10</a>, this code isn’t quite right. The page looks fine, though, so what’s the problem? The issue is that the contents of the flash persist for one <em>request</em>, but—unlike a redirect, which we used in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#code-signup_flash">Listing&nbsp;7.27</a>—re-rendering a template with <code>render</code> doesn’t count as a request. The result is that the flash message persists one request longer than we want. For example, if we submit invalid information, the flash is set and gets displayed on the signin page (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fig-failed_signin_flash">Figure&nbsp;8.6</a>); if we then click on another page, such as the Home page, that’s the first request since the form submission, and the flash gets displayed again (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fig-flash_persistence">Figure&nbsp;8.7</a>).</p>

<div class="label" id="fig-flash_persistence"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/flash_persistence_bootstrap.png" alt="flash_persistence_bootstrap"></span></div><div class="caption"><span class="header">Figure 8.7: </span><span class="description">An example of the flash persisting.&nbsp;<a href="http://railstutorial.org/images/figures/flash_persistence_bootstrap-full.png">(full size)</a></span></div></div>


<p>This flash persistence is a bug in our application, and before proceeding with a fix it is a good idea to write a test catching the error. In particular, the signin failure tests are currently passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">"signin with invalid information"</span>
</pre></div>
</div>


<p>But the tests should never pass when there is a known bug, so we should add a failing test to catch it. Fortunately, dealing with a problem like flash persistence is one of many areas where integration tests really shine; they let us say exactly what we mean:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">"after visiting another page"</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">"Home"</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>After submitting invalid signin data, this test follows the Home link in the site layout and then requires that the flash error message not appear. The updated code, with the modified flash test, is shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-correct_signin_failure_test">Listing&nbsp;8.11</a>.</p>

<div class="label" id="code-correct_signin_failure_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.11.</span> <span class="description">Correct tests for signin failure. <br> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"signin"</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"with invalid information"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Sign in"</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">'Invalid'</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">"after visiting another page"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">"Home"</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The new test fails, as required:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">"signin with invalid information"</span>
</pre></div>
</div>


<p>To get the failing test to pass, instead of <code>flash</code> we use <code>flash.now</code>, which is specifically designed for displaying flash messages on rendered pages; unlike the contents of <code>flash</code>, its contents disappear as soon as there is an additional request. The corrected application code appears in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-correct_signin_failure">Listing&nbsp;8.12</a>.</p>

<div class="label" id="code-correct_signin_failure"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.12.</span> <span class="description">Correct code for failed signin. <br> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="c1"># Sign the user in and redirect to the user's show page.</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Now the test suite for users with invalid information should be green:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">"with invalid information"</span>
</pre></div>
</div>




<div class="label" id="sec-signin_success"></div>


<h2><a id="sec-8_2" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_success" class="heading"><span class="number">8.2</span> Signin success</a></h2>


<p>Having handled a failed signin, we now need to actually sign a user in. Getting there will require some of the most challenging Ruby programming so far in this tutorial, so hang in there through the end and be prepared for a little heavy lifting. Happily, the first step is easy—completing the Sessions controller <code>create</code> action is a snap. Unfortunately, it’s also a cheat.</p>

<p>Filling in the area now occupied by the signin comment (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-correct_signin_failure">Listing&nbsp;8.12</a>) is simple: upon successful signin, we sign the user in using the <code>sign_in</code> function, and then redirect to the profile page (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-sign_in_success_not_yet_working">Listing&nbsp;8.13</a>). We see now why this is a cheat: alas, <code>sign_in</code> doesn’t currently exist. Writing it will occupy the rest of this section.</p>

<div class="label" id="code-sign_in_success_not_yet_working"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.13.</span> <span class="description">The completed Sessions controller <code>create</code> action (not yet working). <br> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-remember_me"></div>


<h3><a id="sec-8_2_1" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-remember_me" class="heading"><span class="number">8.2.1</span> Remember me</a></h3>


<p>We’re now in a position to start implementing our signin model, namely, remembering user signin status “forever” and clearing the session only when the user explicitly signs out. The signin functions themselves will end up crossing the traditional Model-View-Controller lines; in particular, several signin functions will need to be available in both controllers and views. You may recall from <a class="ref" href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-back_to_the_title_helper">Section&nbsp;4.2.5</a> that Ruby provides a <em>module</em> facility for packaging functions together and including them in multiple places, and that’s the plan for the authentication functions. We could make an entirely new module for authentication, but the Sessions controller already comes equipped with a module, namely, <code>SessionsHelper</code>. Moreover, such helpers are automatically included in Rails views, so all we need to do to use the Sessions helper functions in controllers is to include the module into the Application controller (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-sessions_helper_include">Listing&nbsp;8.14</a>). (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-sessions_helper_include">Listing&nbsp;8.14</a> also takes the opportunity to add an additional cross-site request forgery safeguard. It will start working once we define the <code>sign_out</code> method in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signing_out">Section&nbsp;8.2.6</a>.)</p>

<div class="label" id="code-sessions_helper_include"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.14.</span> <span class="description">Including the Sessions helper module into the Application controller. <br> <code>app/controllers/application_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="ss">ActionController::Base</span>
  <span class="n">protect_from_forgery</span>
  <span class="kp">include</span> <span class="no">SessionsHelper</span>

  <span class="c1"># Force signout to prevent CSRF attacks</span>
  <span class="k">def</span> <span class="nf">handle_unverified_request</span>
    <span class="n">sign_out</span>
    <span class="k">super</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>By default, all the helpers are available in the views but not in the controllers. We need the methods from the Sessions helper in both places, so we have to include it explicitly.</p>

<p>Because HTTP is a <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#HTTP_session_state"><em>stateless protocol</em></a>, web applications requiring user signin must implement a way to track each user’s progress from page to page. One technique for maintaining the user signin status is to use a traditional Rails session (via the special <code>session</code> function) to store a <em>remember token</em> equal to the user’s id:</p>

<div class="code"><div class="highlight"><pre><span class="n">session</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</pre></div>
</div>


<p>This <code>session</code> object makes the user id available from page to page by storing it in a cookie that expires upon browser close. On each page, the application could simply call</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>to retrieve the user. Because of the way Rails handles sessions, this process is secure; if a malicious user tries to spoof the user id, Rails will detect a mismatch based on a special <em>session id</em> generated for each session.</p>

<p>For our application’s design choice, which involves <em>persistent</em> sessions—that is, signin status that lasts even after browser close—we need to use a <em>permanent</em> identifier for the signed-in user. To accomplish this, we’ll generate a unique, secure remember token for each user and store it as a <em>permanent</em> cookie rather than one that expires on browser close.</p>

<p>The remember token needs to be associated with a user and stored for future use, so we’ll add it as an attribute to the User model, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fig-user_model_remember_token">Figure&nbsp;8.8</a>.</p>

<div class="label" id="fig-user_model_remember_token"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/user_model_remember_token_31.png" alt="user_model_remember_token_31"></span></div><div class="caption"><span class="header">Figure 8.8: </span><span class="description">The User model with an added <code>remember_token</code> attribute.</span></div></div>


<p>We’ll start with a small addition to the User model specs (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-user_responds_to_remember_token">Listing&nbsp;8.15</a>).</p>

<div class="label" id="code-user_responds_to_remember_token"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.15.</span> <span class="description">A first test for the remember token. <br> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_confirmation</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>  
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>We can get this test to pass by generating a remember token at the command line:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_remember_token_to_users
</pre></div>
</div>


<p>Next we fill in the resulting migration with the code from <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-add_remember_token_to_users">Listing&nbsp;8.16</a>. Note that, because we expect to retrieve users by remember token, we’ve added an index (<a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-users#sidebar-database_indices">Box&nbsp;6.2</a>) to the <code>remember_token</code> column.</p>

<div class="label" id="code-add_remember_token_to_users"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.16.</span> <span class="description">A migration to add a <code>remember_token</code> to the <code>users</code> table. <br> <code>db/migrate/[timestamp]_add_remember_token_to_users.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddRememberTokenToUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:remember_token</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">add_index</span>  <span class="ss">:users</span><span class="p">,</span> <span class="ss">:remember_token</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Next we update the development and test databases as usual:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>At this point the User model specs should be passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
</pre></div>
</div>


<p>Now we have to decide what to use as a remember token. There are many mostly equivalent possibilities—essentially, any large random string will do just fine. In principle, since the user passwords are securely encrypted, we could use each user’s <code>password_hash</code> attribute, but it seems like a terrible idea to unnecessarily expose our users’ passwords to potential attackers. We’ll err on the side of caution and make a custom remember token using the <code>urlsafe_base64</code> method from the <code>SecureRandom</code> module in the Ruby standard library, which creates a <a href="http://en.wikipedia.org/wiki/Base64">Base64</a> string safe for use in URIs (and hence safe for use in cookies as well).<sup class="footnote" id="fnref-8_3"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fn-8_3">3</a></sup> As of this writing, <code>SecureRandom.urlsafe_base64</code> returns a random string of length 16 composed of the characters A–Z, a–z, 0–9, “-”, and “_” (for a total of 64 possibilities). This means that the probability of two remember tokens being the same is <span class="MathJax_Preview"></span><span class="MathJax" id="MathJax-Element-1-Frame" role="textbox" aria-readonly="true" style=""><nobr><span class="math" id="MathJax-Span-1"><span style="display: inline-block; position: relative; width: 163px; height: 0px; font-size: 106%;"><span style="position: absolute; clip: rect(30px 17172px 55.3px -7.6px); top: -48px; left: 0px;"><span class="mrow" id="MathJax-Span-2"><span class="mn" id="MathJax-Span-3" style="font-family: MathJax_Main;">1</span><span class="texatom" id="MathJax-Span-4"><span class="mrow" id="MathJax-Span-5"><span class="mo" id="MathJax-Span-6" style="font-family: MathJax_Main;">/</span></span></span><span class="msubsup" id="MathJax-Span-7"><span style="display: inline-block; position: relative; width: 31.3px; height: 0px;"><span style="position: absolute; clip: rect(33.4px 17172px 51.4px -8.3px); top: -48px; left: 0px;"><span class="mn" id="MathJax-Span-8" style="font-family: MathJax_Main;">64</span><span style="display: inline-block; width: 0px; height: 48px;"></span></span><span style="position: absolute; top: -46.9px; left: 18px;"><span class="texatom" id="MathJax-Span-9"><span class="mrow" id="MathJax-Span-10"><span class="mn" id="MathJax-Span-11" style="font-size: 70.7%; font-family: MathJax_Main;">16</span></span></span><span style="display: inline-block; width: 0px; height: 40px;"></span></span></span></span><span class="mo" id="MathJax-Span-12" style="font-family: MathJax_Main; padding-left: 4.8px;">=</span><span class="msubsup" id="MathJax-Span-13" style="padding-left: 4.8px;"><span style="display: inline-block; position: relative; width: 31.3px; height: 0px;"><span style="position: absolute; clip: rect(33.6px 17172px 51px -8.1px); top: -48px; left: 0px;"><span class="mn" id="MathJax-Span-14" style="font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 48px;"></span></span><span style="position: absolute; top: -46.7px; left: 9px;"><span class="texatom" id="MathJax-Span-15"><span class="mrow" id="MathJax-Span-16"><span class="mo" id="MathJax-Span-17" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-18" style="font-size: 70.7%; font-family: MathJax_Main;">96</span></span></span><span style="display: inline-block; width: 0px; height: 40px;"></span></span></span></span><span class="mo" id="MathJax-Span-19" style="font-family: MathJax_Main; padding-left: 4.8px;">≈</span><span class="msubsup" id="MathJax-Span-20" style="padding-left: 4.8px;"><span style="display: inline-block; position: relative; width: 40.3px; height: 0px;"><span style="position: absolute; clip: rect(33.6px 17172px 51.4px -7.6px); top: -48px; left: 0px;"><span class="mn" id="MathJax-Span-21" style="font-family: MathJax_Main;">10</span><span style="display: inline-block; width: 0px; height: 48px;"></span></span><span style="position: absolute; top: -46.7px; left: 18px;"><span class="texatom" id="MathJax-Span-22"><span class="mrow" id="MathJax-Span-23"><span class="mo" id="MathJax-Span-24" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-25" style="font-size: 70.7%; font-family: MathJax_Main;">29</span></span></span><span style="display: inline-block; width: 0px; height: 40px;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 48px;"></span></span></span><span style="border-left-width: 0px; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 21.3px; vertical-align: -5.3px;"></span></span></nobr></span><script type="math/tex" id="MathJax-Element-1">1/64^{16} = 2^{-96} \approx 10^{-29}</script>, which is negligible.</p>

<p>We’ll create a remember token using a <em>callback</em>, a technique introduced in <a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-users#sec-uniqueness_validation">Section&nbsp;6.2.5</a> in the context of email uniqueness. As in that section, we’ll use a <code>before_save</code> callback, this time to create the attribute <code>remember_token</code> just before the user is saved. A second option would be to use a <code>before_create</code> callback<sup class="footnote" id="fnref-8_4"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fn-8_4">4</a></sup> to set the remember token <em>once</em>, when the user is first created. This would work fine, but it has the downside that any <a href="http://en.wikipedia.org/wiki/Session_hijacking">hijacked sessions</a> (which involves copying the remember token and using it to sign in as the corresponding user) would never expire. The <code>before_save</code> callback, in contrast, ensures that the token changes every time the user updates his information (<a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec-successful_edits">Section&nbsp;9.1.3</a>), so it’s slightly more secure. (Session hijacking was widely publicized by the <a href="http://codebutler.com/firesheep">Firesheep</a> application, which showed that remember tokens at many high-profile sites were visible when connected to public Wi-Fi networks. The solution is to use site-wide SSL, as described in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#sec-deploying_to_production_with_ssl">Section&nbsp;7.4.4</a>. Occasionally changing the remember token is still a security feature, though, since your remember token could still be obtained if the attacker has physical access to a computer where you are signed in.)</p>

<p>To test the remember token, we first save the test user and then check that the user’s <code>remember_token</code> attribute isn’t blank. This gives us sufficient flexibility to change the random string if we ever need to. The result appears in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-remember_token_should_not_be_blank">Listing&nbsp;8.17</a>.</p>

<div class="label" id="code-remember_token_should_not_be_blank"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.17.</span> <span class="description">A test for a valid (nonblank) remember token. <br> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">"user@example.com"</span><span class="p">,</span> 
                     <span class="ss">password:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">"foobar"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"remember token"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_blank</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-remember_token_should_not_be_blank">Listing&nbsp;8.17</a> introduces the <code>its</code> method, which is like <code>it</code> but applies the subsequent test to the given attribute rather than the subject of the test. In other words,</p>

<div class="code"><div class="highlight"><pre><span class="n">its</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_blank</span> <span class="p">}</span>
</pre></div>
</div>


<p>is equivalent to</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">remember_token</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_blank</span> <span class="p">}</span>
</pre></div>
</div>


<p>The application code introduces several new elements. First, we add a callback method to create the remember token:</p>

<div class="code"><div class="highlight"><pre><span class="n">before_save</span> <span class="ss">:create_remember_token</span>
</pre></div>
</div>


<p>This arranges for Rails to look for a method called <code>create_remember_token</code> and run it before saving the user. Second, the method itself is only used internally by the User model, so there’s no need to expose it to outside users. The Ruby way to accomplish this is to use the <code>private</code> keyword:</p>

<div class="code"><div class="highlight"><pre><span class="kp">private</span>

  <span class="k">def</span> <span class="nf">create_remember_token</span>
    <span class="c1"># Create the token.</span>
  <span class="k">end</span>
</pre></div>
</div>


<p>All methods defined in a class after <code>private</code> are automatically hidden, so that</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">create_remember_token</span>
</pre></div>
</div>


<p>will raise a <code>NoMethodError</code> exception.</p>

<p>Finally, the <code>create_remember_token</code> method needs to <em>assign</em> to one of the user attributes, and in this context it is necessary to use the <code>self</code> keyword in front of <code>remember_token</code>:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">create_remember_token</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
<span class="k">end</span>
</pre></div>
</div>


<p>(<em>Note</em>: If you are using Ruby 1.8.7, you should use <code>SecureRandom.hex</code> here instead.) Because of the way Active Record synthesizes attributes based on database columns, without <code>self</code> the assignment would create a <em>local</em> variable called <code>remember_token</code>, which isn’t what we want at all. Using <code>self</code> ensures that assignment sets the user’s <code>remember_token</code> so that it will be written to the database along with the other attributes when the user is saved.</p>

<p>Putting this all together yields the User model shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-before_save_create_remember_token">Listing&nbsp;8.18</a>.</p>

<div class="label" id="code-before_save_create_remember_token"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.18.</span> <span class="description">A <code>before_save</code> callback to create <code>remember_token</code>. <br> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="n">has_secure_password</span>

  <span class="n">before_save</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">before_save</span> <span class="ss">:create_remember_token</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">create_remember_token</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>By the way, the extra level of indentation on <code>create_remember_token</code> is there to make it visually apparent which methods are defined after <code>private</code>.</p>

<p>Since the <code>SecureRandom.urlsafe_base64</code> string is definitely <em>not</em> blank, the tests for the User model should now be passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
</pre></div>
</div>


<div class="label" id="sec-a_working_sign_in_method"></div>


<h3><a id="sec-8_2_2" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-a_working_sign_in_method" class="heading"><span class="number">8.2.2</span> A working <tt>sign_in</tt> method</a></h3>


<p>Now we’re ready to write the first signin element, the <code>sign_in</code> function itself. As noted above, our desired authentication method is to place a remember token as a cookie on the user’s browser, and then use the token to find the user record in the database as the user moves from page to page (implemented in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-current_user">Section&nbsp;8.2.3</a>). The result, <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-sign_in_function">Listing&nbsp;8.19</a>, introduces two new ideas: the <code>cookies</code> hash and <code>current_user</code>.</p>

<div class="label" id="code-sign_in_function"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.19.</span> <span class="description">The complete (but not-yet-working) <code>sign_in</code> function. <br> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-sign_in_function">Listing&nbsp;8.19</a> introduces the <code>cookies</code> utility supplied by Rails. We can use <code>cookies</code> as if it were a hash; each element in the cookie is itself a hash of two elements, a <code>value</code> and an optional <code>expires</code> date. For example, we could implement user signin by placing a cookie with value equal to the user’s remember token that expires 20 years from now:</p>

<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">value:</span>   <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span><span class="p">,</span>
                             <span class="ss">expires:</span> <span class="mi">20</span><span class="o">.</span><span class="n">years</span><span class="o">.</span><span class="n">from_now</span><span class="o">.</span><span class="n">utc</span> <span class="p">}</span>
</pre></div>
</div>


<p>(This uses one of the convenient Rails time helpers, as discussed in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sidebar-time_helpers">Box&nbsp;8.1</a>.)</p>

<div class="label" id="sidebar-time_helpers"></div>


<div class="sidebar"><span class="title"><span class="header">Box 8.1.</span><span class="description">Cookies expire <tt>20.years.from_now</tt></span></span>
<p>You may recall from <a class="ref" href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-a_class_of_our_own">Section&nbsp;4.4.2</a> that Ruby lets you add methods to <em>any</em> class, even built-in ones. In that section, we added a <tt>palindrome?</tt> method to the <tt>String</tt> class (and discovered as a result that <tt>"deified"</tt> is a palindrome), and we also saw how Rails adds a <tt>blank?</tt> method to class <tt>Object</tt> (so that <tt>"".blank?</tt>, <tt>"&nbsp;".blank?</tt>, and <tt>nil.blank?</tt> are all <tt>true</tt>). The cookie code in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-sign_in_function">Listing&nbsp;8.19</a> (which internally sets a cookie that expires <tt>20.years.from_now</tt>) gives yet another example of this practice through one of Rails’ <em>time helpers</em>, which are methods added to <tt>Fixnum</tt> (the base class for numbers):</p>

<pre class="verbatim">  $ rails console
  &gt;&gt; 1.year.from_now
  =&gt; Sun, 13 Mar 2011 03:38:55 UTC +00:00
  &gt;&gt; 10.weeks.ago
  =&gt; Sat, 02 Jan 2010 03:39:14 UTC +00:00</pre>


<p>Rails adds other helpers, too:</p>

<pre class="verbatim">  &gt;&gt; 1.kilobyte
  =&gt; 1024
  &gt;&gt; 5.megabytes
  =&gt; 5242880</pre>


<p>These are useful for upload validations, making it easy to restrict, say, image uploads to <tt>5.megabytes</tt>.</p>

<p>Though it must be used with caution, the flexibility to add methods to built-in classes allows for extraordinarily natural additions to plain Ruby. Indeed, much of the elegance of Rails ultimately derives from the malleability of the underlying Ruby language.</p>
</div>


<p>This pattern of setting a cookie that expires 20 years in the future became so common that Rails added a special <code>permanent</code> method to implement it, so that we can simply write</p>

<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
</pre></div>
</div>


<p>Under the hood, using <code>permanent</code> causes Rails to set the expiration to <code>20.years.from_now</code> automatically.</p>

<p>After the cookie is set, on subsequent page views we can retrieve the user with code like</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find_by_remember_token</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>Of course, <code>cookies</code> isn’t <em>really</em> a hash, since assigning to <code>cookies</code> actually <em>saves</em> a piece of text on the browser, but part of the beauty of Rails is that it lets you forget about that detail and concentrate on writing the application.</p>

<div class="label" id="sec-current_user"></div>


<h3><a id="sec-8_2_3" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-current_user" class="heading"><span class="number">8.2.3</span> Current user</a></h3>


<p>Having discussed how to store the user’s remember token in a cookie for later use, we now need to learn how to retrieve the user on subsequent page views. Let’s look again at the <code>sign_in</code> function to see where we are:</p>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Our focus now is the second line:</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
</pre></div>
</div>


<p>The purpose of this line is to create <code>current_user</code>, accessible in both controllers and views, which will allow constructions such as</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>and</p>

<div class="code"><div class="highlight"><pre><span class="n">redirect_to</span> <span class="n">current_user</span>
</pre></div>
</div>


<p>The use of <code>self</code> is necessary in this context for the same essential reason noted in the discussion leading up to <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-before_save_create_remember_token">Listing&nbsp;8.18</a>: without <code>self</code>, Ruby would simply create a local variable called <code>current_user</code>.</p>

<p>To start writing the code for <code>current_user</code>, note that the line</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
</pre></div>
</div>


<p>is an <em>assignment</em>, which we must define. Ruby has a special syntax for defining such an assignment function, shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-current_user_equals">Listing&nbsp;8.20</a>.</p>

<div class="label" id="code-current_user_equals"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.20.</span> <span class="description">Defining assignment to <code>current_user</code>. <br> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This might look confusing—most languages don’t let you use the equals sign in a method definition—but it simply defines a method <code>current_user=</code> expressly designed to handle assignment to <code>current_user</code>. In other words, the code</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</pre></div>
</div>


<p>is automatically converted to</p>

<div class="code"><div class="highlight"><pre><span class="n">current_user</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>


<p>thereby invoking the <code>current_user=</code> method. Its one argument is the right-hand side of the assignment, in this case the user to be signed in. The one-line method body just sets an instance variable <code>@current_user</code>, effectively storing the user for later use.</p>

<p>In ordinary Ruby, we could define a second method, <code>current_user</code>, designed to return the value of <code>@current_user</code>, as shown in  <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-current_user_wrong">Listing&nbsp;8.21</a>.</p>

<div class="label" id="code-current_user_wrong"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.21.</span> <span class="description">A tempting but useless definition for <code>current_user</code>.</span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span>     <span class="c1"># Useless! Don't use this line.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>If we did this, we would effectively replicate the functionality of <code>attr_accessor</code>, which we saw in <a class="ref" href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-a_user_class">Section&nbsp;4.4.5</a>.<sup class="footnote" id="fnref-8_5"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fn-8_5">5</a></sup> The problem is that it utterly fails to solve our problem: with the code in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-current_user_wrong">Listing&nbsp;8.21</a>, the user’s signin status would be forgotten: as soon as the user went to another page—<em>poof!</em>—the session would end and the user would be automatically signed out.
To avoid this problem, we can find the user corresponding to the remember token created by the code in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-sign_in_function">Listing&nbsp;8.19</a>, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-current_user_working">Listing&nbsp;8.22</a>.</p>

<div class="label" id="code-current_user_working"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.22.</span> <span class="description">Finding the current user using the <code>remember_token</code>. <br> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">current_user</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_remember_token</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-current_user_working">Listing&nbsp;8.22</a> uses the common but initially obscure <code>||=</code> (“or equals”) assignment operator (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sidebar-or_equals">Box&nbsp;8.2</a>). Its effect is to set the <code>@current_user</code> instance variable to the user corresponding to the remember token, but only if <code>@current_user</code> is undefined.<sup class="footnote" id="fnref-8_6"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fn-8_6">6</a></sup> In other words, the construction</p>

<div class="code"><div class="highlight"><pre><span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_remember_token</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>calls the <code>find_by_remember_token</code> method the first time <code>current_user</code> is called, but on subsequent invocations returns <code>@current_user</code> without hitting the database.<sup class="footnote" id="fnref-8_7"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fn-8_7">7</a></sup> This is only useful if <code>current_user</code> is used more than once for a single user request; in any case, <code>find_by_remember_token</code> will be called at least once every time a user visits a page on the site.</p>

<div class="label" id="sidebar-or_equals"></div>


<div class="sidebar"><span class="title"><span class="header">Box 8.2.</span><span class="description">What the *$@! is <tt>||=</tt> ? </span></span>
<p>The <tt>||=</tt> construction is very Rubyish—that is, it is highly characteristic of the Ruby language—and hence important to learn if you plan on doing much Ruby programming. Though at first it may seem mysterious, <em>or equals</em> is easy to understand by analogy.</p>

<p>We start by noting a common idiom for changing a currently defined variable. Many computer programs involve incrementing a variable, as in</p>

<pre class="verbatim">  x = x + 1</pre>


<p>Most languages provide a syntactic shortcut for this operation; in Ruby (and in C, C++, Perl, Python, Java, etc.), it appears as follows:</p>

<pre class="verbatim">  x += 1</pre>


<p>Analogous constructs exist for other operators as well:</p>

<pre class="verbatim">  $ rails console
  &gt;&gt; x = 1
  =&gt; 1
  &gt;&gt; x += 1
  =&gt; 2
  &gt;&gt; x *= 3
  =&gt; 6
  &gt;&gt; x -= 7
  =&gt; -1</pre>


<p>In each case, the pattern is that <tt>x = x O y</tt> and <tt>x O= y</tt> are equivalent for any operator <tt>O</tt>.</p>

<p>Another common Ruby pattern is assigning to a variable if it’s <tt>nil</tt> but otherwise leaving it alone. Recalling the <em>or</em>&nbsp;operator <tt>||</tt> seen in <a class="ref" href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec-objects_and_message_passing">Section&nbsp;4.2.3</a>, we can write this as follows:</p>

<pre class="verbatim">  &gt;&gt; @user
  =&gt; nil
  &gt;&gt; @user = @user || "the user"
  =&gt; "the user"
  &gt;&gt; @user = @user || "another user"
  =&gt; "the user"</pre>


<p>Since <tt>nil</tt> is false in a boolean context, the first assignment is <tt>nil || "the user"</tt>, which evaluates to <tt>"the user"</tt>; similarly, the second assignment is <tt>"the user" || "another user"</tt>, which also evaluates to <tt>"the user"</tt>—since strings are <tt>true</tt> in a boolean context, the series of <tt>||</tt> expressions terminates after the first expression is evaluated. (This practice of evaluating <tt>||</tt> expressions from left to right and stopping on the first true value is known as <em>short-circuit evaluation</em>.)</p>

<p>Comparing the console sessions for the various operators, we see that <tt>@user = @user || value</tt> follows the <tt>x = x O y</tt> pattern with <tt>||</tt> in the place of <tt>O</tt>, which suggests the following equivalent construction:</p>

<pre class="verbatim">  &gt;&gt; @user ||= "the user"
  =&gt; "the user"</pre>


<p>Voilà&nbsp;!</p>
</div>




<div class="label" id="sec-changing_the_layout_links"></div>


<h3><a id="sec-8_2_4" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-changing_the_layout_links" class="heading"><span class="number">8.2.4</span> Changing the layout links</a></h3>


<p>We come finally to a practical application of all our signin/out work: we’ll change the layout links based on signin status. In particular, as seen in the <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fig-signin_success_mockup">Figure&nbsp;8.3</a> mockup, we’ll arrange for the links to change when users sign in or sign out, and we’ll also add links for listing all users and user settings (to be completed in <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#top">Chapter&nbsp;9</a>) and one for the current user’s profile page. In doing so, we’ll get the tests in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-signin_success_tests">Listing&nbsp;8.6</a> to pass, which means our test suite will be green for the first time since the beginning of the chapter.</p>

<p>The way to change the links in the site layout involves using an
if-else branching structure inside of Embedded Ruby:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  # Links for signed-in users
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  # Links for non-signed-in-users
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>This kind of code requires the existence of a <code>signed_in?</code> boolean, which we’ll now define.</p>

<p>A user is signed in if there is a current user in the session, i.e., if <code>current_user</code> is non-<code>nil</code>. This requires the use of the “not” operator, written using an exclamation point&nbsp;<code>!</code> and usually read as “bang”. In the present context, a user is signed in if <code>current_user</code> is <em>not</em> <code>nil</code>, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-signed_in_p">Listing&nbsp;8.23</a>.</p>

<div class="label" id="code-signed_in_p"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.23.</span> <span class="description">The <code>signed_in?</code> helper method. <br> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">signed_in?</span>
    <span class="o">!</span><span class="n">current_user</span><span class="o">.</span><span class="n">nil?</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>With the <code>signed_in?</code> method in hand, we’re ready to finish the layout links. There are four new links, two of which are stubbed out (to be completed in <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#top">Chapter&nbsp;9</a>):</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Users"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>The signout link, meanwhile, uses the signout path defined in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-sessions_resource">Listing&nbsp;8.2</a>:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign out"</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">"delete"</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>(Notice that the signout link passes a hash argument indicating that it should submit with an HTTP <tt>DELETE</tt> request.<sup class="footnote" id="fnref-8_8"><a href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fn-8_8">8</a></sup>) Finally, we’ll add a profile link as follows:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>Here we could write</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>but Rails allows us to link directly to the user, in this context automatically converting <code>current_user</code> into <code>user_path(current_user)</code>.</p>

<p>In the process of putting the new links into the layout, we’ll take advantage of Bootstrap’s ability to make dropdown menus, which you can read more about on the <a href="http://twitter.github.com/bootstrap/components.html">Bootstrap components page</a>. The full result appears in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-layout_signin_signout_links">Listing&nbsp;8.24</a>. Note in particular the CSS&nbsp;ids and classes related to the Bootstrap dropdown menu.</p>

<div class="label" id="code-layout_signin_signout_links"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.24.</span> <span class="description">Changing the layout links for signed-in users. <br> <code>app/views/layouts/_header.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-fixed-top navbar-inverse"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-inner"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"sample app"</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">"logo"</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav pull-right"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Home"</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Help"</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Users"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">"fat-menu"</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
                Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/b&gt;</span>
              <span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"divider"</span><span class="nt">&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign out"</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">"delete"</span> <span class="cp">%&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign in"</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div></div>


<p>The dropdown menu requires the use of Bootstrap’s JavaScript library, which we can include using the Rails asset pipeline by editing the application JavaScript file, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-bootstrap_js">Listing&nbsp;8.25</a>.</p>

<div class="label" id="code-bootstrap_js"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.25.</span> <span class="description">Adding the Bootstrap JavaScript library to <code>application.js</code>. <br> <code>app/assets/javascripts/application.js</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="c1">//= require jquery</span>
<span class="c1">//= require jquery_ujs</span>
<span class="c1">//= require bootstrap</span>
<span class="c1">//= require_tree .</span>
</pre></div>
</div></div>


<p>This uses the Sprockets library to include the Bootstrap JavaScript, which in turn is available thanks to the <tt>bootstrap-sass</tt> gem from <a class="ref" href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-custom_css">Section&nbsp;5.1.2</a>.</p>

<p>With the code in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-layout_signin_signout_links">Listing&nbsp;8.24</a>, all the tests should be passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>Unfortunately, if you actually examine the application in the browser, you’ll see that it doesn’t yet work. This is because the “remember me” functionality requires the user to have a remember token, but the current user doesn’t have one: we created the first user back in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#sec-the_first_signup">Section&nbsp;7.4.3</a>, long before implementing the callback that sets the remember token. To fix this, we need to save each user to invoke the <code>before_save</code> callback defined in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-before_save_create_remember_token">Listing&nbsp;8.18</a>, which creates a remember token as a side-effect:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">remember_token</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="ss">validate:</span> <span class="kp">false</span><span class="p">)</span> <span class="p">}</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">remember_token</span>
<span class="go">=&gt; "Im9P0kWtZvD0RdyiK9UHtg"</span>
</pre></div>
</div>


<p>Here we’ve iterated over all the users in case you added more than one while playing with the signup form. Note that we’ve passed an option to the <code>save</code> method; as currently written, <code>save</code> by itself wouldn’t work because we haven’t included the password or its confirmation. Indeed, for a real site we wouldn’t even know any of the passwords, but we would still want to be able to save the users. The solution is to pass <code>validate: false</code> to tell Active Record skip the validations (<a href="http://api.rubyonrails.org/v3.2.0/classes/ActiveRecord/Persistence.html#method-i-save">Rails API <tt>save</tt></a>).</p>

<p>With that change, a signed-in user now sees the new links and dropdown menu defined by <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-layout_signin_signout_links">Listing&nbsp;8.24</a>, as shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fig-profile_with_signout_link">Figure&nbsp;8.9</a>.</p>

<div class="label" id="fig-profile_with_signout_link"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/profile_with_signout_link_bootstrap.png" alt="profile_with_signout_link_bootstrap"></span></div><div class="caption"><span class="header">Figure 8.9: </span><span class="description">A signed-in user with new links and a dropdown menu.&nbsp;<a href="http://railstutorial.org/images/figures/profile_with_signout_link_bootstrap-full.png">(full size)</a></span></div></div>


<p>At this point, you should verify that you can sign in, close the browser, and then still be signed in when you visit the sample application. If you want, you can even inspect the browser cookies to see the result directly (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fig-cookie_in_browser">Figure&nbsp;8.10</a>).</p>

<div class="label" id="fig-cookie_in_browser"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/cookie_in_browser.png" alt="cookie_in_browser"></span></div><div class="caption"><span class="header">Figure 8.10: </span><span class="description">The remember token cookie in the local browser.&nbsp;<a href="http://railstutorial.org/images/figures/cookie_in_browser-full.png">(full size)</a></span></div></div>




<div class="label" id="sec-signin_upon_signup"></div>


<h3><a id="sec-8_2_5" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_upon_signup" class="heading"><span class="number">8.2.5</span> Signin upon signup</a></h3>


<p>In principle, although we are now done with authentication, newly registered users might be confused, as they are not signed in by default. Implementing this is the last bit of polish before letting users sign out. We’ll start by adding a line to the authentication tests (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-sign_up_sign_in">Listing&nbsp;8.26</a>). This includes the “after saving the user” <code>describe</code> block from <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#code-after_save_tests">Listing&nbsp;7.32</a> (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#sec-signup_exercises">Section&nbsp;7.6</a>), which you should add to the test now if you didn’t already do the corresponding exercise.</p>

<div class="label" id="code-sign_up_sign_in"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.26.</span> <span class="description">Testing that newly signed-up users are also signed in. <br> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">"after saving the user"</span> <span class="k">do</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign out'</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here we’ve tested the appearance of the signout link to verify that the user was successfully signed in after signing up.</p>

<p>With the <code>sign_in</code> method from <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_success">Section&nbsp;8.2</a>, getting this test to pass by actually signing in the user is easy: just add <code>sign_in @user</code> right after saving the user to the database (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-signin_upon_signup">Listing&nbsp;8.27</a>).</p>

<div class="label" id="code-signin_upon_signup"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.27.</span> <span class="description">Signing in the user upon signup. <br> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">sign_in</span> <span class="vi">@user</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Welcome to the Sample App!"</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-signing_out"></div>


<h3><a id="sec-8_2_6" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signing_out" class="heading"><span class="number">8.2.6</span> Signing out</a></h3>


<p>As discussed in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-signin_failure">Section&nbsp;8.1</a>, our authentication model is to keep users signed in until they sign out explicitly. In this section, we’ll add this necessary signout capability.</p>

<p>So far, the Sessions controller actions have followed the RESTful convention of using <code>new</code> for a signin page and <code>create</code> to complete the signin. We’ll continue this theme by using a <code>destroy</code> action to delete sessions, i.e., to sign out. To test this, we’ll click on the “Sign out” link and then look for the reappearance of the signin link (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-signout_test">Listing&nbsp;8.28</a>).</p>

<div class="label" id="code-signout_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.28.</span> <span class="description">A test for signing out a user. <br> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"signin"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">"followed by signout"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">"Sign out"</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As with user signin, which relied on the <code>sign_in</code> function, user signout just defers to a <code>sign_out</code> function (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-destroy_session">Listing&nbsp;8.29</a>).</p>

<div class="label" id="code-destroy_session"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.29.</span> <span class="description">Destroying a session (user signout). <br> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">sign_out</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As with the other authentication elements, we’ll put <code>sign_out</code> in the Sessions helper module. The implementation is simple: we set the current user to <code>nil</code> and use the <code>delete</code> method on cookies to remove the remember token from the session (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-sign_out_method">Listing&nbsp;8.30</a>). (Setting the current user to <code>nil</code> isn’t currently necessary because of the immediate redirect in the <code>destroy</code> action, but it’s a good idea in case we ever want to use <code>sign_out</code> without a redirect.)</p>

<div class="label" id="code-sign_out_method"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.30.</span> <span class="description">The <code>sign_out</code> method in the Sessions helper module. <br> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">sign_out</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This completes the signup/signin/signout triumvirate, and the test suite should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/ 
</pre></div>
</div>


<p>It’s worth noting that our test suite covers most of the authentication machinery, but not all of it. For instance, we don’t test how long the “remember me” cookie lasts or whether it gets set at all. It is possible to do so, but experience shows that direct tests of cookie values are brittle and have a tendency to rely on implementation details that sometimes change from one Rails release to the next. The result is breaking tests for application code that still works fine. By focusing on high-level functionality—verifying that users can sign in, stay signed in from page to page, and can sign out—we test the core application code without focusing on less important details.</p>

<div class="label" id="sec-cucumber"></div>


<h2><a id="sec-8_3" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-cucumber" class="heading"><span class="number">8.3</span> Introduction to Cucumber (optional)</a></h2>


<p>Having finished the foundation of the sample application’s authentication system, we’re going to take this opportunity to show how to write signin tests using <a href="http://cukes.info/">Cucumber</a>, a popular tool for behavior-driven development that enjoys significant popularity in the Ruby community. This section is optional and can be skipped without loss of continuity.</p>

<p>Cucumber allows the definition of plain-text <em>stories</em> describing application behavior. Many Rails programmers find Cucumber especially convenient when doing client work; since they can be read even by non-technical users, Cucumber tests can be shared with (and can sometimes even be written by) the client. Of course, using a testing framework that isn’t pure Ruby has a downside, and I find that the plain-text stories can be a bit verbose. Nevertheless, Cucumber does have a place in the Ruby testing toolkit, and I especially like its emphasis on high-level behavior over low-level implementation.</p>

<p>Since the emphasis in this book is on RSpec and Capybara, the presentation that follows is necessarily superficial and incomplete, and will be a bit light on explanation. Its purpose is just to give you a taste of Cucumber (crisp and juicy, no doubt)—if it strikes your fancy, there are entire books on the subject waiting to satisfy your appetite. (I particularly recommend <a href="http://www.amazon.com/gp/product/1934356379"><em>The RSpec Book</em></a> by David Chelimsky, <a href="http://www.amazon.com/gp/product/1935182277"><em>Rails 3 in Action</em></a> by Ryan Bigg and Yehuda Katz, and <a href="http://www.amazon.com/gp/product/1934356808"><em>The Cucumber Book</em></a> by Matt Wynne and Aslak Hellesøy.)</p>

<div class="label" id="sec-installation_and_setup"></div>


<h3><a id="sec-8_3_1" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-installation_and_setup" class="heading"><span class="number">8.3.1</span> Installation and setup</a></h3>


<p>To install Cucumber, first add the <tt>cucumber-rails</tt> gem and a utility gem called <tt>database_cleaner</tt> to the <code>:test</code> group in the <code>Gemfile</code> (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-cucumber_rails">Listing&nbsp;8.31</a>).</p>

<div class="label" id="code-cucumber_rails"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.31.</span> <span class="description">Adding the <tt>cucumber-rails</tt> gem to the <code>Gemfile.</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">gem</span> <span class="s1">'cucumber-rails'</span><span class="p">,</span> <span class="s1">'1.2.1'</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="kp">false</span>
  <span class="n">gem</span> <span class="s1">'database_cleaner'</span><span class="p">,</span> <span class="s1">'0.7.0'</span>
<span class="k">end</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>Then install as usual:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>To set up the application to use Cucumber, we next generate some necessary support files and directories:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate cucumber:install
</pre></div>
</div>


<p>This creates a <code>features/</code> directory where the files associated with Cucumber will live.</p>

<div class="label" id="sec-features_and_steps"></div>


<h3><a id="sec-8_3_2" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-features_and_steps" class="heading"><span class="number">8.3.2</span> Features and steps</a></h3>


<p>Cucumber features are descriptions of expected behavior using a plain-text  language called <a href="https://github.com/cucumber/gherkin">Gherkin</a>. Gherkin tests read much like well-written RSpec examples, but because they are plain-text they are more accessible to those more comfortable reading English than Ruby code.</p>

<p>Our Cucumber features will implement a subset of the signin examples in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-initial_failing_signin_test">Listing&nbsp;8.5</a> and <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-signin_success_tests">Listing&nbsp;8.6</a>. To get started, we’ll create a file in the <code>features/</code> directory called <code>signing_in.feature</code>.</p>

<p>Cucumber features start with a short description of the feature, as follows:</p>

<div class="code"><div class="highlight"><pre><span class="k">Feature:</span><span class="nf"> Signing in</span>
</pre></div>
</div>


<p>Then they add individual <em>scenarios</em>. For example, to test unsuccessful signin, we could write the following scenario:</p>

<div class="code"><div class="highlight"><pre><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Unsuccessful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">he submits invalid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">he should see an error message</span>
</pre></div>
</div>


<p>Similarly, to test successful signin, we could add this:</p>

<div class="code"><div class="highlight"><pre><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Successful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">the user has an account</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">the user submits valid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">he should see his profile page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">he should see a signout link</span>
</pre></div>
</div>


<p>Collecting these together yields the Cucumber feature file shown in  <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-signin_features">Listing&nbsp;8.32</a>.</p>

<div class="label" id="code-signin_features"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.32.</span> <span class="description">Cucumber features to test user signin. <br> <code>features/signing_in.feature</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">Feature:</span><span class="nf"> Signing in</span>
<span class="nf">  </span>
<span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Unsuccessful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">he submits invalid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">he should see an error message</span>
<span class="nf">  </span>
<span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Successful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">the user has an account</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">the user submits valid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">he should see his profile page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">he should see a signout link</span>
</pre></div>
</div></div>


<p>To run the features, we use the <code>cucumber</code> executable:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>cucumber features/
</pre></div>
</div>


<p>Compare this to</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>In this context, it’s worth noting that, like RSpec, Cucumber can be invoked using a Rake task:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake cucumber
</pre></div>
</div>


<p>(For reasons that escape me, this is sometimes written as <code>rake cucumber:ok</code>.)</p>

<p>All we’ve done so far is write some plain text, so it shouldn’t be surprising that the Cucumber scenarios aren’t yet passing. To get the test suite to green, we need to add a <em>step</em> file that maps the plain-text lines to Ruby code. The step file goes in the <code>features/step_definitions</code> directory; we’ll call it <code>authentication_steps.rb</code>.</p>

<p>The <code>Feature</code> and <code>Scenario</code> lines are mainly for documentation, but each of the other lines needs some corresponding Ruby. For example, the line</p>

<div class="code"><div class="highlight"><pre><span class="k">Given </span><span class="nf">a user visits the signin page</span>
</pre></div>
</div>


<p>in the feature file gets handled by the step definition</p>

<div class="code"><div class="highlight"><pre><span class="no">Given</span> <span class="sr">/^a user visits the signin page$/</span> <span class="k">do</span>
  <span class="n">visit</span> <span class="n">signin_path</span>
<span class="k">end</span>
</pre></div>
</div>


<p>In the feature, <code>Given</code> is just a string, but in the step file <code>Given</code> is a <em>method</em> that takes a regular expression and a block. The regex matches the text of the line in the scenario, and the contents of the block are the Ruby code needed to implement the step. In this case, “a user visits the signin page” is implemented by</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signin_path</span>
</pre></div>
</div>


<p>If this looks familiar, it should: it’s just Capybara, which is included by default in Cucumber step files. The next two lines should also look familiar; the scenario steps</p>

<div class="code"><div class="highlight"><pre><span class="k">When </span><span class="nf">he submits invalid signin information</span>
<span class="k">Then </span><span class="nf">he should see an error message</span>
</pre></div>
</div>


<p>in the feature file are handled by these steps:</p>

<div class="code"><div class="highlight"><pre><span class="no">When</span> <span class="sr">/^he submits invalid signin information$/</span> <span class="k">do</span>
  <span class="n">click_button</span> <span class="s2">"Sign in"</span>
<span class="k">end</span>

<span class="no">Then</span> <span class="sr">/^he should see an error message$/</span> <span class="k">do</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>The first step also uses Capybara, while the second uses Capybara’s <code>page</code> object with RSpec. Evidently, all the testing work we’ve done so far with RSpec and Capybara is also useful with Cucumber.</p>

<p>The rest of the steps proceed similarly. The final step definition file appears in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-authentication_steps">Listing&nbsp;8.33</a>. Try adding one step at a time, running</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>cucumber features/
</pre></div>
</div>


<p>each time until the tests pass.</p>

<div class="label" id="code-authentication_steps"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.33.</span> <span class="description">The complete steps needed to get the signin features to pass. <br> <code>features/step_definitions/authentication_steps.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="no">Given</span> <span class="sr">/^a user visits the signin page$/</span> <span class="k">do</span>
  <span class="n">visit</span> <span class="n">signin_path</span>
<span class="k">end</span>

<span class="no">When</span> <span class="sr">/^he submits invalid signin information$/</span> <span class="k">do</span>
  <span class="n">click_button</span> <span class="s2">"Sign in"</span>
<span class="k">end</span>

<span class="no">Then</span> <span class="sr">/^he should see an error message$/</span> <span class="k">do</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">Given</span> <span class="sr">/^the user has an account$/</span> <span class="k">do</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                      <span class="ss">password:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">"foobar"</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">When</span> <span class="sr">/^the user submits valid signin information$/</span> <span class="k">do</span>
  <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span>
  <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> 
  <span class="n">click_button</span> <span class="s2">"Sign in"</span>
<span class="k">end</span>

<span class="no">Then</span> <span class="sr">/^he should see his profile page$/</span> <span class="k">do</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="ss">text:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">Then</span> <span class="sr">/^he should see a signout link$/</span> <span class="k">do</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign out'</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>With the code in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-authentication_steps">Listing&nbsp;8.33</a>, the Cucumber tests should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>cucumber features/
</pre></div>
</div>




<div class="label" id="sec-rspec_custom_matchers"></div>


<h3><a id="sec-8_3_3" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-rspec_custom_matchers" class="heading"><span class="number">8.3.3</span> Counterpoint: RSpec custom matchers</a></h3>


<p>Having written some simple Cucumber scenarios, it’s worth comparing the result to the equivalent RSpec examples. First, take a look at the Cucumber feature in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-signin_features">Listing&nbsp;8.32</a> and the corresponding step definitions in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-authentication_steps">Listing&nbsp;8.33</a>. Then take a look at the RSpec request specs (integration tests):</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"signin"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"with invalid information"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Sign in"</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">'Invalid'</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
        <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">click_button</span> <span class="s2">"Sign in"</span>
      <span class="k">end</span> 

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'Sign out'</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>You can see how a case could be made for either Cucumber or integration tests. Cucumber features are easily readable, but they are entirely separate from the code that implements them—a property that cuts both ways. I find that Cucumber is easy to read and awkward to write, while integration tests are (for a programmer) a little harder to read and <em>much</em> easier to write.</p>

<p>One nice effect of Cucumber’s separation of concerns is that it operates at a higher level of abstraction. For example, we write</p>

<div class="code"><div class="highlight"><pre><span class="k">Then </span><span class="nf">he should see an error message</span>
</pre></div>
</div>


<p>to express the expectation of seeing an error message, and</p>

<div class="code"><div class="highlight"><pre><span class="no">Then</span> <span class="sr">/^he should see an error message$/</span> <span class="k">do</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">'Invalid'</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>to implement the test. What’s especially convenient about this is that only the second element (the step) is dependent on the implementation, so that if we change, e.g., the CSS class used for error messages, the feature file would stay the same.</p>

<p>In this vein, it might make you unhappy to write</p>

<div class="code"><div class="highlight"><pre><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">'Invalid'</span><span class="p">)</span>
</pre></div>
</div>


<p>in a bunch of places, when what you really want is to indicate that the page should have an error message. This practice couples the test tightly to the implementation, and we would have to change it everywhere if the implementation changed. In the context of pure RSpec, there is a solution, which is to use a <em>custom matcher</em>, allowing us to write the following instead:</p>

<div class="code"><div class="highlight"><pre><span class="n">should</span> <span class="n">have_error_message</span><span class="p">(</span><span class="s1">'Invalid'</span><span class="p">)</span>
</pre></div>
</div>


<p>We can define such a matcher in the same utilities file where we put the <code>full_title</code> test helper in <a class="ref" href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-pretty_rspec">Section&nbsp;5.3.4</a>. The code itself looks like this:</p>

<div class="code"><div class="highlight"><pre><span class="ss">RSpec::Matchers</span><span class="o">.</span><span class="n">define</span> <span class="ss">:have_error_message</span> <span class="k">do</span> <span class="o">|</span><span class="n">message</span><span class="o">|</span>
  <span class="n">match</span> <span class="k">do</span> <span class="o">|</span><span class="n">page</span><span class="o">|</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">message</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>We can also define helper functions for common operations:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">valid_signin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
  <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
  <span class="n">click_button</span> <span class="s2">"Sign in"</span>
<span class="k">end</span>
</pre></div>
</div>


<p>The resulting support code is shown in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-have_error_message">Listing&nbsp;8.34</a> (which incorporates the results of <a class="ref" href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#code-full_title_helper_tests">Listing&nbsp;5.37</a> and <a class="ref" href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#code-rspec_utilities_simplified">Listing&nbsp;5.38</a> from <a class="ref" href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#sec-layout_exercises">Section&nbsp;5.6</a>). I find this approach to be more flexible than Cucumber step definitions, particularly when the matchers or should helpers naturally take an argument, such as <code>valid_signin(user)</code>. Step definitions can replicate this functionality with regex matchers, but I generally find this approach to be more (cu)cumbersome.</p>

<div class="label" id="code-have_error_message"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.34.</span> <span class="description">Adding a helper method and a custom RSpec matcher. <br> <code>spec/support/utilities.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="kp">include</span> <span class="no">ApplicationHelper</span>

<span class="k">def</span> <span class="nf">valid_signin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
  <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
  <span class="n">click_button</span> <span class="s2">"Sign in"</span>
<span class="k">end</span>

<span class="ss">RSpec::Matchers</span><span class="o">.</span><span class="n">define</span> <span class="ss">:have_error_message</span> <span class="k">do</span> <span class="o">|</span><span class="n">message</span><span class="o">|</span>
  <span class="n">match</span> <span class="k">do</span> <span class="o">|</span><span class="n">page</span><span class="o">|</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">message</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>With the code in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code-have_error_message">Listing&nbsp;8.34</a>, we can write</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_error_message</span><span class="p">(</span><span class="s1">'Invalid'</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>and</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">valid_signin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
</pre></div>
</div>


<p>There are many other examples of coupling between our tests and the site’s implementation. Sweeping through the current test suite and decoupling the tests from the implementation details by making custom matchers and methods is left as an exercise (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-sign_in_out_exercises">Section&nbsp;8.5</a>).</p>

<h2><a id="sec-8_4" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-8_4" class="heading"><span class="number">8.4</span> Conclusion</a></h2>


<p>We’ve covered a lot of ground in this chapter, transforming our promising but unformed application into a site capable of the full suite of registration and login behaviors. All that is needed to complete the authentication functionality is to restrict access to pages based on signin status and user identity. We’ll accomplish this task en route to giving users the ability to edit their information and giving administrators the ability to remove users from the system, which are the main goals of <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#top">Chapter&nbsp;9</a>.</p>

<p>Before moving on, merge your changes back into the master branch:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">"Finish sign in"</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge sign-in-out
</pre></div>
</div>


<p>Then push up the remote GitHub repository and the Heroku production server:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
<span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku run rake db:migrate
</pre></div>
</div>


<p>If you’ve created any users on the production server, I recommend following the steps in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-changing_the_layout_links">Section&nbsp;8.2.4</a> to give each user a valid remember token. The only difference is using the Heroku console instead of the local one:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku run console
<span class="gp">&gt;</span>&gt; User.all.each <span class="o">{</span> |user| user.save<span class="o">(</span>validate: <span class="nb">false</span><span class="o">)</span> <span class="o">}</span>
</pre></div>
</div>


<div class="label" id="sec-sign_in_out_exercises"></div>


<h2><a id="sec-8_5" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-sign_in_out_exercises" class="heading"><span class="number">8.5</span> Exercises</a></h2>




<ol>

<li>Refactor the signin form to use <code>form_tag</code> in place of <code>form_for</code>. Make sure the test suite still passes. <em>Hint</em>: See the <a href="http://railscasts.com/episodes/270-authentication-in-rails-3-1">RailsCast on authentication in Rails&nbsp;3.1</a>, and note in particular the change in the structure of the <code>params</code> hash.</li>

<li>Following the example in <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec-rspec_custom_matchers">Section&nbsp;8.3.3</a>, go through the user and authentication request specs (i.e., the files currently in the <code>spec/requests</code> directory) and define utility functions in <code>spec/support/utilities.rb</code> to decouple the tests from the implementation. <em>Extra credit:</em> Organize the support code into separate files and modules, and get everything to work by including the modules properly in the spec helper file.</li>

</ol>




<div class="navigation">  <a class="prev_page" href="http://ruby.railstutorial.org/chapters/sign-up#top">
    «&nbsp;<span class="number">Chapter 7</span> Sign up
  </a>
  <a class="next_page" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#top">
    <span class="number">Chapter 9</span> Updating, showing, and deleting users&nbsp;»
  </a>
</div><div class="footnotes">
<ol>
<li id="fn-8_1">Another common model is to expire the session after a certain amount of time. This is especially appropriate on sites containing sensitive information, such as banking and financial trading accounts.&nbsp;<a class="arrow" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fnref-8_1">↑</a></li>
<li id="fn-8_2">Image from <a href="http://www.flickr.com/photos/hermanusbackpackers/3343254977/">http://www.flickr.com/photos/hermanusbackpackers/3343254977/</a>.&nbsp;<a class="arrow" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fnref-8_2">↑</a></li>
<li id="fn-8_3">This choice is based on the <a href="http://railscasts.com/episodes/274-remember-me-reset-password">RailsCast on remember me</a>.&nbsp;<a class="arrow" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fnref-8_3">↑</a></li>
<li id="fn-8_4">For more details on the kind of callbacks supported by Active Record, see the <a href="http://guides.rubyonrails.org/active_record_validations_callbacks.html#callbacks-overview">discussion of callbacks at the Rails Guides</a>.&nbsp;<a class="arrow" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fnref-8_4">↑</a></li>
<li id="fn-8_5">In fact, the two are exactly equivalent; <code>attr_accessor</code> is merely a convenient way to create just such getter/setter methods automatically.&nbsp;<a class="arrow" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fnref-8_5">↑</a></li>
<li id="fn-8_6">Typically, this means assigning to variables that are initially <code>nil</code>, but note that <code>false</code> values will also be overwritten by the <code>||=</code> operator.&nbsp;<a class="arrow" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fnref-8_6">↑</a></li>
<li id="fn-8_7">This is an example of <em>memoization</em>, which we discussed before in <a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-users#sidebar-let">Box&nbsp;6.3</a>.&nbsp;<a class="arrow" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fnref-8_7">↑</a></li>
<li id="fn-8_8">Web browsers can’t actually issue <tt>DELETE</tt> requests; Rails fakes it with JavaScript.&nbsp;<a class="arrow" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#fnref-8_8">↑</a></li>
</ol>
</div>





    </div>
  <div id="book_bottom">
  </div>
</div>
        
        </div>

    <div>Michael Hartl is a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for sites to earn advertising fees by advertising and linking to Amazon.com.</div>
 
    <div id="container-bottom"></div>
    
<div id="fb-root" class=" fb_reset"><script type="text/javascript" src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/all.js" async=""></script><div style="position: absolute; top: -10000px; height: 0px; width: 0px;"><div><iframe name="fb_xdm_frame_http" frameborder="0" allowtransparency="true" scrolling="no" id="fb_xdm_frame_http" aria-hidden="true" title="Facebook Cross Domain Communication Frame" tab-index="-1" style="border: none;" src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/xd_arbiter.html"></iframe><iframe name="fb_xdm_frame_https" frameborder="0" allowtransparency="true" scrolling="no" id="fb_xdm_frame_https" aria-hidden="true" title="Facebook Cross Domain Communication Frame" tab-index="-1" style="border: none;" src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/xd_arbiter(1).html"></iframe></div></div><div style="position: absolute; top: -10000px; height: 0px; width: 0px;"><div><iframe name="f20cacb68" frameborder="0" allowtransparency="true" scrolling="no" style="display: none;" src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/oauth.html"></iframe></div></div></div>
<script>
  window.fbAsyncInit = function() {
    FB.init({appId: '145973438749643', status: true, cookie: true,
             xfbml: true});
  };
  (function() {
    var e = document.createElement('script');
    e.type = 'text/javascript';
    e.src = document.location.protocol +
      '//connect.facebook.net/en_US/all.js';
    e.async = true;
    document.getElementById('fb-root').appendChild(e);
  }());
</script>

  
      <script type="text/javascript">
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
  </script><script src="./Learn Web Development with the Ruby on Rails Tutorial   Sign In Sign Out_files/ga.js" type="text/javascript"></script>
  <script type="text/javascript">
  try {
  var pageTracker = _gat._getTracker("UA-8667566-1");
  pageTracker._trackPageview();
  } catch(err) {}</script>

  
  
  </div>

</div><div id="MathJax_Font_Test" style="position: absolute; visibility: hidden; top: 0px; left: 0px; width: auto; padding: 0px; border: 0px; margin: 0px; white-space: nowrap; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; font-size: 40px; font-weight: normal; font-style: normal; font-family: MathJax_Main, sans-serif;"></div></body></html>